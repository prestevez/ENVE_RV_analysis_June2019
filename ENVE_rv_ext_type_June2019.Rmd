---
title: "Extortion concentration patterns: Analysis by type and event dependence, version 0.3"
author: "Patricio R. Estevez Soto"
email: "patricio.estevez.14@ucl.ac.uk"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  md_document:
    variant: "markdown"
pandoc_args: "--smart"
params:
    test:
        label: "Testing (for development)"
        value: TRUE
references:
- id: Estevez-Soto2019
  type: article-journal
  author:
  - family: Estévez-Soto
    given: Patricio R
  - family: Johnson
    given: Shane D
  - family: Tilley
    given: Nick
  issued:
  - year: '2018'
  title: Are repeatedly extorted businesses different? A multilevel hurdle model of extortion victimization
  container-title: Manuscript under review (Submitted Sep. 27, 2018)
- id: Estevez-Soto2019a
  type: article-journal
  author:
  - family: Estévez-Soto
    given: Patricio R
  issued:
  - year: '2019'
  title: Predictors of extortion compliance
  container-title: Manuscript in preparation (Version 1, March 18, 2019)
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment="",
                      cache=TRUE,
                      dev=c("png", "CairoPDF"),
                      error=TRUE,
                      fig.width=6, fig.height=5)
options(knitr.kable.NA = '--')
```

This script continues the analysis of the patterns of extortion concentration based on the findings from two previous studies. Using data form a commercial victimisation survey in Mexico, the first study [@Estevez-Soto2019] examined whether the predictors of extortion prevalence were the same as the predictors of extortion concentration using a multilevel negative binomial-logit hurdle model. The study found that the risk factors for extortion prevalence were not the same as those fuelling extortion concentration, possibly due to an unmeasured process of event dependence.

As the likelihood of repeat victimisation is thought to be influenced by how victims respond to a previous event, the second study [@Estevez-Soto2019a] examined the predictors of extortion compliance. Specifically, it sought to answer why most incidents of extortion in Mexico are not complied with. The main hypothesis was that the communication channel used to convey extortion threats was very important in determining compliance, as threats conveyed using lean media (remote extortion) would be less believable than those conveyed using rich media (in-person extortion). The findings suggested that compliance varied widely between remote and in-person extortion, which in turn suggested that extortion analyses should consider these types as different offence classes: the concentration patterns for remote and in-person extortion may be fuelled by different mechanisms.

Thus, this study aims to study the concentration patterns of remote and in-person extortion separately. It will first explore the predictors of incidence using count models (such as the Poisson and the negative binomial). Then it will test whether the predictors of prevalence are different from the predictors of concentration using the hurdle framework.

Furthermore, it will also aim to incorporate the temporal dimension to the analysis by creating a synthetic panel based on the month the incident was reported to have occurred. The temporal dimension will be used to calculate the time-course of repeat incidents (a histogram of the times between repetitions), as well as to model the probability of a future event, based on measurements from a previous period.

However, the precise modelling strategy still needs to be considered carefully. Crime incidence data using for the disaggregated extortion categories is capped at 7 incidents per victim. Thus, the most appropriate count models would need to account for this using right-censoring, and in the case of the hurdle framework, would need to account for at-zero-truncation and right censoring simultaneously.

Standard packages used to deal with multilevel count data (e.g. `glmmTMB`, `glmmADMB` and `lme4`) do not have truncated distributions (other than truncated-at-zero distributions for hurdle models). In contrast, the `GAMLSS` package allows specifying right-, left-, and interval-truncated count distributions for virtually any situation. However, the package does not allow multilevel specifications (i.e. random intercepts). There is a `gamlssNP` function that allows specifying random intercepts using Gaussian Mixtures, but I've discovered a critical bug in the software that inadvertently drops terms from the specified formula.

Previous iterations of this analysis suggest two things: one, the multilevel specification is important (as random intercepts were deemed to be significant to the models), and two, the benefits of using the 'correct' distribution using left-, and interval-truncation are negligible. Single-level models using the un-truncated distributional assumptions (and the truncated data) showed no substantive differences in effect sizes nor in statistical inference. Furthermore, the `gamlss` estimates appear to be far more unreliable than those using the standard packages.

Based on previous results, the following issues have to be addressed:

1) Businesses that are Utilities and Corporate should be excluded to ensure consistency with study 1.
2) Categorical independent variables should be revised so that the categories have sufficient observations for analysis, and so that they are somewhat consistent with previous studies.
3) There are no repeat cobro e piso incidents, so these should be excluded from the in-person category, or at least theere should be an additinal category without cobro de piso incidents.
4) Thus, cobro de piso incidents should be analysed using logit only.
5) There should be a post-hoc robustness check on the time-course, using only repeats that took place during the second semester. This way we can mitigate the effect of the time window. Also, fit a model to see if exponential or other (polynomial) smoother makes sense?
6) Fit models without log-transforming bribe incidence for comparison purposes (can still fit using log-bribes in "final" model)


However, before moving on to the new study, I still have to re-run the logistic models from the previous study [@Estevez-Soto2019a]. There are several corrections needed:

1) To maintain consistency with the estimates of study 1, observations regarding corporate and utility companies should be excluded (they represented too few observations).
2) The remaining business type categories used for the analysis should be defined based on the bivariate cross-tabulation with the dependent variable (ensuring that there are sufficient observations for the logistic model).
3) Thus, the analysis should at least present a short EDA using of the distribution of the DV and IVs, as the same idea applies to the rest of the variables.
4) Furthermore, number of offenders should also be revised (Use 4+, justify that that is the minimum number to ensure a healthy dose of 30+ obs in the yes/no compliance categories, though check the dist with full categories)
5) Though a previous iteration of the analysis suggested that there were no significant interactions between extortion type and extortion incidence, corruption incidence, and drug crimes, the ranges applicable to the variables should be revised, so that predicted probabilities reflect only plausible effects observed in real life.
6) Also, models using the in-person/remote distinction should be repeated, using two types of the in-person variable (including and excluding cobro de piso incidents, as these have no repetition).
7) A table with descriptive statistics should also be computed

Also, repeat main model from study 1, just to make sure all issues are resolved, including, EDA, poisson (truncated poisson) checks. Use glmmTMB and glmmADMB? Use mylog(bribes) instead of bribes for model from study 1, AIC and BIC is better. Compare to polynomial just in case.


The script proceeds as follows: In the next section I set-up the R workspace, load and install the necessary packages and set up other options. This is followed by data input and wrangling. Then the revisions to the compliance study [@Estevez-Soto2019a] are conducted, and this is followed by the analyses for this study.

# Set up

To ensure reproducibility and aid in debugging, we first start setting up options and printing the information about the R session.

```{r session, cache=FALSE}
starttime <- proc.time()
date()
sessionInfo()
set.seed(42)
options(scipen=0)

```

Next we load the packages that will be used in the analysis. The installation of these packages should have already been done before. Additionally, we'll import some functions that are required, without importing the entire packages.

```{r packages}
#library(victim)
library(tidyverse)
library(downloader)
library(sandwich)
library(lmtest)
library(magrittr)
library(glmmTMB)
library(gamlss)
#library(gamlss.cens)
#library(gamlss.mx)
library(gamlss.tr)
library(lazyeval)
library(glmmADMB)
step <- stats::step
#install.packages("arsenal")
library(arsenal)
library(texreg)
#install.packages("bbmle")
library(bbmle)
library(gridExtra)


read.dbf <- foreign::read.dbf
kable <- knitr::kable
melt <- reshape2::melt
select <- dplyr::select
Anova <- car::Anova

sessionInfo()

```

Next we load some custom functions. Ideally these should be in a separate stand-alone package, but I have not had the time to create such package.

```{r functions}

mylog <- function(x, center = FALSE){
    if(min(x) <= 0) {tlog <- log1p}
    else {tlog <- log}

    logx <- tlog(x)

    if(isTRUE(center))
    {
        logx <- logx - tlog(mean(x))
    }

    if(is.numeric(center)){
        logx <- logx - tlog(center)
    }

    return(logx)

}

vif <- function(form, data, family = "binomial"){
    if(!is_formula(form)) {form <- formula(form)}

    lmmod <- glm(form, data = data,  family = family)

    vifs <- car::vif(lmmod)

    return(vifs)
}

add_stars <- function(pval, alpha = c(0.001, 0.01, 0.05))
{
    ifelse(pval < alpha[1], "***", ifelse(pval < alpha[2], "**",
        ifelse(pval < alpha[3], "*", "")))
}

summaryCL <- function(m, clusterid, conf.level = 0.95, boots = FALSE, R = 400, ...){
    if(isFALSE(boots))
    {
        robust_vcov <- sandwich::vcovCL(m, cluster = clusterid)
    } else
    {
        robust_vcov <- sandwich::vcovBS(m, cluster = clusterid, R, ...)
    }


    rob_coef <- lmtest::coeftest(m, vcov. = robust_vcov)
    rob_confint <- lmtest::coefci(m, level = conf.level, vcov. = robust_vcov)

    results <- cbind(rob_coef, rob_confint)
    results <- data.frame(results)

    names(results) <- c("estimate", "SE", "z.value", "p.value", "ci.low", "ci.high")

    results$sig <- add_stars(results[,4])

    waldt <- lmtest::waldtest(m, vcov = robust_vcov, test = "Chisq")

    results_list <- list(coefs = results, clusterid = clusterid, wald = waldt, vcov = robust_vcov)

    class(results_list) <- "summaryCL"

    return(results_list)

}


print.summaryCL <- function(summaryCL.object){
    print(summaryCL.object[-4])
}

vcov.summaryCL <- function(summaryCL.object){
    summaryCL.object$vcov
}


# predictive accuracy function

accuracy <- function(mod){

    nm <- mod$model

    # Naive Guess
    t1 <- table(nm[,1])
    pt1 <- prop.table(t1)
    ng <- round(max(pt1) * 100, 3)

    # Predictive accuracy
    nm$predicted <- round(predict(mod,type = "response"))

    confusion <- table(nm[,1], nm$predicted)

    predaccu <- round(sum(diag(confusion)) / sum(confusion) * 100, 3)

    return(list(accuracy = predaccu, naive = ng))

}

mysummary <- function(m){
    print(summary(m))
    print(car::vif(m))
    print(logLik(m))
    print(waldtest(m, test = "Chisq"))
    print(accuracy(m))
    print(car::Anova(m))
}

mkbin <- function(x,n = 0) ifelse(x > n, 1, 0)

capadjust <- function(x, y, K = 0) x/(K-y)

```

# Data input and processing

We first load and arrange the area and victim level data.

As the script is designed to be run remotely, when working locally during development, testing data needs to be downloaded from github. To download the testing data, the script uses an Rmarkdown parameter (`params$test`). The parameter is set to `FALSE` by default, so that it runs seamlessly using the `render` command when running in the remote research settings. For running correctly in a testing setting, the parameter must be given a `TRUE` value when running the knit command (`rmarkdown::render('ENVE_rv_ext_type.Rmd', params = list(test = TRUE))`). When using `knitr`, no parameter is passed, so the following gives an error. This is expected behaviour.

```{r testing}
#params <- list(test = TRUE)
if(params$test){
    download("https://raw.githubusercontent.com/prestevez/datahouse/master/enve2014cuest_ciega_2014.dbf",
                      destfile = "enve2014cuest_ciega_2014.dbf", mode = "wb")
    download("https://raw.githubusercontent.com/prestevez/datahouse/master/enve2014delitos_ciega_2014.dbf",
                 destfile = "enve2014delitos_ciega_2014.dbf", mode = "wb")
}

```

Next we explore what files are available in the working directory.

```{r files}

list.files()

```

Next we input the additional data needed for the analysis currently saved in Github.

```{r GH-data}

cat_entidades <- read.csv("https://raw.githubusercontent.com/prestevez/datahouse/master/cat_entidades.csv", head=TRUE)
state_level_data <- read.csv("https://raw.githubusercontent.com/prestevez/datahouse/master/state_level_data_2013.csv", header=TRUE)
state_level_data <- merge(state_level_data,
                          cat_entidades, by="CVE_ENT", all.x=TRUE)
scode <- read.csv("https://raw.githubusercontent.com/prestevez/datahouse/master/secode.csv", head=TRUE)
scode$Code <- scode$Code*10000


```

Now we are ready to input the victim-level data.

```{r victim-level-import}
enve_all <- read.dbf("enve2014cuest_ciega_2014.dbf")

```

To prepare the data for analysis we select only the variables that are used in the analysis.

```{r victim-level-processing}

enve_test <- data.frame(extortions=as.integer(as.character(enve_all$P26_10)))

enve_test$extortion_victim <- enve_all$P25_10
enve_test$extortions[enve_test$extortion_victim == 2] <- 0
summary(enve_test$extortions)
table(enve_test$extortions)

enve_test$extortions[is.na(enve_test$extortions)] <- 0

summary(enve_test$extortions)
table(enve_test$extortions)


enve_test$rep_extortion_victim <- mkbin(enve_test$extortions, 1)
#enve_test$rep_extortion_victim <- factor(enve_test$extortions)
#levels(enve_test$rep_extortion_victim) <- c(0, 0,
#                    rep(1, length(levels(enve_test$rep_extortion_victim)) - 2))

table(enve_test$rep_extortion_victim)

enve_test$rep_extortions <- enve_test$extortions
enve_test$rep_extortions[enve_test$rep_extortions > 0] <- enve_test$rep_extortions[enve_test$rep_extortions > 0] - 1

summary(enve_test$rep_extortions)
table(enve_test$rep_extortions)


enve_test$CVE_UNICA <- as.integer(as.character(enve_all$ID_CONSECU))

enve_test$bribes <- as.integer(as.character(enve_all$P33))
summary(enve_test$bribes)

# 4 bribe cats
enve_test$bribe1 <- enve_all$P29_1
enve_test$bribe2 <- enve_all$P30_1
enve_test$bribe3 <- enve_all$P31_1
enve_test$bribe4 <- enve_all$P32_1

enve_test$bribes[with(enve_test,
                        bribe1 == 2 &
                        bribe2 == 2 &
                        bribe3 == 2 &
                        bribe4 == 2)] <- 0

summary(enve_test$bribes)

enve_test$bribes[is.na(enve_test$bribes)] <- 0

enve_test$bribe_victim <- mkbin(enve_test$bribes, 0)

table(enve_test$bribe_victim)

enve_test$rep_bribe <- mkbin(enve_test$bribes, 1)

table(enve_test$rep_bribe)

enve_test$bribe_cats <- factor(enve_test$bribes)
levels(enve_test$bribe_cats) <- c(0, 1, 2, rep("3+",
                                            length(levels(enve_test$bribe_cats)) - 3))
summary(enve_test$bribe_cats)

enve_test$CVE_ENT <- as.integer(as.character(enve_all$CVE_ENT))

enve_test$size <- enve_all$ID_ESTRATO
levels(enve_test$size) <- c("Large", "Medium", "Small", "Micro")

enve_test$sector <- enve_all$SECTOR_FIN

# subsector
enve_test$tempsub <- as.integer(as.character(enve_all$P1_1B))
enve_test$subsector <- cut(enve_test$tempsub, scode$Code, right=FALSE)
levels(enve_test$subsector) <- scode$Sector
enve_test$subsector <- droplevels(enve_test$subsector)
enve_test$subsector <- relevel(enve_test$subsector, ref="Retail")
levels(enve_test$subsector)

enve_test$subsector_safe <- enve_test$subsector

enve_test$subsector <- as.character(enve_test$subsector)

# Must remember to exclude utilities from analysis

enve_test$subsector[enve_test$subsector %in%
                      c("Mining",
                        "Construction")] <- "Other industry"

# Must remember to exclude Corporate from analysis

enve_test$subsector[enve_test$subsector %in%
                      c("Media",
                        "Maintenance",
                        "Other",
                        "Finance",
                        "Health",
                        "Leisure",
                        "Education",
                        "Prof. services",
                        "Real estate")] <- "Other serv."


enve_test$subsector <- as.factor(enve_test$subsector)
enve_test$subsector <- relevel(enve_test$subsector, ref="Retail")
levels(enve_test$subsector)
summary(enve_test$subsector)

enve_test$years <- 2013 - as.numeric(as.character(enve_all$P3))
summary(enve_test$years)

intyears <- classInt::classIntervals(enve_test$years, 5, style="quantile")
enve_test$yearsquant <- cut(enve_test$years, intyears$brks, right=TRUE,
                            include.lowest = TRUE)

enve_test <- merge(enve_test, state_level_data, by="CVE_ENT", all.x=TRUE)

length(enve_test$extortions[is.na(enve_test$extortions)])
length(enve_test$bribes[is.na(enve_test$bribes)])

## enve_test$extortions[is.na(enve_test$extortions)] <- 0
## enve_test$bribes[is.na(enve_test$bribes)] <- 0

summary(enve_test)

# Exclude Corporate and Utilitites

nrow(enve_test) # should be 28179


enve_test %>%
    filter(subsector != "Utilities") %>%
    filter(subsector != "Corporate") -> enve_test_2

enve_test_2$subsector <- droplevels(enve_test_2$subsector)

levels(enve_test_2$subsector)

enve_test_2$subsector_safe <- droplevels(enve_test_2$subsector_safe)
levels(enve_test_2$subsector_safe)

nrow(enve_test_2) # should be 28161

enve_test <- enve_test_2
nrow(enve_test)

summary(enve_test)
```

Next we import and prepare the incident-level data.

```{r incident-level}

enve_incidents_all <- read.dbf("enve2014delitos_ciega_2014.dbf")

# Selecting only those relevant for extortion (code 10)

enve_incidents_all$delito <- as.integer(as.character(enve_incidents_all$ID_DELITO))

enve_incidents <- enve_incidents_all[enve_incidents_all$delito == 10,]

# Selecting those relevant for our study

incident_df <- data.frame(CVE_UNICA=as.integer(as.character(enve_incidents$ID_CONSECU)))

incident_df$month <- as.numeric(as.character(enve_incidents$M1_1))

incident_df$delito <- enve_incidents$delito

incident_df$n_offenders <- enve_incidents$M1_8
summary(incident_df$n_offenders)

levels(incident_df$n_offenders) <- c(1:6, "DK/DA")
summary(incident_df$n_offenders)

incident_df$n_offenders_NA <-  incident_df$n_offenders
incident_df$n_offenders_NA[is.na(incident_df$n_offenders)] <- "DK/DA"
summary(incident_df$n_offenders_NA)

incident_df$n_offenders_old <- incident_df$n_offenders_NA
levels(incident_df$n_offenders_NA) <- c(1:3, "4+", "4+", "4+", "DK/DA")
summary(incident_df$n_offenders_NA)

incident_df$uk_n_offenders <- incident_df$n_offenders_NA

levels(incident_df$uk_n_offenders)[1:4] <- "known"

incident_df$n_offenders_num <- enve_incidents$M1_8
summary(incident_df$n_offenders_num)
levels(incident_df$n_offenders_num) <- c(1:6, 0)
summary(incident_df$n_offenders_num)
incident_df$n_offenders_num[is.na(incident_df$n_offenders_num)] <- 0
incident_df$n_offenders_num <- as.numeric(as.character(incident_df$n_offenders_num))
table(incident_df$n_offenders_num)

incident_df$n_offenders_num <- incident_df$n_offenders_num - 1


## Data imputation for missing variables?

incident_df$rel_offenders <- enve_incidents$M1_11
levels(incident_df$rel_offenders) <- c("Known", "Known",
                                       "Known", "Known",
                                       "Total stranger", "DK/DA")
incident_df$rel_offenders <- relevel(incident_df$rel_offenders, ref="Total stranger")
summary(incident_df$rel_offenders)

incident_df$rel_offenders_NA <- incident_df$rel_offenders
incident_df$rel_offenders_NA[is.na(incident_df$rel_offenders_NA)] <- "DK/DA"
summary(incident_df$rel_offenders_NA)

incident_df$had_weapon <- enve_incidents$M1_13
levels(incident_df$had_weapon) <- c("Yes", "No", "DK/DA")
incident_df$had_weapon <- relevel(incident_df$had_weapon, ref="No")
summary(incident_df$had_weapon)

incident_df$had_weapon_NA <- incident_df$had_weapon
incident_df$had_weapon_NA[is.na(incident_df$had_weapon_NA)] <- "DK/DA"
summary(incident_df$had_weapon_NA)

incident_df$extortion_type <- as.character(enve_incidents$M5_1)
incident_df$extortion_type <- as.factor(incident_df$extortion_type)
levels(incident_df$extortion_type) <- c("Remote", "Remote", "Street",
                                        "Premises", "Cobro de piso", "Other")
levels(incident_df$extortion_type)
summary(incident_df$extortion_type)

incident_df$extortion_type_bin <- as.character(enve_incidents$M5_1)
incident_df$extortion_type_bin <- as.factor(incident_df$extortion_type_bin)
levels(incident_df$extortion_type_bin) <- c("Remote", "Remote", "In person",
                                        "In person", "In person", "Other")
levels(incident_df$extortion_type_bin)
summary(incident_df$extortion_type_bin)

# Extortion bin w/o Cobro de piso
incident_df$extortion_type_wocp <- as.character(enve_incidents$M5_1)
incident_df$extortion_type_wocp <- as.factor(incident_df$extortion_type_wocp)
levels(incident_df$extortion_type_wocp) <- c("Remote", "Remote", "In person",
                                        "In person", "Other", "Other")
levels(incident_df$extortion_type_wocp)
summary(incident_df$extortion_type_wocp)


incident_df$complied <- enve_incidents$M5_3
levels(incident_df$complied) <-  c("Yes", "No", "DK/DA")
incident_df$complied <- relevel(incident_df$complied, ref="No")
summary(incident_df$complied)


incident_df$complied_bin <- enve_incidents$M5_3
levels(incident_df$complied_bin) <-  c("Yes", "No", NA)
incident_df$complied_bin <- relevel(incident_df$complied_bin, ref="No")
summary(incident_df$complied_bin)


incident_df$complied_bin_NA <- incident_df$complied_bin
incident_df$complied_bin_NA[is.na(incident_df$complied_bin_NA)] <- "No"
summary(incident_df$complied_bin_NA)

incident_df <- subset(incident_df, extortion_type != "Other")
incident_df$extortion_type <- droplevels(incident_df$extortion_type)

# Remember to subset out "other" obs from extortion_type_wocp
incident_df$extortion_type_bin <- droplevels(incident_df$extortion_type_bin)

summary(incident_df)
```

Next we merge both incident-level and victim-level tables.

```{r incident-victim-merge}
enve_incvic <- merge(incident_df, enve_test, by="CVE_UNICA")

nrow(enve_incvic)
nrow(incident_df)
```


# Revisions to compliance study

Further data processing required for compliance study. Subsetting data excluding NA values.

```{r subset-no-NA}

## datasets with no NA values first.

nacols <- colnames(enve_incvic)[colSums(is.na(enve_incvic)) > 0]

nonacols <- names(enve_incvic)[!(names(enve_incvic) %in% nacols)]
nonacols
enve_incvic %>%
    select(nonacols) -> enve_nona

summary(enve_nona)
nrow(enve_nona)
nrow(enve_nona[complete.cases(enve_nona),])
nrow(enve_nona[complete.cases(enve_incvic),])

## Data structure

"number of incidents"
nrow(enve_nona)

"incidents per business"
table(table(enve_nona$CVE_UNICA))
enve_nona %>%
    count(CVE_UNICA) %>%
    summarise(min(n),
              max(n),
              mean(n),
              n())

"number of incidents per state"
enve_nona %>%
    count(CVE_ENT) %>%
    summarise(min(n),
              mean(n),
              max(n),
              n())

"number of businesses per state"
enve_nona %>%
    count(CVE_ENT, CVE_UNICA) %>%
    count(CVE_ENT) %>%
    summarise(min(nn),
              mean(nn),
              max(nn))

```

The revisions required:

1) To maintain consistency with the estimates of study 1, observations regarding corporate and utility companies should be excluded (they represented too few observations). --- DONE
2) The remaining business type categories used for the analysis should be defined based on the bivariate cross-tabulation with the dependent variable (ensuring that there are sufficient observations for the logistic model). --- DONE but do EDA using both categories (new and old) --- DONE
3) Thus, the analysis should at least present a short EDA using of the distribution of the DV and IVs, as the same idea applies to the rest of the variables. --- DONE
4) Furthermore, number of offenders should also be revised (Use 4+, justify that that is the minimum number to ensure a healthy dose of 30+ obs in the yes/no compliance categories, though check the dist with full categories) --- Revision DONE but do EDA using both categories (new and old) --- DONE
5) Though a previous iteration of the analysis suggested that there were no significant interactions between extortion type and extortion incidence, corruption incidence, and drug crimes, the ranges applicable to the variables should be revised, so that predicted probabilities reflect only plausible effects observed in real life.
6) Also, models using the in-person/remote distinction should be repeated, using two types of the in-person variable (including and excluding cobro de piso incidents, as these have no repetition).
7) A table with descriptive statistics should also be computed --- DONE
8) DO descriptive statistics for study one
9) Do descriptives for state level --- DONE, still must calculate compliance and ext type prevalence and incidence per state

To deal with revision 1, calculate the national means of the state-level variables used in the models.

```{r state-level-means}

mean_bribes <- mean(state_level_data$bribes_abvic)
mean_bribes

mean_armas <- mean(state_level_data$armas)
mean_armas

mean_drogas <- mean(state_level_data$drogas)
mean_drogas

mean_poblacion <- mean(state_level_data$poblacion)
mean_poblacion

mean_N <- mean(state_level_data$N)
mean_N

mean_General <- mean(state_level_data$General)
mean_General

mean_Derecho <- mean(state_level_data$Derecho)
mean_Derecho


```

## EDA

### Table with descriptive statistics

To create simple descriptive tables, use arsenal package.


```{r descriptive-stats}

my_controls <- tableby.control(numeric.test = "kwt", cat.test = "chisq")


my_labels <- list(
  extortion_type = "Extortion type",
  extortion_type_bin = "Extortion type (binary)",
  extortion_type_wocp = "Extortion type (Other: piso)",
  n_offenders_NA = "Num. offenders",
  n_offenders_old = "Num. offenders (all cat.)",
  had_weapon_NA = "Had weapon",
  extortions = "Extortion concentration",
  bribes = "Corruption incidence",
  subsector = "Business type",
  subsector_safe = "Business type (all cat.)",
  size = "Business size",
  yearsquant = "Age (quintiles)",
  years = "Age"
)

#
#table_two <- tableby(continent ~ .,
#  data = gapminder,
#  control = my_controls
#)
#
#summary(table_two,
#  labelTranslations = my_labels,
#  title = "Summary Statistic of Gapminder Data"
#)
#


desc_formula <-  ~ extortion_type +
                        extortion_type_bin +
                        extortion_type_wocp +
                        n_offenders_NA +
                        n_offenders_old +
                        had_weapon_NA +
                        extortions +
                        bribes +
                        subsector +
                        subsector_safe +
                        size +
                        yearsquant +
                        years


desc_table <- tableby(desc_formula, data  = enve_nona,
                control = my_controls)

summary(desc_table,
            labelTranslations = my_labels,
            pfootnote = TRUE)


desc_formula2 <-  update(desc_formula, complied_bin_NA ~ .)


desc_table2 <- tableby(desc_formula2, data  = enve_nona,
                        control = my_controls)

summary(desc_table2,
            labelTranslations = my_labels,
            pfootnote = TRUE)

## Do descriptive stats per extortion types

desc_formula3 <-  update(desc_formula, extortion_type ~ . -
                                        extortion_type -
                                        extortion_type_bin -
                                        extortion_type_wocp)


desc_table3 <- tableby(desc_formula3, data  = enve_nona,
                        control = my_controls)

summary(desc_table3,
            labelTranslations = my_labels,
            pfootnote = TRUE)


desc_formula4 <-  update(desc_formula3, extortion_type_bin ~ .)


desc_table4 <- tableby(desc_formula4, data  = enve_nona,
                        control = my_controls)

summary(desc_table4,
            labelTranslations = my_labels,
            pfootnote = TRUE)


desc_formula5 <-  update(desc_formula3, extortion_type_wocp ~ .)


desc_table5 <- tableby(desc_formula5,
                        data = subset(enve_nona, extortion_type_wocp != "Other"),
                        control = my_controls)

summary(desc_table5,
            labelTranslations = my_labels,
            pfootnote = TRUE)

## State_level descriptives (On descriptives on compliance and incidence calculate later)

state_level_data %>%
    mutate(pop_mill = poblacion/1E6) -> state_level_data_2

state_labels <- list(bribes_abvic = "Corruption prevalence",
                armas = "Weapon crimes",
                drogas = "Drug crimes",
                pop_mill = "Pop. in millions",
                N = "Num. businesses",
                General = "Competitiveness",
                Derecho = "Rule of law")

state_formula <-  ~ bribes_abvic +
                armas +
                drogas +
                pop_mill +
                N +
                General +
                Derecho


state_table <- tableby(state_formula, data  = state_level_data_2)

summary(state_table,
            labelTranslations = state_labels,
            pfootnote = TRUE)



```


## Models

Fit the models reported in the compliance study. To maintain consistency with Study 1. Compare fit to a non log bribes, and to polynomial bribes.

```{r models-1}


compliance_formula <- complied_bin_NA ~ extortion_type +
                                        n_offenders_NA +
                                        had_weapon_NA +
                                        mylog(extortions) +
                                        mylog(bribes) +
                                        subsector +
                                        size +
                                        yearsquant +
                                        mylog(bribes_abvic, mean_bribes) +
                                        mylog(armas, mean_armas) +
                                        mylog(drogas, mean_drogas) +
                                        mylog(poblacion, mean_poblacion) +
                                        mylog(N, mean_N) +
                                        scale(General, mean_General, FALSE) +
                                        scale(Derecho, mean_Derecho, FALSE)

m1 <- glm(formula = compliance_formula, data = enve_nona, family = binomial())

summary(m1)
vif(m1, data = enve_nona)
logLik(m1)

waldtest(m1, test = "Chisq")


m1_step <- step(m1, direction = "both")

summary(m1_step)
car::vif(m1_step)
logLik(m1_step)
waldtest(m1_step, test = "Chisq")
waldtest(m1_step, m1, test = "Chisq")

lrtest(m1_step, m1)

Anova(m1)
Anova(m1_step)

```

Calculate predictive accuracy based on model object

```{r predictive}

accuracy(m1)

accuracy(m1_step)


```

Next we calculate the robust SE models, using a cluster variance covariance.

First set up the clustering formula:

```{r cluster-formula}

cluster_form <- ~ CVE_UNICA + CVE_ENT

```

Next calculate and report the clustered standard errors using the new model objects.

```{r cluster-errors}

m1CL <- summaryCL(m1, cluster_form)
m1CL

m1_stepCL <- summaryCL(m1_step, cluster_form)
m1_stepCL

waldtest(m1_step, m1, test = "Chisq", vcov = vcov(m1CL))

```


Next, test different specifications for bribes.

First, nolog

```{r models-nolog-bribes}

m1_nlb <- update(m1, . ~ . - mylog(bribes) + bribes)

mysummary(m1_nlb)

AIC(m1)
AIC(m1_nlb)

m1_step_nlb <- update(m1_step, . ~ . - mylog(bribes) + bribes)

mysummary(m1_step_nlb)

AIC(m1_step)
AIC(m1_step_nlb)

## Cluster SE

m1_nlb_CL <- summaryCL(m1_nlb, cluster_form)
m1_nlb_CL

m1_step_nlb_CL <- summaryCL(m1_step_nlb, cluster_form)
m1_step_nlb_CL

```

Next, try the second order polynomial of bribes

```{r models-poly-bribes}

m1_polyb <- update(m1, . ~ . - mylog(bribes) + poly(bribes, 2))

mysummary(m1_polyb)

AIC(m1)
AIC(m1_nlb)
AIC(m1_polyb)

BIC(m1)
BIC(m1_nlb)
BIC(m1_polyb)

m1_step_polyb <- update(m1_step, . ~ . - mylog(bribes) + poly(bribes, 2))

mysummary(m1_step_polyb)

AIC(m1_step)
AIC(m1_step_nlb)
AIC(m1_step_polyb)

BIC(m1_step)
BIC(m1_step_nlb)
BIC(m1_step_polyb)

## Cluster SE

m1_polyb_CL <- summaryCL(m1_polyb, cluster_form)
m1_polyb_CL

m1_polyb_nlb_CL <- summaryCL(m1_step_polyb, cluster_form)
m1_polyb_nlb_CL

```

Try testing the "cannonical" models (m1 and m1_step) using the enve_incvic data set, dropping NAs

```{r enve_incvic}

m1_incvic <- update(m1, complied_bin ~ . ,
                    data = enve_incvic)

mysummary(m1_incvic)

screenreg(list(m1, m1_incvic))

m1_incvicCL <- summaryCL(m1_incvic, cluster_form)
m1_incvicCL

m1_step_incvic <- update(m1_step, complied_bin ~ . ,
                    data = enve_incvic)

mysummary(m1_step_incvic)

screenreg(list(m1, m1_step_incvic))

m1_step_incvicCL <- summaryCL(m1_step_incvic, cluster_form)
m1_step_incvicCL


```


## Interaction terms

Previous iterations of this analysis indicated that interaction terms were not significant.

# New study

Research questions to cover in this study:

- Are in-person and remote extortion incidents concentrated beyond what is expected by chance? (Calculate locally, just obtain the distributions per type)
- What are the predictors of extortion concentration according to in-person/remote distinction?
    - Are the predictors of prevalence the same as those of concentration for the distinct types?
- What is the time course of repeat victimisation?
    - Any and by type
- Can a synthetic panel be used to estimate event dependence?


Issues to resolve in this iteration

1) Businesses that are Utilities and Corporate should be excluded to ensure consistency with study 1. --- DONE
2) Categorical independent variables should be revised so that the categories have sufficient observations for analysis, and so that they are somewhat consistent with previous studies. --- TO DO EDA by type
3) There are no repeat cobro e piso incidents, so these should be excluded from the in-person category, or at least there should be an additional category without cobro de piso incidents.
4) Thus, cobro de piso incidents should be analised using logit only.
5) There should be a post-hoc robustness check on the time-course, using only repeats that took place during the second semester. This way we can mitigate the effect of the time window. Also, fit a model to see if exponential or other (polynomial) smoother makes sense?
6) Fit models without log-transforming bribe incidence for comparison purposes (can still fit using log-bribes in "final" model)

Steps to follow:

1. Fit the models from study 1
    - Show EDA
    - Use log(bribes) and poly(bribes,2) and compare to bribes
    - Calculate accuracy of Logit models
    - Fit to capped extincs and uncapped extortions
    - Fit using `glmmTMB`, `glmmADMB` and `gamlss` to compare.
    - Don't forget to test vs poisson and truncated poisson
2. Concentration by type
    - Remember that there are no repeat cobro de piso incidents. why?
    - No need to use `gamlss`
    - Do EDAs for victim and rep victim as well
3. Event-dependence models
    - Do EDAS
    - cobro de piso has no repeats (cross-type dependency?)
    - account for time window of timecourse, calculate a fit, possibly:
        - $E(y|x) = e^{\beta_0 + \beta_1 x}$
        - $E(y|x) = e^{\beta_0 + \beta_1 x + \beta_2 x^2}$
    - Adjust lagged variable by capping asjustment factor
    - Use past compliance as a variable as well (unadjusted and adjusted)
        - Maybe use categories: Not victimised, victimised but not complied, victim and complied


## Concentration by type

The extortion distributions per type can be easily generated using pipes from tidyverse. However, these distributions are only among victims.

```{r distributions-per-type}


# extortion distribution table, all extortion incidents in victim module

enve_nona %>%
    count(CVE_UNICA) %$%
    table(n)

# extortion distribution table, by extortion type

enve_nona %>%
    count(CVE_UNICA, extortion_type) %$%
    table(n, extortion_type)


# extortion distribution table, by extortion type binary

enve_nona %>%
    count(CVE_UNICA, extortion_type_bin) %$%
    table(n, extortion_type_bin)

enve_nona %>%
    filter(extortion_type_wocp != "Other") %>%
    count(CVE_UNICA, extortion_type_wocp = droplevels(extortion_type_wocp)) %$%
    table(n, extortion_type_wocp)

# Distribution by compliance

enve_nona %>%
    count(CVE_UNICA, complied_bin_NA) %$%
    table(n, complied_bin_NA)


```

For further work, lets aggregate the incidents to business-level, this will also allow calculating the joint distribution per type. These distributions are only among victims.


```{r joint-distributions-1}

enve_nona %>%
    count(CVE_UNICA, extortion_type) %>%
    spread(extortion_type, n, fill = 0) -> counts_per_type

names(counts_per_type)

counts_per_type %$%
    table(Remote, Street)

counts_per_type %$%
    table(Remote, Premises)

counts_per_type %$%
    table(Remote, `Cobro de piso`)

enve_nona %>%
    count(CVE_UNICA, extortion_type_bin) %>%
    spread(extortion_type_bin, n, fill = 0) -> counts_per_type_bin

names(counts_per_type_bin)

counts_per_type_bin %$%
    table(Remote, `In person`)

# Excluding cobro de piso incidents

enve_nona %>%
    filter(extortion_type_wocp != "Other") %>%
    count(CVE_UNICA, extortion_type_wocp) %>%
    spread(extortion_type_wocp, n, fill = 0) -> counts_per_type_wocp

names(counts_per_type_wocp)

counts_per_type_wocp %$%
    table(Remote, `In person`)
```

As these distributions are only among victims of at least one type of extortion incident, the counts must be joined to the general enve table to include non victims as well. Furthermore, the data could also be complemented by counts of the compliance behaviour per type.

```{r incs-to-busns}

enve_nona %>%
    group_by(CVE_UNICA) %>%
    summarise(extincs = n(),
              complied = sum(complied_bin_NA == "Yes"),
              remote = sum(extortion_type == "Remote"),
              street = sum(extortion_type == "Street"),
              premises = sum(extortion_type == "Premises"),
              piso = sum(extortion_type == "Cobro de piso"),
              inperson = sum(extortion_type_bin == "In person"),
              comp_remote  = sum(extortion_type_bin == "Remote" & complied_bin_NA == "Yes"),
              comp_inperson  = sum(extortion_type_bin == "In person" & complied_bin_NA == "Yes"),
              comp_street  = sum(extortion_type == "Street" & complied_bin_NA == "Yes"),
              comp_premises  = sum(extortion_type == "Premises" & complied_bin_NA == "Yes"),
              comp_piso  = sum(extortion_type == "Cobro de piso" & complied_bin_NA == "Yes"),
              inperson_wocp = sum(extortion_type_wocp == "In person"),
              comp_inperson_wocp  = sum(extortion_type_wocp == "In person" & complied_bin_NA == "Yes")) -> enve_bus_lev

### Merge with the enve_test data, keeping non victims as 0

enve_test %>%
    left_join(enve_bus_lev, by = "CVE_UNICA") -> enve_plus


enve_plus %>%
    replace(is.na(.), 0) -> enve_plus_nona

```

Now we can do some joint distributions including victims and non-victims

```{r joint-dists-2}

## overall distribution of extortion incidents

enve_plus_nona %$% table(extincs)

# by binary type

enve_plus_nona %$% table(remote, inperson)

# by binary type, wocp

enve_plus_nona %$% table(remote, inperson_wocp)

# by disaggregated type

enve_plus_nona %$% table(remote, street)

enve_plus_nona %$% table(remote, premises)

enve_plus_nona %$% table(remote, piso)

# street vs premises?

enve_plus_nona %$% table(premises, street)

enve_plus_nona %$% table(premises, piso)

enve_plus_nona %$% table(street, piso)

enve_plus_nona %$% table(inperson_wocp, piso)

## by compliance??

enve_plus_nona %$% table(comp_remote, comp_inperson)

enve_plus_nona %$% table(comp_remote, comp_inperson_wocp)

```

## Models from study 1

In this section, we run some models to explore the predictors of in-person and remote extortion concentration. The focus here is not so much to exhaustively test all the possible predictors, but to replicate the models from study one [@Estevez-Soto2019]. Thus, less emphasis will be placed on finding the ideal model specification, and more on testing the different models available (based on different specifications). Once a suitable type of model is identified, robustness and specification checks can be carried out more systematically.

Specifically, the models to be tested are:

- Multilevel negative binomial (and Poisson)
    - with censoring/truncation if possible
- Multilevel negative binomial-logit hurdle
- Multilevel logit-logit hurdle
- (AS GAMLSS.NP FUNCTION FOR FITTING TRUNCATED MUTLILEVEL MODELS IS NOT WORKING FIT SINGLE LEVEL MODELS INSTEAD, USE CLUSTERED ERRORS IF NEEDED).

Before testing the new extortion counts per type, I will first briefly test the models using the capped extortion counts to compare the estimates to those presented in @Estevez-Soto2019, as they should not be too different.

### Overall extortion concentration

The original model fit in @Estevez-Soto2019 included the following explanatory variables:

- Unit level:
    - corruption victimisations (not logged, but should be logged, try both)
    - business age
    - business type (using full categories)
    - business size
- Area level:
    - corruption prevalence (log)
    - weapon crimes (log)
    - drug crimes (log)
    - n (log)
    - pop (log)
    - competitiveness index (centred)
    - rule of law (centred)

1. Fit the models from study 1
    - Show EDA
    - Use log(bribes) and poly(bribes,2) and compare to bribes
    - Calculate accuracy of Logit models
    - Fit to capped extincs and uncapped extortions
    - Fit using `glmmTMB`, `glmmADMB` and `gamlss` to compare. -- Will not compare to glmmADMB... it takes for ever.
    - Don't forget to test vs poisson and truncated poisson

### EDA First

Do EDA for the variables in model from study 1


```{r eda-study-1}

my_controls <- tableby.control(numeric.test = "kwt", cat.test = "chisq")

s1_formula <-   ~ extortions +
                  bribes +
                  yearsquant +
                  years +
                  subsector_safe +
                  subsector +
                  size


s1_labels <- list(bribes = "Corruption incidence",
                  yearsquant = "Age (quintiles)",
                  years = "Age",
                  subsector_safe = "Business type (all cat.)",
                  subsector = "Business type",
                  size = "Business size")



s1_table <- tableby(s1_formula, data  = enve_plus_nona,
                control = my_controls)

summary(s1_table,
            labelTranslations = s1_labels,
            pfootnote = TRUE)


s1_formula2 <-  update(s1_formula, mkbin(extortions) ~ .)


s1_table2 <- tableby(s1_formula2, data  = enve_plus_nona,
                        control = my_controls)

summary(s1_table2,
            labelTranslations = s1_labels,
            pfootnote = TRUE)


s1_formula3 <-  update(s1_formula, mkbin(extortions, 1) ~ .)


s1_table3 <- tableby(s1_formula3, data  = enve_plus_nona,
                        control = my_controls)

summary(s1_table3,
            labelTranslations = s1_labels,
            pfootnote = TRUE)

## Exclude non victims

s1_table4 <- tableby(s1_formula3,
                        data = subset(enve_plus_nona, extortions > 0),
                        control = my_controls)

summary(s1_table4,
            labelTranslations = s1_labels,
            pfootnote = TRUE)


### Repeat the eda for te extincs variable

s1_formula5 <-  update(s1_formula, mkbin(extincs) ~ .)


s1_table5 <- tableby(s1_formula5, data  = enve_plus_nona,
                        control = my_controls)

summary(s1_table5,
            labelTranslations = s1_labels,
            pfootnote = TRUE)


s1_formula6 <-  update(s1_formula, mkbin(extincs, 1) ~ .)


s1_table6 <- tableby(s1_formula6, data  = enve_plus_nona,
                        control = my_controls)

summary(s1_table6,
            labelTranslations = s1_labels,
            pfootnote = TRUE)

## Exclude non victims

s1_table7 <- tableby(s1_formula6,
                        data = subset(enve_plus_nona, extincs > 0),
                        control = my_controls)

summary(s1_table7,
            labelTranslations = s1_labels,
            pfootnote = TRUE)


```

After that round of EDA, next we fit the Models from study 1 on `extortions` and `extincs` using `glmmTMB`, `glmmADMB`, and compar with `gamlss`.


We first fit the MNB model.

```{r mnb-extortions-vs-extincs}

countsummary <- function(model){
    sm <- summary(model)
    cf <- confint(model)
    sgm <- sigma(model)

    if(length(sgm) == 0){
        sgm <- model$alpha
    }

    list(Summary = sm,
            "Confidence Interval" = cf,
            "Log-likelihood " = logLik(model),
            "AIC" = AIC(model),
            "BIC" = BIC(model),
            alpha = c("alpha" = 1/sgm, "1/alpha" = sgm),
            LRT = lmtest::lrtest(model),
            ANOVA = car::Anova(model))
}

compare_alphas <- function(model1, model2) {
    if(class(model1) == "glmmTMB"){
        alpha1 <- 1/sigma(model1)
    } else if(class(model1) == "gamlss"){
        alpha1 <- exp(coef(model1, "sigma"))
    } else{
        alpha1 <- 1/model1$alpha
    }
    if(class(model2) == "glmmTMB"){
        alpha2 <- 1/sigma(model2)
    } else if(class(model2) == "gamlss"){
        alpha2 <- exp(coef(model2, "sigma"))
    } else{
        alpha2 <- 1/model2$alpha
    }

    c("Model 1 Alpha" = alpha1,
        "Model 2 Alpha" = alpha2,
        "M1/M2" = alpha1/alpha2,
        "M1 - M2" = alpha1 - alpha2)
}

compare_estimates <- function(model1, model2, rounding = 5){
    if(class(model1) == "glmmTMB"){
        coefs1 <- fixef(model1)$cond
        ses1 <- sqrt(diag(vcov(model1)$cond))
    } else if(class(model1) == "gamlss"){
        gsum1 <- summary(model1)
        coefs1 <- gsum1[-nrow(gsum1),1]
        ses1 <- gsum1[-nrow(gsum1),2]
    } else{
        coefs1 <- coef(model1)
        ses1 <- sqrt(diag(vcov(model1)))
        ncoefs1 <- length(coefs1)
        ses1 <- ses1[1:ncoefs1]
    }

    if(class(model2) == "glmmTMB"){
        coefs2 <- fixef(model2)$cond
        ses2 <- sqrt(diag(vcov(model2)$cond))
    } else if(class(model2) == "gamlss"){
        gsum2 <- summary(model2)
        coefs2 <- gsum2[-nrow(gsum2),1]
        ses2 <- gsum2[-nrow(gsum2),2]
    } else {
        coefs2 <- coef(model2)
        ses2 <- sqrt(diag(vcov(model2)))
        ncoefs2 <- length(coefs2)
        ses2 <- ses2[1:ncoefs2]
    }

    mat <- cbind(coefs1-coefs2, ses1-ses2)
    colnames(mat) <- c("Estimate bias", "SE bias")
    return(round(mat, rounding))
}


inc_form <- extortions ~
                bribes +
                yearsquant +
                subsector_safe +
                size +
                mylog(bribes_abvic, mean_bribes) +
                mylog(armas, mean_armas) +
                mylog(drogas, mean_drogas) +
                mylog(N, mean_N) +
                mylog(poblacion, mean_poblacion) +
                scale(General, mean_General, FALSE) +
                scale(Derecho, mean_Derecho, FALSE) +
                (1|CVE_ENT)


mnb_extortions <- glmmTMB(inc_form,
            family = "nbinom2", data = enve_plus_nona)

countsummary(mnb_extortions)

# Compare to glmmADMB

inc_form_admb <- update(inc_form,  . ~ . - (1 | CVE_ENT) +
                        (1 | NOM_ENT))

mbn_extortions_admb <- glmmadmb(inc_form_admb,
                        family = "nbinom",
                        data = enve_plus_nona,
                        zeroInflation = FALSE,
                        admb.opts = glmmADMB::admbControl(noinit = FALSE, shess=FALSE), extra.args = "-ndi 60000")

countsummary(mbn_extortions_admb)

## Bias between fixed effects estimates

compare_estimates(mnb_extortions, mbn_extortions_admb)

compare_alphas(mnb_extortions, mbn_extortions_admb)

# fit only the truncated nbinom using glmmtmb to compare to glmmadmb, especially to compare to a poisson

mtnb_extortions <- glmmTMB(inc_form,
            family = "truncated_nbinom2",
            data = subset(enve_plus_nona, extortions > 0))

countsummary(mtnb_extortions)

compare_estimates(mnb_extortions, mtnb_extortions)

compare_alphas(mnb_extortions, mtnb_extortions)

# compare to glmmadmb

mtnb_extortions_admb <- update(mbn_extortions_admb,
                        family = "truncnbinom",
                        data = subset(enve_plus_nona, extortions > 0))

countsummary(mtnb_extortions_admb)

compare_estimates(mtnb_extortions, mtnb_extortions_admb)

compare_alphas(mtnb_extortions, mtnb_extortions_admb)

# Compare to truncated poisson

mtp_extortions <- update(mtnb_extortions, family = "truncated_poisson")


countsummary(mtp_extortions)

lrtest(mtp_extortions, mtnb_extortions)


compare_estimates(mtnb_extortions, mtp_extortions)


## single level

tnb_extortions <- update(mtnb_extortions, . ~ . - (1|CVE_ENT))

countsummary(tnb_extortions)

lrtest(tnb_extortions, mtnb_extortions)

compare_estimates(tnb_extortions, mtnb_extortions)
compare_alphas(tnb_extortions, mtnb_extortions)

# single truncated poisson

tp_extortions <- update(tnb_extortions, family = "poisson")

countsummary(tp_extortions)

lrtest(tp_extortions, tnb_extortions)
lrtest(tp_extortions, mtp_extortions)

#run logits

mlogit_extortions <- update(mnb_extortions, mkbin(extortions) ~ .,
                            family = "binomial")

countsummary(mlogit_extortions)

logit_extortions <- update(mlogit_extortions, . ~ . - (1|CVE_ENT))

countsummary(logit_extortions)

lrtest(logit_extortions, mlogit_extortions)

compare_estimates(logit_extortions, mlogit_extortions)

## No accuracy for glmmtmb models, due to no predict function working.

# use log bribes

mnb_extortions_logb <- update(mnb_extortions, . ~ . - bribes +
                                mylog(bribes))

countsummary(mnb_extortions_logb)


# fit only the truncated nbinom

mtnb_extortions_logb <- update(mtnb_extortions,
                                formula(mnb_extortions_logb))


countsummary(mtnb_extortions_logb)


#run logits

mlogit_extortions_logb <- update(mlogit_extortions, . ~ . - bribes +
                                    mylog(bribes))


countsummary(mlogit_extortions_logb)


## Compare to capped extortion figures

mnb_extincs <- update(mnb_extortions, extincs ~ . )

countsummary(mnb_extincs)

# Compare to mnb_extortions

compare_estimates(mnb_extortions, mnb_extincs)

compare_alphas(mnb_extortions, mnb_extincs)


### No need to use log bribes for this (I will not change study 1)

## The goal is to compare to gamlss

# fit single level to compare to gamlss

nb_extincs <- update(mnb_extincs, . ~ . - (1|CVE_ENT))
countsummary(nb_extincs)

compare_estimates(mnb_extincs, nb_extincs)
compare_alphas(mnb_extincs, nb_extincs)

# compare to single level extortions

nb_extortions <- update(mnb_extortions, . ~ . - (1|CVE_ENT))

compare_estimates(nb_extortions, nb_extincs)
compare_alphas(nb_extortions, nb_extincs)

compare_estimates(mnb_extortions, nb_extortions)
compare_alphas(mnb_extortions, nb_extortions)

```

We fit the same models (using single level only) using GAMLSS, and compare the estimates.

The package `gamlss` allows fitting models to custom censored and truncated distributions. As the extortion counts measured using the victim modules are capped at 7, the `gamlss` code should provide less biased estimates. Fitting random intercepts models is a bit more complicated, however, as this requires the `gamlssNP` function from the `gamlss.mx` package. Unfortunately, I have found a bug that makes this function unusable. Thus, it will be necessary to only fit single-level models for now, especially for the truncated/censored counts parts.

To compare the consistency of `gamlss` estimates, first compare the fit to a single-level NB model of the uncapped extortion estimates fit using `glmmTMB`.

The comparison are thus:
- nb_extortions vs gamlss_NBI_extortions
- nb_extincs vs gamlss_NBI_extincs
- gamlss_NBI_extortions vs gamlss_NBI_extincs
- nb_extincs vs gamlss_NBItr_8_extincs
- gamlss_NBI_extincs vs gamlss_NBItr_8_extincs (this is the one that matters most)

```{r comparing-models-for-incidence}

sl_inc_form_exts <- update(inc_form, extortions ~ . - (1|CVE_ENT))

nb_exts_gamlss <- gamlss(sl_inc_form_exts, data = enve_plus_nona,
                            family = NBI)

compare_estimates(nb_extortions, nb_exts_gamlss)
compare_alphas(nb_extortions, nb_exts_gamlss)

### Fit a gamlss to extincs

nb_extincs_gamlss <- update(nb_exts_gamlss, extincs ~ . )


compare_estimates(nb_extincs, nb_extincs_gamlss)
compare_alphas(nb_extincs, nb_extincs_gamlss)


compare_estimates(nb_exts_gamlss, nb_extincs_gamlss)
compare_alphas(nb_exts_gamlss, nb_extincs_gamlss)


# Generate the truncated-at-8 count distributions

gen.trun(par = 8, family = NBI,
        name = "tr_8",
        type = "right")



# fit truncated NBI

nb_extincs_tr_8 <- update(nb_extincs_gamlss, family = NBItr_8)

compare_estimates(nb_extincs, nb_extincs_tr_8)
compare_alphas(nb_extincs, nb_extincs_tr_8)

compare_estimates(nb_extincs_gamlss, nb_extincs_tr_8)
compare_alphas(nb_extincs_gamlss, nb_extincs_tr_8)


```

And for the truncated models:

- tnb_extortions vs gamlss_NBItr_0_extortions
- gamlss_NBItr_0_extortions vs gamlss_NBItr_0_extincs
- tnb_extincs vs gamlss_NBItr_0_extincs
- tnb_extincs vs gamlss_NBItr_08_extincs
- gamlss_NBItr_0_extincs vs gamlss_NBItr_08_extincs (this is the one that matters most)

```{r comparing-models-for-concentration}

# Generate gamlss truncated at zero distribution

gen.trun(par = 0, family = NBI,
            name = "tr_0",
            type = "left")

tnb_extortions_gamlss <- gamlss(formula(tnb_extortions),
                family = NBItr_0,
                data = subset(enve_plus_nona, extortions > 0))

compare_estimates(tnb_extortions, tnb_extortions_gamlss)

compare_alphas(tnb_extortions, tnb_extortions_gamlss)


tnb_extincs_gamlss <- update(tnb_extortions_gamlss, extincs ~ .,
                        data = subset(enve_plus_nona, extincs > 0))

#gamlss_NBItr_0_extortions vs gamlss_NBItr_0_extincs
compare_estimates(tnb_extortions_gamlss, tnb_extincs_gamlss)
compare_alphas(tnb_extortions_gamlss, tnb_extincs_gamlss)


# tnb_extincs vs gamlss_NBItr_0_extincs

tnb_extincs <- update(tnb_extortions, extincs ~ .,
                        data = subset(enve_plus_nona, extincs > 0))

compare_estimates(tnb_extincs, tnb_extincs_gamlss)
compare_alphas(tnb_extincs, tnb_extincs_gamlss)

# tnb_extincs vs gamlss_NBItr_08_extincs

#### create a truncated (0,8) gamlss NBI distribution

gen.trun(par = c(0,8), family = NBI,
            type = "both",
            name = "tr_08")


tnb_extincs_NBItr_08 <- update(tnb_extincs_gamlss,
                                family = NBItr_08)

compare_estimates(tnb_extincs, tnb_extincs_NBItr_08)
compare_alphas(tnb_extincs, tnb_extincs_NBItr_08)


# gamlss_NBItr_0_extincs vs gamlss_NBItr_08_extincs

compare_estimates(tnb_extincs_gamlss, tnb_extincs_NBItr_08)
compare_alphas(tnb_extincs_gamlss, tnb_extincs_NBItr_08)


```

These collection of models should illustrate the general patterns of capped extortion incidents vis-a-vis uncapped extortion incidents. Also, they should reveal whether the estimates for capped data using `glmmTMB` are substantively different from those using the correct distributional limits as specified in the truncated `gamlss.tr` distributions.

If the estimates for `glmmTMB` model are not very different from `gamlss.tr` models, then the latter may not be worth the trouble, particularly because of the former's flexibility to estimate random intercepts.

### Modelling according to extortion type

Based on previous iterations, and possibly these results, further models for extortion type and event dependence should be estimated using `glmmTMB`.

Nonetheless, there are several considerations to make:

- There were no repeats of cobro de piso incidents. Thus it makes no sense to estimate models for concentration and event dependence for these type of incidents.
- Thus, there should be two kinds of in-person category models: with and without cobro de piso incidents.
- Verify results from previous iterations to see if some categories need revising.
- Begin with EDA.
- Compare fit to models without log-transforming bribes.

I will move on to the EDA now.

#### EDA: By extortion type.

First, calculate univariate distributions

```{r univariate-by-type}

enve_plus_nona %$%
    table(remote)

enve_plus_nona %$%
    table(inperson)


enve_plus_nona %$%
    table(inperson_wocp)

enve_plus_nona %$%
    table(piso)


enve_plus_nona %>%
    select(remote, inperson, inperson_wocp, piso) %>%
    melt %>%
    group_by(variable) %>%
    summarise(mean = mean(value),
                variance = var(value),
                ratio = mean/variance)


```



It is crucial to identify any issues of complete or quasi-complete separation to avoid estimation errors and problems.

We begin by creating descriptive tables

A table with the prevalence of remote extortion victimisation, per the unit-level variables used in the study.

```{r eda-remote}

eda_remote_formula <-   ~  bribes +
                            yearsquant +
                            years +
                            subsector_safe +
                            subsector +
                            size


eda_remote_labels <- list(bribes = "Corruption incidence",
                  yearsquant = "Age (quintiles)",
                  years = "Age",
                  subsector_safe = "Business type (all cat.)",
                  subsector = "Business type",
                  size = "Business size")



eda_r_table <- tableby(eda_remote_formula,
                        data  = enve_plus_nona,
                        control = my_controls)

summary(eda_r_table,
            labelTranslations = eda_remote_labels,
            pfootnote = TRUE)


eda_r_formula2 <-  update(eda_remote_formula,
                        mkbin(remote) ~ .)


eda_r_table2 <- tableby(eda_r_formula2, data  = enve_plus_nona,
                        control = my_controls)

summary(eda_r_table2,
            labelTranslations = eda_remote_labels,
            pfootnote = TRUE)


```

Now generate a table to examine the prevalence or repeat remote extortion victimisation, among all units, and among only victims.


```{r eda-remote-2}


eda_r_formula3 <-  update(eda_remote_formula,
                        mkbin(remote, 1) ~ .)


eda_r_table3 <- tableby(eda_r_formula3, data  = enve_plus_nona,
                        control = my_controls)

summary(eda_r_table3,
            labelTranslations = eda_remote_labels,
            pfootnote = TRUE)

## now only among victims

eda_r_table4 <- tableby(eda_r_formula3,
                        data  = subset(enve_plus_nona, remote > 0),
                        control = my_controls)

summary(eda_r_table4,
            labelTranslations = eda_remote_labels,
            pfootnote = TRUE)

```

Repeat for in-person category

```{r eda-in-person}

# Prevalence


eda_ip_formula <-  update(eda_remote_formula,
                        mkbin(inperson) ~ .)


eda_ip_table <- tableby(eda_ip_formula, data  = enve_plus_nona,
                        control = my_controls)

summary(eda_ip_table,
            labelTranslations = eda_remote_labels,
            pfootnote = TRUE)

# Repeat victimisation prevalence


eda_ip_formula2 <-  update(eda_remote_formula,
                        mkbin(inperson, 1) ~ .)


eda_ip_table2 <- tableby(eda_ip_formula2, data  = enve_plus_nona,
                        control = my_controls)

summary(eda_ip_table2,
            labelTranslations = eda_remote_labels,
            pfootnote = TRUE)

## now only among victims

eda_ip_table3 <- tableby(eda_ip_formula2,
                        data  = subset(enve_plus_nona, inperson > 0),
                        control = my_controls)

summary(eda_ip_table3,
            labelTranslations = eda_remote_labels,
            pfootnote = TRUE)


```

Repeat for in-person categories without cobro de piso


```{r eda-in-person-wocp}

# Prevalence

eda_ipw_formula <-  update(eda_remote_formula,
                        mkbin(inperson_wocp) ~ .)


eda_ipw_table <- tableby(eda_ipw_formula, data  = enve_plus_nona,
                        control = my_controls)

summary(eda_ipw_table,
            labelTranslations = eda_remote_labels,
            pfootnote = TRUE)

# Repeat victimisation prevalence


eda_ipw_formula2 <-  update(eda_remote_formula,
                        mkbin(inperson_wocp, 1) ~ .)


eda_ipw_table2 <- tableby(eda_ipw_formula2, data  = enve_plus_nona,
                        control = my_controls)

summary(eda_ipw_table2,
            labelTranslations = eda_remote_labels,
            pfootnote = TRUE)

## now only among victims

eda_ipw_table3 <- tableby(eda_ipw_formula2,
                        data  = subset(enve_plus_nona, inperson_wocp > 0),
                        control = my_controls)

summary(eda_ipw_table3,
            labelTranslations = eda_remote_labels,
            pfootnote = TRUE)


```

Next explore prevalence of cobro de piso.

```{r eda-cobro-de-piso}

# Prevalence

eda_cp_formula <-  update(eda_remote_formula,
                        mkbin(piso) ~ .)


eda_cp_table <- tableby(eda_cp_formula, data  = enve_plus_nona,
                        control = my_controls)

summary(eda_cp_table,
            labelTranslations = eda_remote_labels,
            pfootnote = TRUE)


```


For completeness, do eda looking at the entire distributions.

Check bivariate tables between capped counts per type and the categorical variables.

```{r eda-by-type}

enve_plus_nona %$%
    table(remote, yearsquant)

enve_plus_nona %$%
    table(remote, subsector_safe)

enve_plus_nona %$%
    table(remote, subsector)

enve_plus_nona %$%
    table(remote, size)


enve_plus_nona %$%
    table(inperson, yearsquant)

enve_plus_nona %$%
    table(inperson, subsector_safe)

enve_plus_nona %$%
    table(inperson, subsector)

enve_plus_nona %$%
    table(inperson, size)

enve_plus_nona %$%
    table(street, yearsquant)

enve_plus_nona %$%
    table(street, subsector_safe)

enve_plus_nona %$%
    table(street, subsector)

enve_plus_nona %$%
    table(street, size)


enve_plus_nona %$%
    table(premises, yearsquant)

enve_plus_nona %$%
    table(premises, subsector_safe)

enve_plus_nona %$%
    table(premises, subsector)

enve_plus_nona %$%
    table(premises, size)

enve_plus_nona %$%
    table(piso, yearsquant)

enve_plus_nona %$%
    table(piso, subsector_safe)

enve_plus_nona %$%
    table(piso, subsector)

enve_plus_nona %$%
    table(piso, size)


```


Based on the EDAs from previous iterations, should any category be collapsed or changed? Minimum observations: approx. 30

- Remote extortion:
    - Yearsquant: All categories have enough observations for prevalence and concentration.
    - Subsector_safe (all categories):
        - Prevalence: There are not enough observations in:
            - Mining
            - Utilities
            - Media
            - Corporate
            - Leisure
        - Concentration: There are not enough observations in:
            - Mining
            - Utilities
            - Construction
            - Transport
            - Media
            - Finance
            - Real estate
            - Prof. services
            - Corporate
            - Maintenance
            - Education
            - Health
            - Leisure
    - Subsector (Fewer categories)
        - Prevalence: All categories have sufficient observations
        - Concentration: There are no sufficient observations in:
            - Transport (May not be so bad)
    - Size:
        - Prevalence: All categories have enough observations
        - Concentration: All categories have enough observations

- In-person extortion
    - Yearsquant
        - Prevalence: All categories have enough observations
        - Concentration: All categories have too few observations
    - Subsector_safe
        - Prevalence: The following categories don't have enough observations:
            - mining
            - utilities
            - construction
            - media
            - finance
            - real estate
            - prof services
            - corporate
            - maintenance
            - education
            - health
            - leisure
        - Concentration: Most categories have no observations, or have too few observations.
            - Industry should probably be consolidated into one category
            - Wholesale has only 6 repeat victims
            - Transport also too few
            - In services, there are only 15 repeat victims
    - Subsector
        - Prevalence: Industry has only 10 obs, too few, but may be workable (check results from previous iterations)
        - Concentration: Same as for subsector
    - Size
        - Prevalence: All have enough
        - Concentration: Large, medium and small have relatively few, but probably workable

- In-person without cobro de piso
    - concentration: The same distributions as in-person applies, as cobro de piso has no repeats <-- It's settled, cobro de piso must be separated from in-person analyses
    - Prevalence:
        - yearquants: Ok
        - Subsector, same comments as in-person applies

- Piso (prevalence only)
    - yearquants: Sparse, but probably ok
    - Subsector_safe: Not ok
    - Subsector:
        - Industry should be merged
        - transport, too few (only 6) may be workable, but it is a risk
        - Most categories have too few, but are workable: except possibly transport


#### Categories adjustments

EDA suggests the following:

- Subsector_safe should not be used
- Subsector is possibly ok for prevalence models, but some concentration models may struggle. It is suggested to consolidate some categories to facilitate comparisons between models (Transport, industry)
- Size and yearquats are acceptable
- The combination of medium and transport leads to complete separation for inperson incidents (in event dependence models).


```{r cat-adjust}

enve_plus_nona$subsector_new <- enve_plus_nona$subsector

levels(enve_plus_nona$subsector_new) <- c('Retail',
                                        'HotelsRestBar',
                                        'Industry' ,
                                        'Industry',
                                        'Other serv.',
                                        'Other serv.',
                                        'Wholesale')

enve_plus_nona %$%
    table(subsector_new)

enve_plus_nona %$%
    table(mkbin(inperson_wocp), subsector_new)

enve_plus_nona %$%
    table(mkbin(piso), subsector_new)

enve_plus_nona %$%
     table(mkbin(remote), subsector_new)


eda_newsub_remote <- tableby(mkbin(remote) ~ subsector_new,
                        data  = enve_plus_nona,
                        control = my_controls)

summary(eda_newsub_remote,
            labelTranslations = eda_remote_labels,
            pfootnote = TRUE)

eda_newsub_inperson <- tableby(mkbin(inperson_wocp) ~ subsector_new,
                        data  = enve_plus_nona,
                        control = my_controls)

summary(eda_newsub_inperson,
            labelTranslations = eda_remote_labels,
            pfootnote = TRUE)

eda_newsub_piso <- tableby(mkbin(piso) ~ subsector_new,
                        data  = enve_plus_nona,
                        control = my_controls)

summary(eda_newsub_piso,
            labelTranslations = eda_remote_labels,
            pfootnote = TRUE)

```


Check state level descriptive statistics of extortion


```{r state-level-descriptives}


# State level prevalence

state_control <- tableby.control(cat.stats = "countrowpct",
                                total = FALSE,
                                test = FALSE)
# remote
eda_state_remote <- tableby(mkbin(remote) ~ NOM_ENT,
                        data  = enve_plus_nona,
                        control = state_control)

summary(eda_state_remote,
            pfootnote = TRUE)

# repeat remote victims

eda_state_remote_repeat <- tableby(mkbin(remote, 1) ~ NOM_ENT,
                        data  = subset(enve_plus_nona, remote > 0),
                        control = state_control)

summary(eda_state_remote_repeat,
            pfootnote = TRUE)


# inperson_wocp

eda_state_inperson <- tableby(mkbin(inperson_wocp) ~ NOM_ENT,
                        data  = enve_plus_nona,
                        control = state_control)

summary(eda_state_inperson,
            pfootnote = TRUE)

# repeat inperson victims

eda_state_inp_repeat <- tableby(mkbin(inperson_wocp, 1) ~ NOM_ENT,
                        data  = subset(enve_plus_nona, inperson_wocp > 0),
                        control = state_control)

summary(eda_state_inp_repeat,
            pfootnote = TRUE)


# Piso victims

eda_state_piso <- tableby(mkbin(piso) ~ NOM_ENT,
                        data  = enve_plus_nona,
                        control = state_control)

summary(eda_state_piso,
            pfootnote = TRUE)

```

These descriptives should point out whether any state should be excluded from the random intercepts (complete separation by state).


#### Remote extortion models

General strategy for the models

- Incidence models first
    - NB vs Poisson (previous iterations suggest NB)
    - Multilevel vs single level (poisson and nb) (previous suggest multilevel better)
    - Test log(bribes) and poly(bribes, 2) as a sanity check


```{r remote-incidence-models}

rmt_f <- update(formula(nb_extortions), remote ~ . )

rmt_f <- update(rmt_f,  . ~ . - subsector_safe + subsector_new)

rmt_nb <- glmmTMB(rmt_f,
                    family = "nbinom2",
                    data = enve_plus_nona)

countsummary(rmt_nb)

### Compare Poisson

rmt_p <- update(rmt_nb, family = "poisson")

countsummary(rmt_p)

lrtest(rmt_p, rmt_nb)

AICtab(rmt_nb, rmt_p)
compare_estimates(rmt_nb, rmt_p)

### Test multilevel

rmt_mnb <- update(rmt_nb, . ~ . + (1|CVE_ENT))

countsummary(rmt_mnb)

lrtest(rmt_nb, rmt_mnb)

compare_estimates(rmt_mnb, rmt_nb)

AICtab(rmt_mnb, rmt_nb)

compare_alphas(rmt_mnb, rmt_nb)

## Multilevel poisson

rmt_mp <- update(rmt_mnb, family = "poisson")

countsummary(rmt_mp)

lrtest(rmt_mp, rmt_mnb)

lrtest(rmt_p, rmt_mp)

compare_estimates(rmt_mnb, rmt_mp)

AICtab(rmt_mnb, rmt_mp)


## Try different specification for bribes

rmt_nb_lb <- update(rmt_nb, . ~ . - bribes + mylog(bribes))

countsummary(rmt_nb_lb)

AICtab(rmt_nb, rmt_nb_lb)

compare_alphas(rmt_nb, rmt_nb_lb)

rmt_mnb_lb <- update(rmt_mnb, . ~ . - bribes + mylog(bribes))

countsummary(rmt_mnb_lb)

AICtab(rmt_mnb_lb, rmt_mnb)

# Polynomial bribes?

rmt_nb_pb <- update(rmt_nb, . ~ . - bribes + poly(bribes,2))

countsummary(rmt_nb_pb)

AICtab (rmt_nb_pb, rmt_nb, rmt_nb_lb)

compare_alphas(rmt_nb, rmt_nb_pb)


rmt_mnb_pb <- update(rmt_mnb, . ~ . - bribes + poly(bribes, 2))

countsummary(rmt_mnb_pb)

compare_alphas(rmt_mnb, rmt_mnb_pb)

AICtab(rmt_mnb, rmt_mnb_pb, rmt_mnb_lb)

```

Next:

- Prevalence models
    - Single level vs multilevel


```{r remote-prevalence-models}

rmt_logit <- update(rmt_nb, mkbin(remote) ~ . ,
                    family = "binomial")

countsummary(rmt_logit)

# multilevel

rmt_mlogit <- update(rmt_logit, . ~ . + (1|CVE_ENT))

countsummary(rmt_mlogit)

lrtest(rmt_logit, rmt_mlogit)

compare_estimates(rmt_logit, rmt_mlogit)

# bribes specifications

rmt_logit_lb <- update(rmt_logit, . ~ . - bribes + mylog(bribes))

countsummary(rmt_logit_lb)

AICtab(rmt_logit, rmt_logit_lb)

rmt_mlogit_lb <- update(rmt_mlogit, . ~ . - bribes + mylog(bribes))

countsummary(rmt_mlogit_lb)

AICtab(rmt_mlogit, rmt_mlogit_lb)

### Polynomial bribes

rmt_logit_pb <- update(rmt_logit, . ~ . - bribes + poly(bribes, 2))

countsummary(rmt_logit_pb)


AICtab(rmt_logit, rmt_logit_lb, rmt_logit_pb)

rmt_mlogit_pb <- update(rmt_mlogit, . ~ . - bribes + poly(bribes, 2))

countsummary(rmt_mlogit_pb)

AICtab(rmt_mlogit, rmt_mlogit_lb, rmt_mlogit_pb)

```


Now do the concentration models (truncated count models)

- Concentration models
    - tnb vs tp (previous suggest NB)
    - glmmADMB vs glmmTMB

```{r remote-concentration-models}

compare_nested <- function(...) {
    print(compare_estimates(...))
    print(compare_alphas(...))
    print(AICtab(...))
    print(lrtest(...))
}

#Start with Truncated Poisson

rmt_vic <-  subset(enve_plus_nona, remote > 0)

rmt_tp <- update(rmt_nb, family = "truncated_poisson",
                    data = rmt_vic)

countsummary(rmt_tp)

## truncated_negbin

rmt_tnb <- update(rmt_tp, family = "truncated_nbinom2")

countsummary(rmt_tnb)

compare_nested(rmt_tp, rmt_nb)

## Multilevel

rmt_mtp <- update(rmt_tp, . ~ . + (1|CVE_ENT))

countsummary(rmt_mtp)

compare_nested(rmt_tp, rmt_mtp)

## multilevel negative binomial

rmt_mtnb <- update(rmt_tp, . ~ . + (1|CVE_ENT),
    family = "truncated_nbinom2")

countsummary(rmt_mtnb)

compare_nested(rmt_mtp, rmt_mtnb)

compare_nested(rmt_tnb, rmt_mtnb)

### Bribe specifications

## add log bribes formula

add_lb <- . ~ . - bribes + mylog(bribes)

rmt_tnb_lb <- update(rmt_tnb, add_lb)

countsummary(rmt_tnb_lb)

AICtab(rmt_tnb, rmt_tnb_lb)

rmt_mtnb_lb <- update(rmt_mtnb, add_lb)

countsummary(rmt_mtnb_lb)

AICtab(rmt_mtnb, rmt_mtnb_lb)

## add bribe polynomial

add_pb <- . ~ . - bribes + poly(bribes, 2)

rmt_tnb_pb <- update(rmt_tnb, add_pb)

countsummary(rmt_tnb_pb)

AICtab(rmt_tnb, rmt_tnb_pb)

rmt_mtnb_pb <- update(rmt_mtnb, add_pb)

countsummary(rmt_mtnb_pb)

AICtab(rmt_mtnb, rmt_mtnb_pb)


#compare to glmmADMB

rmt_tp_admb <- glmmadmb(formula(rmt_tp),
                        family = "truncpoiss",
                        data = rmt_vic,
                        zeroInflation = FALSE,
                        admb.opts = glmmADMB::admbControl(noinit = FALSE, shess=FALSE), extra.args = "-ndi 60000")


countsummary(rmt_tp_admb)

compare_nested(rmt_tp, rmt_tp_admb)

## admb nbinom

rmt_tnb_admb <- update(rmt_tp_admb, family = "truncnbinom")

countsummary(rmt_tnb_admb)

compare_nested(rmt_tp_admb, rmt_tnb_admb)

compare_nested(rmt_tnb, rmt_tnb_admb)

## admb multilevel Truncated poisson

rmt_mtp_admb <- update(rmt_tp_admb, . ~ . + (1|NOM_ENT))

countsummary(rmt_mtp_admb)

compare_nested(rmt_tp_admb, rmt_mtp_admb)

## ADMB multielvel Truncated negbin

rmt_mtnb_admb <- update(rmt_tnb_admb, . ~ . + (1|NOM_ENT))

countsummary(rmt_mtnb_admb)

compare_nested(rmt_mtp_admb, rmt_mtnb_admb)

compare_nested(rmt_tnb_admb, rmt_mtnb_admb)

```



#### Inperson_wocp extortion models

General strategy for the models

- Incidence models first
    - NB vs Poisson (previous iterations suggest NB)
    - Multilevel vs single level (poisson and nb) (previous suggest multilevel better)
    - Test log(bribes) and poly(bribes, 2) as a sanity check

```{r in-person-incidence}


inp_f <- update(rmt_f, inperson_wocp ~ . )

inp_p <- glmmTMB(inp_f,
                    family = "poisson",
                    data = enve_plus_nona)

countsummary(inp_p)

### Compare Poisson

inp_nb <- update(inp_p, family = "nbinom2")

countsummary(inp_nb)

compare_nested(inp_p, inp_nb)

## Multilevel poisson

inp_mp <- update(inp_p, . ~ . + (1|CVE_ENT))

countsummary(inp_mp)

compare_nested(inp_p, inp_mp)

### Test nbinom multilevel

inp_mnb <- update(inp_mp, family = "nbinom2")

countsummary(inp_mnb)

compare_nested(inp_nb, inp_mnb)

compare_nested(inp_mp, inp_mnb)


## Try different specification for bribes

inp_nb_lb <- update(inp_nb, add_lb)

countsummary(inp_nb_lb)

AICtab(inp_nb, inp_nb_lb)

compare_alphas(inp_nb, inp_nb_lb)

inp_mnb_lb <- update(inp_mnb, add_lb)

countsummary(inp_mnb_lb)

AICtab(inp_mnb_lb, inp_mnb)

# Polynomial bribes?

inp_nb_pb <- update(inp_nb, add_pb)

countsummary(inp_nb_pb)

AICtab (inp_nb_pb, inp_nb, inp_nb_lb)

compare_alphas(inp_nb, inp_nb_pb)


inp_mnb_pb <- update(inp_mnb, add_pb)

countsummary(inp_mnb_pb)

compare_alphas(inp_mnb, inp_mnb_pb)

AICtab(inp_mnb, inp_mnb_pb, inp_mnb_lb)


```

- Prevalence models
    - Single level vs multilevel

```{r in-person-prevalence}


inp_logit <- update(inp_p, mkbin(inperson_wocp) ~ . ,
                    family = "binomial")

countsummary(inp_logit)

# multilevel

inp_mlogit <- update(inp_logit, . ~ . + (1|CVE_ENT))

countsummary(inp_mlogit)

compare_nested(inp_logit, inp_mlogit)



# bribes specifications

inp_logit_lb <- update(inp_logit, add_lb)

countsummary(inp_logit_lb)

AICtab(inp_logit, inp_logit_lb)

inp_mlogit_lb <- update(inp_mlogit, add_lb)

countsummary(inp_mlogit_lb)

AICtab(inp_mlogit, inp_mlogit_lb)

### Polynomial bribes

inp_logit_pb <- update(inp_logit, add_pb)

countsummary(inp_logit_pb)


AICtab(inp_logit, inp_logit_lb, inp_logit_pb)

inp_mlogit_pb <- update(inp_mlogit, add_pb)

countsummary(inp_mlogit_pb)

AICtab(inp_mlogit, inp_mlogit_lb, inp_mlogit_pb)


```

- Concentration models
    - tnb vs tp (previous suggest NB)
    - glmmADMB vs glmmTMB
    - multilevel specs

```{r in-person-concentration}

inp_vic <-  subset(enve_plus_nona, inperson_wocp > 0)

inp_tp <- update(inp_p, family = "truncated_poisson",
                    data = inp_vic)

countsummary(inp_tp)

## truncated_negbin

inp_tnb <- update(inp_tp, family = "truncated_nbinom2")

countsummary(inp_tnb)

compare_nested(inp_tp, inp_nb)

## Multilevel

inp_mtp <- update(inp_tp, . ~ . + (1|CVE_ENT))

countsummary(inp_mtp)

compare_nested(inp_tp, inp_mtp)

## multilevel negative binomial

inp_mtnb <- update(inp_tp, . ~ . + (1|CVE_ENT),
    family = "truncated_nbinom2")

countsummary(inp_mtnb)

compare_nested(inp_mtp, inp_mtnb)

compare_nested(inp_tnb, inp_mtnb)

### Bribe specifications

## add log bribes formula

inp_tnb_lb <- update(inp_tnb, add_lb)

countsummary(inp_tnb_lb)

AICtab(inp_tnb, inp_tnb_lb)

inp_mtnb_lb <- update(inp_mtnb, add_lb)

countsummary(inp_mtnb_lb)

AICtab(inp_mtnb, inp_mtnb_lb)

## add bribe polynomial

add_pb <- . ~ . - bribes + poly(bribes, 2)

inp_tnb_pb <- update(inp_tnb, add_pb)

countsummary(inp_tnb_pb)

AICtab(inp_tnb, inp_tnb_pb)

inp_mtnb_pb <- update(inp_mtnb, add_pb)

countsummary(inp_mtnb_pb)

AICtab(inp_mtnb, inp_mtnb_pb)


#compare to glmmADMB

inp_tp_admb <- glmmadmb(formula(inp_tp),
                        family = "truncpoiss",
                        data = inp_vic,
                        zeroInflation = FALSE,
                        admb.opts = glmmADMB::admbControl(noinit = FALSE, shess=FALSE), extra.args = "-ndi 60000")


countsummary(inp_tp_admb)

compare_nested(inp_tp, inp_tp_admb)

## admb nbinom

inp_tnb_admb <- update(inp_tp_admb, family = "truncnbinom")

countsummary(inp_tnb_admb)

compare_nested(inp_tp_admb, inp_tnb_admb)

compare_nested(inp_tnb, inp_tnb_admb)

## admb multilevel Truncated poisson

inp_mtp_admb <- update(inp_tp_admb, . ~ . + (1|NOM_ENT))

countsummary(inp_mtp_admb)

compare_nested(inp_tp_admb, inp_mtp_admb)

## ADMB multielvel Truncated negbin

inp_mtnb_admb <- update(inp_tnb_admb, . ~ . + (1|NOM_ENT))

countsummary(inp_mtnb_admb)

compare_nested(inp_mtp_admb, inp_mtnb_admb)

compare_nested(inp_tnb_admb, inp_mtnb_admb)


```


#### Piso extortion models

General strategy for the models

- Prevalence models
    - Single level vs multilevel


```{r piso-prevalence}


piso_logit <- update(inp_p, mkbin(piso) ~ . ,
                    family = "binomial")

countsummary(piso_logit)

# multilevel

piso_mlogit <- update(piso_logit, . ~ . + (1|CVE_ENT))

countsummary(piso_mlogit)

compare_nested(piso_logit, piso_mlogit)



# bribes specifications

piso_logit_lb <- update(piso_logit, add_lb)

countsummary(piso_logit_lb)

AICtab(piso_logit, piso_logit_lb)

piso_mlogit_lb <- update(piso_mlogit, add_lb)

countsummary(piso_mlogit_lb)

AICtab(piso_mlogit, piso_mlogit_lb)

### Polynomial bribes

piso_logit_pb <- update(piso_logit, add_pb)

countsummary(piso_logit_pb)


AICtab(piso_logit, piso_logit_lb, piso_logit_pb)

piso_mlogit_pb <- update(piso_mlogit, add_pb)

countsummary(piso_mlogit_pb)

AICtab(piso_mlogit, piso_mlogit_lb, piso_mlogit_pb)

```


# Event dependence study

Several things to improve over previous iteration.

Time course analysis:

- Distinguish by extortion type
- Control time-window effect by using only repeats that occurred the second semester
- Fit a smoother, possibly:
    - $E(y|x) = e^{\beta_0 + \beta_1 x}$

Do extensive EDA to understand if any variable has complete or quasi-complete separation (business and state level)

Modelling:

- Model extincs, remote, and inperson_wocp
    - Null vs Null + ED
    - Null vs Full
    - Full vs Full + ED
    - Test Poisson and NB
    - Test single level vs multilevel
    - Test whether capping adjustments are needed to ED
    - Use past compliance as ED IV
        - Maybe use categories: Not victimised, victimised but not complied, victim and complied


## Time course

In this section, the goal is to attempt to calculate the time-course of repeat victimisation. In essence, the time course is the time elapsed between victimisation events against the same target. The time course is most often presented as a distribution, similar to survival curves.

While I do not aim to build survival time-to-event models, it is a plausible alternative for future research, i.e. they could be used to understand the time-to-event curves for compliant vs non-compliant victims in a first event.

- Distinguish by extortion type
- Control time-window effect by using only repeats that occurred the second semester
- Fit a smoother, possibly:
    - $E(y|x) = e^{\beta_0 + \beta_1 x}$
- Calculate a victimisation time course for time since compliance
- Use prop for plots, it makes the curves comparable, and doesn't affect the fitting.


```{r time-course}

table(enve_nona$month, useNA = "ifany")

sum(table(enve_nona$month, useNA = "ifany"))


enve_nona %>%
    filter(month < 13) %>%
    #select(CVE_UNICA, month) %>%
    arrange(CVE_UNICA, month) -> id_mth

id_mth %>%
    group_by(CVE_UNICA) %>%
    mutate(lmonth = lag(month)) %>%
    drop_na %>%
    mutate(tc = month - lmonth) -> mth_tc

table(mth_tc$tc)

prop.table(table(mth_tc$tc))

# Calculate summary statistics for time course

mth_tc %>%
    ungroup %>%
    summarise(mean(tc),
              var(tc))



data.frame(table(mth_tc$tc)) %>%
    transmute(time = as.integer(as.character(Var1)),
                count = Freq,
                prop = count/sum(count)) -> tc_df

tc_df


tc_smooth_log <- glm(prop ~ time, data = tc_df,
                    family = gaussian(link = "log"))

summary(tc_smooth_log)

lrtest(tc_smooth_log)

## write a function to calculate the half-life
half_life <- function(model, hl = 0.50, ci = TRUE, ...){
    half_life <- log(hl)/coef(model)[2]
    results <- list(HL = half_life)
    if(ci){
        hl_ci <- log(hl)/confint(model, ...)[2,]
        results$CI <- hl_ci
    }
    return(results)
}


half_life(tc_smooth_log)

### Add model to ggplot functionise


(tc_df %>%
    ggplot(aes(time, prop)) +
    geom_smooth(aes(linetype = "Exponential"), colour = "black",
                method = "glm", se = FALSE,
                method.args = list(family = gaussian(link = "log"))) +
    geom_line(aes(linetype = "Observed"))  +
    theme_bw() +
    ggtitle("Time course of repeat extortion victimisation") +
    xlab("Months between repeat events") +
    ylab("Proportion") +
    theme(legend.title = element_blank(),
            legend.position = "bottom") -> tc1)

ggsave(tc1, filename = "time_course_full.pdf")


# Use filter to select second semester
### Correct for time window effect

mth_tc %>%
    filter(month > 5) %>%
    filter(tc < 7) %$%
    table(tc) %>%
    data.frame %>%
    transmute(time = as.integer(as.character(tc)),
                count = Freq,
                prop = count/sum(count)) -> tc_df_6m

tc_df_6m


### summary statistics

## all obs
mth_tc %>%
    ungroup %>%
    summarise(mean(tc),
              var(tc))

## Time window effect

mth_tc %>%
    ungroup %>%
    filter(month > 5) %>%
    filter(tc < 7) %>%
    summarise(mean(tc),
              var(tc))


tc_6m_smooth <- glm(prop ~ time, data = tc_df_6m,
                    family = gaussian(link = "log"))

summary(tc_6m_smooth)

lrtest(tc_6m_smooth)

half_life(tc_6m_smooth)



(tc_df_6m %>%
    ggplot(aes(time, prop)) +
    geom_smooth(aes(linetype = "Exponential"), colour = "black",
                method = "glm", se = FALSE,
                method.args = list(family = gaussian(link = "log"))) +
    geom_line(aes(linetype = "Observed"))  +
    theme_bw() +
    ggtitle("Time course of repeat extortion victimisation (6 month window)") +
    xlab("Months between repeat events") +
    ylab("Proportion") +
    theme(legend.title = element_blank(),
            legend.position = "bottom") -> tc2)

ggsave(tc2, file = "time_course_6m_window.pdf")
```


### Time course for remote extortions

To analyse the time course per event type, the TC column must be recalculated after subsetting events by type.


```{r time-course-remote}

# filter data set using the following
id_mth %>%
    filter(extortion_type_wocp == "Remote") %>%
    group_by(CVE_UNICA) %>%
    mutate(lmonth = lag(month)) %>%
    drop_na %>%
    mutate(tc = month - lmonth) -> tc_remote

### Calculate time courses using:

### Full period
tc_remote %$%
    table(tc) %>%
    data.frame %>%
    transmute(time = as.integer(as.character(tc)),
                count = Freq,
                prop = count/sum(count)) -> tc_remote_tb

tc_remote_tb


tc_remote_model <- glm(prop ~ time, data = tc_remote_tb,
                    family = gaussian(link = "log"))

summary(tc_remote_model)

lrtest(tc_remote_model)


half_life(tc_remote_model)


tc_remote_tb %>%
    ggplot(aes(time, prop)) +
    geom_smooth(aes(linetype = "Exponential"), colour = "black",
                method = "glm", se = FALSE,
                method.args = list(family = gaussian(link = "log"))) +
    geom_line(aes(linetype = "Observed"))  +
    theme_bw() +
    ggtitle("Time course of repeat remote extortion victimisation") +
    xlab("Months between repeat events") +
    ylab("Proportion") +
    theme(legend.title = element_blank(),
            legend.position = "bottom")




## 6m time window

tc_remote %>%
    filter(month > 5) %>%
    filter(tc < 7) %$%
    table(tc) %>%
    data.frame %>%
    transmute(time = as.integer(as.character(tc)),
                count = Freq,
                prop = count/sum(count)) -> tc_remote_6m_tb

tc_remote_6m_tb

tc_remote_model_6m <- glm(prop ~ time, data = tc_remote_6m_tb,
                    family = gaussian(link = "log"))

summary(tc_remote_model_6m)

lrtest(tc_remote_model_6m)


half_life(tc_remote_model_6m)


tc_remote_6m_tb %>%
    ggplot(aes(time, prop)) +
    geom_smooth(aes(linetype = "Exponential"), colour = "black",
                method = "glm", se = FALSE,
                method.args = list(family = gaussian(link = "log"))) +
    geom_line(aes(linetype = "Observed"))  +
    theme_bw() +
    ggtitle("Time course of repeat remote extortion victimisation \n(6 month time window)") +
    xlab("Months between repeat events") +
    ylab("Proportion") +
    theme(legend.title = element_blank(),
            legend.position = "bottom")


```


### Time course for in-person extortions

Now we estiamte the time course for in-persone extortions (excluding of course cobro de piso, as these do not have repeats).


```{r time-course-in-person}

# filter data set using the following

id_mth %>%
    filter(extortion_type_wocp == "In person") %>%
    group_by(CVE_UNICA) %>%
    mutate(lmonth = lag(month)) %>%
    drop_na %>%
    mutate(tc = month - lmonth) -> tc_inp

### Calculate time courses using:

### Full period
tc_inp %$%
    table(tc) %>%
    data.frame %>%
    transmute(time = as.integer(as.character(tc)),
                count = Freq,
                prop = count/sum(count)) -> tc_inp_tb

tc_inp_tb


tc_inp_model <- glm(prop ~ time, data = tc_inp_tb,
                    family = gaussian(link = "log"))

summary(tc_inp_model)

lrtest(tc_inp_model)


half_life(tc_inp_model)


tc_inp_tb %>%
    ggplot(aes(time, prop)) +
    geom_smooth(aes(linetype = "Exponential"), colour = "black",
                method = "glm", se = FALSE,
                method.args = list(family = gaussian(link = "log"))) +
    geom_line(aes(linetype = "Observed"))  +
    theme_bw() +
    ggtitle("Time course of repeat in-person extortion victimisation") +
    xlab("Months between repeat events") +
    ylab("Proportion") +
    theme(legend.title = element_blank(),
            legend.position = "bottom")




## 6m time window

tc_inp %>%
    filter(month > 5) %>%
    filter(tc < 7) %$%
    table(tc) %>%
    data.frame %>%
    transmute(time = as.integer(as.character(tc)),
                count = Freq,
                prop = count/sum(count)) -> tc_inp_6m_tb

tc_inp_6m_tb

tc_inp_model_6m <- glm(prop ~ time, data = tc_inp_6m_tb,
                    family = gaussian(link = "log"))

summary(tc_inp_model_6m)

lrtest(tc_inp_model_6m)


half_life(tc_inp_model_6m)


tc_inp_6m_tb %>%
    ggplot(aes(time, prop)) +
    geom_smooth(aes(linetype = "Exponential"), colour = "black",
                method = "glm", se = FALSE,
                method.args = list(family = gaussian(link = "log"))) +
    geom_line(aes(linetype = "Observed"))  +
    theme_bw() +
    ggtitle("Time course of repeat remote extortion victimisation \n(6 month time window)") +
    xlab("Months between repeat events") +
    ylab("Proportion") +
    theme(legend.title = element_blank(),
            legend.position = "bottom")


```


Generate a plot combining the time course of both types

```{r combined-time-course}


tc_remote_tb %>%
    mutate(Type = "Remote extortion") %>%
    bind_rows(mutate(tc_inp_tb, Type = "In-person extortion")) -> tc_both


(tc_both %>%
    ggplot(aes(time, prop)) +
    geom_smooth(aes(linetype = "Exponential"),
                method = "glm", se = FALSE,
                method.args = list(family = gaussian(link = "log"))) +
    geom_line(aes(linetype = "Observed"))  +
    theme_bw() +
    ggtitle("Time course of repeat extortion victimisation") +
    xlab("Months between repeat events") +
    ylab("Proportion") +
    theme(legend.title = element_blank(),
            legend.position = "bottom") +
    facet_wrap(~ Type) -> tc_both_p1)

ggsave(tc_both_p1, file = "tc_both_p1.pdf",
        width = 8, height = 4)

## using 6m time window

tc_remote_6m_tb %>%
    mutate(Type = "Remote extortion") %>%
    bind_rows(mutate(tc_inp_6m_tb, Type = "In-person extortion")) -> tc_both_6m


(tc_both_6m %>%
    ggplot(aes(time, prop)) +
    geom_smooth(aes(linetype = "Exponential"),
                method = "glm", se = FALSE,
                method.args = list(family = gaussian(link = "log"))) +
    geom_line(aes(linetype = "Observed"))  +
    theme_bw() +
    ggtitle("Time course of repeat extortion victimisation \n(6 month time window)") +
    xlab("Months between repeat events") +
    ylab("Proportion") +
    theme(legend.title = element_blank(),
            legend.position = "bottom") +
    facet_wrap(~ Type) -> tc_both_6m_p1)

ggsave(tc_both_6m_p1, file = "tc_both_6m_p1.pdf",
        width = 7, height = 4)

```

## Modelling event dependence

One option is to divide the extortion observation into at least two periods, e.g. first and second semester, and model the prevalence, incidence and concentration of extortion in the second semester, with the count for the previous semester as a covariate. This is simple, but has several limitations. If the time-course of repeat victimisation suggests a rapid decay in victimisation risk, then there will be very few businesses that faced victimisation the previous semester---event dependence won't be captured and will be a part of unobserved heterogeneity. Second, the lagged covariate will likely be correlated with the additional time-invariant covariates, which could bias the results. (Capping adjustments or categorical variables may mitigate this)

Another option is to build a longer panel and control for unit fixed effects, that way the time-invariant covariates would not be needed: they could be dropped. An additional advantage would be that this approach would be able to capture event dependence with a steeper decay function---capturing the effect of event dependence between months, instead of semesters. The `pglm` package could be used for panel logit and count models. A problem is that observations would very likely be serially correlated, and I am unsure if there are suitable methods to detect and correct serial correlation for negbin models. This approach could also magnify any measurement errors in the way event and month data is captured, which has not been fully examined. The longer the panel, the more error would be introduced as we would be synthetically creating a panel based on cross-sectional measurements.

For this exercise, I believe a two semester panel is a good compromise between the amount of error that is introduced and the explanatory power of the model.

Another complication is that as the data is capped, the number of observations in the lagged count is a function of the number of counts in the dependent variable (or in other extortion events). Thus the Event Dependence indicator should account for this and represent instead the number of incidents suffered over the maximum number of incidents that a unit could suffer--however, this might require dropping observations that reach the cap in semester 2 (that are incapable of suffering an event in semester 1 due to the amount of events suffered in semester 2).

Lastly, it would be particularly interesting to explore not only if the amount of victimisation suffered in the previous semester is a predictor, but also if complying with an event has implications for event dependence. A good approach to operationalise this would be using categorical variables (not a victim, victim did not comply, victim-complied).

### Data wrangling

Before the analysis, a data frame splitting the extortion counts by semester must be constructed.

Then select only observations from semester 2.

Models for lag dependence should exclude those observations where it is impossible to suffer extortions in one period because the cap is reached in one semester. These situations would occour if:

- extincs (in sem 2) is 7
- lag_extincs (in sem1) is 7

Previos itearations of the analysis suggest that there are some cases where this has happens.

In extincs there are 6 cases that are equal to 7, similarly there are 6 cases where lag_extincs is 7.


```{r semester-counts}

# Create a semester column

enve_nona %>%
    mutate(semester = ifelse(month < 7, 0,
                    ifelse(month > 12, 99, 1))) -> enve_mths_plus


enve_mths_plus %$%
    table(semester, useNA = "ifany")

# Identify CVE_UNICAS with no month

enve_mths_plus %>%
    filter(semester == 99) %$%
    unique(CVE_UNICA) -> non_month_cu

## Add semester as grouping factor

enve_mths_plus %>%
    group_by(CVE_UNICA, semester) %>%
    filter(semester != 99) %>%
    summarise(extincs = n(),
              complied = sum(complied_bin_NA == "Yes"),
              remote = sum(extortion_type == "Remote"),
              piso = sum(extortion_type == "Cobro de piso"),
              inperson = sum(extortion_type_wocp == "In person"),
              comp_remote  = sum(extortion_type_bin == "Remote" & complied_bin_NA == "Yes"),
              comp_inperson  = sum(extortion_type_wocp == "In person" & complied_bin_NA == "Yes")) %>%
              complete(CVE_UNICA,
                  semester = c(0,1)) %>%
              replace(is.na(.), 0) -> enve_bus_lev_semester

enve_bus_lev_semester %$%
    table(semester, useNA = "ifany")

enve_bus_lev_semester %$%
    CVE_UNICA %in% non_month_cu %>% table


enve_bus_lev %>%
    group_by(CVE_UNICA) %>%
    summarise(n = max(extincs)) %$% range(n)

enve_bus_lev_semester %>%
    group_by(CVE_UNICA, semester) %>%
    summarise(n = max(extincs)) %$% range(n)

### Merge with the enve_test data, keeping non victims as 0

enve_test %$%
    data.frame(CVE_UNICA = rep(CVE_UNICA, each = 2),
                semester = 0:1) -> enve_ids_semester

enve_test %>%
    left_join(enve_ids_semester, by = "CVE_UNICA") -> enve_plus_ids_sem

enve_plus_ids_sem %>%
    left_join(enve_bus_lev_semester) -> enve_plus_sem

enve_plus_sem %$%
    table(semester, useNA = "ifany")


enve_plus_sem %>%
    group_by(semester) %>%
    summarise(max(extincs))

enve_plus_sem %>%
    replace(is.na(.), 0) -> enve_sem_nona

enve_sem_nona %>%
    group_by(semester) %>%
    summarise(max(extincs))

nrow(enve_plus_sem)

nrow(enve_sem_nona)


## Add lagged columns for all capped counts

enve_sem_nona %>%
    group_by(CVE_UNICA) %>%
    mutate(lag_extincs = lag(extincs, order_by = semester),
            lag_remote = lag(remote, order_by = semester),
            lag_inperson = lag(inperson, order_by = semester),
            lag_piso = lag(piso, order_by = semester),
            lag_complied = lag(complied, order_by = semester),
            lag_comp_remote = lag(comp_remote, order_by = semester),
            lag_comp_inperson = lag(comp_inperson,
                order_by = semester)) -> enve_sem_lag


length(non_month_cu)

enve_sem_lag %>%
    filter(!CVE_UNICA %in% non_month_cu) -> enve_lag_nm

nrow(enve_lag_nm)

enve_sem_lag %$%
    table(extincs)

enve_lag_nm %$%
    table(extincs)

enve_sem_lag %$%
    table(remote)

enve_lag_nm %$%
    table(remote)

enve_sem_lag %$%
    table(inperson)

enve_lag_nm %$%
    table(inperson)

### select semester 2
# Exclude obs where Cap is reached one semester

enve_lag_nm %>%
    filter(semester > 0) %>%
    filter(extincs < 7) %>%
    filter(lag_extincs < 7) -> enve_lag_nm_sem1


enve_lag_nm_sem1 %$%
    table(extincs)

enve_lag_nm_sem1 %$%
    table(lag_extincs)

enve_lag_nm_sem1 %$%
    table(remote)

enve_lag_nm_sem1 %$%
    table(lag_remote)

enve_lag_nm_sem1 %$%
    table(inperson)

enve_lag_nm_sem1 %$%
    table(lag_inperson)

## Add subsector new category

enve_lag_nm_sem1$subsector_new <- enve_lag_nm_sem1$subsector

levels(enve_lag_nm_sem1$subsector_new) <- c('Retail',
                                        'HotelsRestBar',
                                        'Industry' ,
                                        'Industry',
                                        'Other serv.',
                                        'Other serv.',
                                        'Wholesale')


```

### EDA

Do extensive EDA to understand if any variable has complete or quasi-complete separation (business and state level)

Examine EDA (and models) from previous iterations see if some categories indicate complete or quasi-complete separation.


```{r semester-eda}

### For overall extortions first


ed_extincs_eda_f <- mkbin(extincs) ~ factor(mkbin(lag_extincs)) +
                                   factor(mkbin(lag_complied)) +
                                   bribes +
                                   yearsquant +
                                   size +
                                   subsector_new

ed_extincs_eda <- tableby(ed_extincs_eda_f,
                        data  = enve_lag_nm_sem1,
                        control = my_controls)

summary(ed_extincs_eda,
            pfootnote = TRUE)

## repeat extortions

ed_extincs_eda_f_repeats <- mkbin(extincs, 1) ~ factor(mkbin(lag_extincs)) +
                                   factor(mkbin(lag_complied)) +
                                   bribes +
                                   yearsquant +
                                   size +
                                   subsector_new

ed_extincs_eda_reps <- tableby(ed_extincs_eda_f_repeats,
                        data  = enve_lag_nm_sem1,
                        control = my_controls)

summary(ed_extincs_eda_reps,
            pfootnote = TRUE)


#### Remote extortions

ed_remote_eda_f <- mkbin(remote) ~ factor(mkbin(lag_remote)) +
                                   factor(mkbin(lag_comp_remote)) +
                                   bribes +
                                   yearsquant +
                                   size +
                                   subsector_new

ed_remote_eda <- tableby(ed_remote_eda_f,
                        data  = enve_lag_nm_sem1,
                        control = my_controls)

summary(ed_remote_eda,
            pfootnote = TRUE)

## repeat extortions

ed_remote_eda_f_repeats <- mkbin(remote, 1) ~ factor(mkbin(lag_remote)) +
                                   factor(mkbin(lag_comp_remote)) +
                                   bribes +
                                   yearsquant +
                                   size +
                                   subsector_new

ed_remote_eda_reps <- tableby(ed_remote_eda_f_repeats,
                        data  = enve_lag_nm_sem1,
                        control = my_controls)

summary(ed_remote_eda_reps,
            pfootnote = TRUE)

#### In person extortions

ed_inp_eda_f <- mkbin(inperson) ~ factor(mkbin(lag_inperson)) +
                                   factor(mkbin(lag_comp_inperson)) +
                                   bribes +
                                   yearsquant +
                                   size +
                                   subsector_new

ed_inp_eda <- tableby(ed_inp_eda_f,
                        data  = enve_lag_nm_sem1,
                        control = my_controls)

summary(ed_inp_eda,
            pfootnote = TRUE)

## repeat extortions

ed_inp_eda_f_repeats <- mkbin(inperson, 1) ~ factor(mkbin(lag_inperson)) +
                                   factor(mkbin(lag_comp_inperson)) +
                                   bribes +
                                   yearsquant +
                                   size +
                                   subsector_new

ed_inp_eda_reps <- tableby(ed_inp_eda_f_repeats,
                        data  = enve_lag_nm_sem1,
                        control = my_controls)

summary(ed_inp_eda_reps,
            pfootnote = TRUE)

```

EDA by state

```{r state-level-descriptives-event-dependence}


# State level prevalence

state_control <- tableby.control(cat.stats = "countrowpct",
                                total = FALSE,
                                test = FALSE)
# remote
eda_state_remote_ed <- tableby(mkbin(remote) ~ NOM_ENT,
                        data  = enve_lag_nm_sem1,
                        control = state_control)

summary(eda_state_remote_ed,
            pfootnote = TRUE)

# repeat remote victims

eda_state_remote_repeat_ed <- tableby(mkbin(remote, 1) ~ NOM_ENT,
                        data  = subset(enve_lag_nm_sem1, remote > 0),
                        control = state_control)

summary(eda_state_remote_repeat_ed,
            pfootnote = TRUE)


# inperson_wocp

eda_state_inperson_ed <- tableby(mkbin(inperson) ~ NOM_ENT,
                        data  = enve_lag_nm_sem1,
                        control = state_control)

summary(eda_state_inperson_ed,
            pfootnote = TRUE)

# repeat inperson victims

eda_state_inp_repeat_ed <- tableby(mkbin(inperson, 1) ~ NOM_ENT,
                        data  = subset(enve_lag_nm_sem1, inperson > 0),
                        control = state_control)

summary(eda_state_inp_repeat_ed,
            pfootnote = TRUE)


```

A revision of the results from previous iterations suggest that for inperson extortions, size medium + transport likely result in complete separation. Using the subsector_new category should avoid this.

Overall, it appears that glmmTMB models for truncated nb have trouble estimating the intercept, the same does not happen in truncated poisson models. However, it is likely that some of the categories will have very few observations for repeat inperson incidents.

### Modelling

Modelling:

- Model extincs, remote, and inperson_wocp
    - Null vs Null + ED
    - Null vs Full
    - Full vs Full + ED
    - Null + ED vs Full + ED
    - Test Poisson and NB
    - Test single level vs multilevel
    - Test whether capping adjustments are needed to ED
    - Use past compliance as ED IV
        - Maybe use categories: Not victimised, victimised but not complied, victim and complied

Generate a compliance categorical (Not victimised, victimised but not complied, complied)

```{r compliance-categorical}

case_compliance <- function(x, y){
    a <- case_when(
        x == 0          ~ "Not victim",
        x > 0 | y == 0  ~ "Victim, not comp.",
        y > 0           ~ "Complied"
    )
    factor(a, levels = c("Not victim", "Victim, not comp.", "Complied"))
}

enve_lag_nm_sem1 %>%
    mutate(
        lag_comp_cat = case_compliance(lag_extincs, lag_complied),
        lag_rmt_comp_cat = case_compliance(lag_remote, lag_comp_remote),
        lag_inp_comp_cat = case_compliance(lag_inperson, lag_comp_inperson)
    ) -> enve_lag_nm_sem1

enve_lag_nm_sem1 %$%
    table(lag_comp_cat)

enve_lag_nm_sem1 %$%
    table(lag_rmt_comp_cat)

enve_lag_nm_sem1 %$%
    table(lag_inp_comp_cat)

```

Also generate a numerical variable adjusting the lag value.

```{r lag-cap-adjusted}

enve_lag_nm_sem1 %>%
    mutate(
        lag_extincs_adj = capadjust(lag_extincs, extincs, 7),
        lag_rmt_adj = capadjust(lag_remote, extincs + lag_extincs - lag_remote, 7),
        lag_inp_adj = capadjust(lag_inperson, extincs + lag_extincs - lag_inperson, 7)
    ) -> enve_lag_nm_sem1


enve_lag_nm_sem1 %$%
    table(lag_extincs_adj)

enve_lag_nm_sem1 %$%
    table(lag_rmt_adj)

enve_lag_nm_sem1 %$%
    table(lag_inp_adj)

enve_lag_nm_sem1 %$%
    anyNA(lag_extincs_adj)

enve_lag_nm_sem1 %$%
    anyNA(lag_rmt_adj)

enve_lag_nm_sem1 %$%
    anyNA(lag_inp_adj)


enve_lag_nm_sem1 %$%
    any(is.infinite(lag_extincs_adj))

enve_lag_nm_sem1 %$%
    any(is.infinite(lag_rmt_adj))

enve_lag_nm_sem1 %$%
    any(is.infinite(lag_inp_adj))

## There should not be any infinites


```

EDA of the new variables

```{r eda-comp-cats}


comp_cat_extincs_eda <- tableby(mkbin(extincs) ~ lag_comp_cat,
                        data  = enve_lag_nm_sem1,
                        control = my_controls)

summary(comp_cat_extincs_eda,
            pfootnote = TRUE)

# Repeat extortions

comp_cat_extincs_eda_r <- tableby(mkbin(extincs, 1) ~ lag_comp_cat,
                        data  = enve_lag_nm_sem1,
                        control = my_controls)

summary(comp_cat_extincs_eda_r,
            pfootnote = TRUE)

# remote extortions

comp_cat_rmt_eda <- tableby(mkbin(remote) ~ lag_rmt_comp_cat,
                        data  = enve_lag_nm_sem1,
                        control = my_controls)

summary(comp_cat_rmt_eda,
            pfootnote = TRUE)

# repeat remote extortions

comp_cat_rmt_eda_r <- tableby(mkbin(remote, 1) ~ lag_rmt_comp_cat,
                        data  = enve_lag_nm_sem1,
                        control = my_controls)

summary(comp_cat_rmt_eda_r,
            pfootnote = TRUE)


# inperson extortions

comp_cat_inp_eda <- tableby(mkbin(inperson) ~ lag_inp_comp_cat,
                        data  = enve_lag_nm_sem1,
                        control = my_controls)

summary(comp_cat_inp_eda,
            pfootnote = TRUE)

# repeat inperson extortions

comp_cat_inp_eda_r <- tableby(mkbin(inperson, 1) ~ lag_inp_comp_cat,
                        data  = enve_lag_nm_sem1,
                        control = my_controls)

summary(comp_cat_inp_eda_r,
            pfootnote = TRUE)




```

```{r eda-adj-lag}


adj_lag_extincs_eda <- tableby(mkbin(extincs) ~ lag_extincs_adj,
                        data  = enve_lag_nm_sem1,
                        control = my_controls)

summary(adj_lag_extincs_eda,
            pfootnote = TRUE)

# Repeat extortions

adj_lag_extincs_eda_r <- tableby(mkbin(extincs, 1) ~ lag_extincs_adj,
                        data  = enve_lag_nm_sem1,
                        control = my_controls)

summary(adj_lag_extincs_eda_r,
            pfootnote = TRUE)

# remote extortions

adj_lag_rmt_eda <- tableby(mkbin(remote) ~ lag_rmt_adj,
                        data  = enve_lag_nm_sem1,
                        control = my_controls)

summary(adj_lag_rmt_eda,
            pfootnote = TRUE)

# repeat remote extortions

adj_lag_rmt_eda_r <- tableby(mkbin(remote, 1) ~ lag_rmt_adj,
                        data  = enve_lag_nm_sem1,
                        control = my_controls)

summary(adj_lag_rmt_eda_r,
            pfootnote = TRUE)


# inperson extortions

adj_lag_inp_eda <- tableby(mkbin(inperson) ~ lag_inp_adj,
                        data  = enve_lag_nm_sem1,
                        control = my_controls)

summary(adj_lag_inp_eda,
            pfootnote = TRUE)

# repeat inperson extortions

adj_lag_inp_eda_r <- tableby(mkbin(inperson, 1) ~ lag_inp_adj,
                        data  = enve_lag_nm_sem1,
                        control = my_controls)

summary(adj_lag_inp_eda_r,
            pfootnote = TRUE)




```

#### Extincs



```{r extincs-event-dependence-formulas}

# LHS extincs formula

extincs_null_f <- extincs ~ 1

# Write RHS formulas for easier coding

# Add event dependence formulas

add_extincs_lag <- . ~ . + lag_extincs

add_extincs_adj_lag <- . ~ . + lag_extincs_adj

add_extincs_binlag <- . ~ . + mkbin(lag_extincs)

### Compliance

add_ext_comp <- ~ + lag_comp_cat


# Risk heterogeneity
add_risk <- . ~ . + bribes +
                yearsquant +
                size +
                subsector_new +
                mylog(bribes_abvic, mean_bribes) +
                mylog(armas, mean_armas) +
                mylog(drogas, mean_drogas) +
                mylog(N, mean_N) +
                mylog(poblacion, mean_poblacion) +
                scale(General, mean_General, FALSE) +
                scale(Derecho, mean_Derecho, FALSE)

## Add random effects

add_cve <- . ~ . + (1|CVE_ENT)

add_nom <- . ~ . + (1|NOM_ENT)

```


```{r extincs-event-dependence-incidence}

## Use enve_lag_nm_sem1

#### First test event dependence versus a null model

extincs_ed_nb_null <- glmmTMB(extincs_null_f,
                             data = enve_lag_nm_sem1,
                             family = "nbinom2")

summary(extincs_ed_nb_null)

### Test event dependence term (then repeat for adjusted and compliance cats)

extincs_ed_nb_lag <- update(extincs_ed_nb_null, add_extincs_lag)

countsummary(extincs_ed_nb_lag)

compare_alphas(extincs_ed_nb_null, extincs_ed_nb_lag)

## Compare to poisson

extincs_ed_p_lag <- update(extincs_ed_nb_lag,
                           family = "poisson")

countsummary(extincs_ed_p_lag)

compare_nested(extincs_ed_p_lag, extincs_ed_nb_lag)

### Compare to multilevel

extincs_ed_mnb_lag <- update(extincs_ed_nb_lag, add_cve)

countsummary(extincs_ed_mnb_lag)

compare_nested(extincs_ed_nb_lag, extincs_ed_mnb_lag)

### compare to multilevel poisson

extincs_ed_mp_lag <- update(extincs_ed_p_lag, add_cve)

countsummary(extincs_ed_mp_lag)

compare_nested(extincs_ed_mp_lag, extincs_ed_mnb_lag)

compare_nested(extincs_ed_p_lag, extincs_ed_mp_lag)


### Add risk heterogeneity

extincs_ed_nb_risk <- update(extincs_ed_nb_null, add_risk)

countsummary(extincs_ed_nb_risk)

compare_alphas(extincs_ed_nb_null, extincs_ed_nb_risk)

# compare to poisson

extincs_ed_p_risk <- update(extincs_ed_nb_risk, family = "poisson")

lrtest(extincs_ed_p_risk, extincs_ed_nb_risk)

### Add lag and compare

extincs_ed_nb_risk_lag <- update(extincs_ed_nb_risk, add_extincs_lag)

countsummary(extincs_ed_nb_risk_lag)

### Compare adding lag to risk

lrtest(extincs_ed_nb_risk, extincs_ed_nb_risk_lag)
compare_alphas(extincs_ed_nb_risk, extincs_ed_nb_risk_lag)

## Compare adding risk to lag

lrtest(extincs_ed_nb_lag, extincs_ed_nb_risk_lag)
compare_alphas(extincs_ed_nb_lag, extincs_ed_nb_risk_lag)

## poisson risk lag

extincs_ed_p_risk_lag <- update(extincs_ed_nb_risk_lag,
                                family ="poisson")

countsummary(extincs_ed_p_risk_lag)
compare_nested(extincs_ed_p_risk_lag, extincs_ed_nb_risk_lag)

### Add multilevel

extincs_ed_mnb_risk <- update(extincs_ed_nb_risk, add_cve)

countsummary(extincs_ed_mnb_risk)

compare_nested(extincs_ed_nb_risk, extincs_ed_mnb_risk)

# multilevel poisson

extincs_ed_mp_risk <- update(extincs_ed_p_risk, add_cve)

countsummary(extincs_ed_mp_risk)

compare_nested(extincs_ed_mnb_risk, extincs_ed_mp_risk)

compare_nested(extincs_ed_p_risk, extincs_ed_mp_risk)

## add lag

extincs_ed_mnb_risk_lag <- update(extincs_ed_mnb_risk, add_extincs_lag)

countsummary(extincs_ed_mnb_risk_lag)

compare_nested(extincs_ed_nb_risk_lag, extincs_ed_mnb_risk_lag)

### Compare adding lag to risk

lrtest(extincs_ed_mnb_risk, extincs_ed_mnb_risk_lag)
compare_alphas(extincs_ed_mnb_risk, extincs_ed_mnb_risk_lag)

## Compare adding risk to lag

lrtest(extincs_ed_mnb_lag, extincs_ed_mnb_risk_lag)
compare_alphas(extincs_ed_mnb_lag, extincs_ed_mnb_risk_lag)

## m poisson risk lag

extincs_ed_mp_risk_lag <- update(extincs_ed_mnb_risk_lag,
                                family ="poisson")

countsummary(extincs_ed_mp_risk_lag)
compare_nested(extincs_ed_mp_risk_lag, extincs_ed_mnb_risk_lag)


####### Test event dependence term using adjusted rate #######

extincs_ed_nb_adj_lag <- update(extincs_ed_nb_null, add_extincs_adj_lag)

countsummary(extincs_ed_nb_adj_lag)

compare_alphas(extincs_ed_nb_null, extincs_ed_nb_adj_lag)

compare_alphas(extincs_ed_nb_lag, extincs_ed_nb_adj_lag)

## Compare to poisson

extincs_ed_p_adj_lag <- update(extincs_ed_nb_adj_lag,
                           family = "poisson")

countsummary(extincs_ed_p_adj_lag)

compare_nested(extincs_ed_p_adj_lag, extincs_ed_nb_adj_lag)

### Compare to multilevel

extincs_ed_mnb_adj_lag <- update(extincs_ed_nb_adj_lag, add_cve)

countsummary(extincs_ed_mnb_adj_lag)

compare_nested(extincs_ed_nb_adj_lag, extincs_ed_mnb_adj_lag)

compare_alphas(extincs_ed_mnb_lag, extincs_ed_mnb_adj_lag)
AICtab(extincs_ed_mnb_lag, extincs_ed_mnb_adj_lag)

### compare to multilevel poisson

extincs_ed_mp_adj_lag <- update(extincs_ed_p_adj_lag, add_cve)

countsummary(extincs_ed_mp_adj_lag)

compare_nested(extincs_ed_mp_adj_lag, extincs_ed_mnb_adj_lag)

compare_nested(extincs_ed_p_adj_lag, extincs_ed_mp_adj_lag)


### Add risk heterogeneity

extincs_ed_nb_risk <- update(extincs_ed_nb_null, add_risk)

countsummary(extincs_ed_nb_risk)

compare_alphas(extincs_ed_nb_null, extincs_ed_nb_risk)

# compare to poisson

extincs_ed_p_risk <- update(extincs_ed_nb_risk, family = "poisson")

lrtest(extincs_ed_p_risk, extincs_ed_nb_risk)

### Add lag and compare

extincs_ed_nb_risk_adj_lag <- update(extincs_ed_nb_risk, add_extincs_adj_lag)

countsummary(extincs_ed_nb_risk_adj_lag)

compare_alphas(extincs_ed_nb_risk_lag, extincs_ed_nb_risk_adj_lag)
AICtab(extincs_ed_nb_risk_lag, extincs_ed_nb_risk_adj_lag)

### Compare adding lag to risk

lrtest(extincs_ed_nb_risk, extincs_ed_nb_risk_adj_lag)
compare_alphas(extincs_ed_nb_risk, extincs_ed_nb_risk_adj_lag)

## Compare adding risk to lag

lrtest(extincs_ed_nb_adj_lag, extincs_ed_nb_risk_adj_lag)
compare_alphas(extincs_ed_nb_adj_lag, extincs_ed_nb_risk_adj_lag)

## poisson risk lag

extincs_ed_p_risk_adj_lag <- update(extincs_ed_nb_risk_adj_lag,
                                family ="poisson")

countsummary(extincs_ed_p_risk_adj_lag)
compare_nested(extincs_ed_p_risk_adj_lag, extincs_ed_nb_risk_adj_lag)

### Add multilevel

extincs_ed_mnb_risk <- update(extincs_ed_nb_risk, add_cve)

countsummary(extincs_ed_mnb_risk)

compare_nested(extincs_ed_nb_risk, extincs_ed_mnb_risk)

# multilevel poisson

extincs_ed_mp_risk <- update(extincs_ed_p_risk, add_cve)

countsummary(extincs_ed_mp_risk)

compare_nested(extincs_ed_mnb_risk, extincs_ed_mp_risk)

compare_nested(extincs_ed_p_risk, extincs_ed_mp_risk)

## add lag

extincs_ed_mnb_risk_adj_lag <- update(extincs_ed_mnb_risk, add_extincs_adj_lag)

countsummary(extincs_ed_mnb_risk_adj_lag)

compare_nested(extincs_ed_nb_risk_adj_lag, extincs_ed_mnb_risk_adj_lag)

compare_alphas(extincs_ed_mnb_risk_lag, extincs_ed_mnb_risk_adj_lag)
AICtab(extincs_ed_mnb_risk_lag, extincs_ed_mnb_risk_adj_lag)

### Compare adding lag to risk

lrtest(extincs_ed_mnb_risk, extincs_ed_mnb_risk_adj_lag)
compare_alphas(extincs_ed_mnb_risk, extincs_ed_mnb_risk_adj_lag)

## Compare adding risk to lag

lrtest(extincs_ed_mnb_adj_lag, extincs_ed_mnb_risk_adj_lag)
compare_alphas(extincs_ed_mnb_adj_lag, extincs_ed_mnb_risk_adj_lag)

## m poisson risk lag

extincs_ed_mp_risk_adj_lag <- update(extincs_ed_mnb_risk_adj_lag,
                                family ="poisson")

countsummary(extincs_ed_mp_risk_adj_lag)
compare_nested(extincs_ed_mp_risk_adj_lag, extincs_ed_mnb_risk_adj_lag)

####### Test event dependence term using compliance cats #######

extincs_ed_nb_ext_comp <- update(extincs_ed_nb_null, add_ext_comp)

countsummary(extincs_ed_nb_ext_comp)

compare_alphas(extincs_ed_nb_null, extincs_ed_nb_ext_comp)

compare_alphas(extincs_ed_nb_lag, extincs_ed_nb_ext_comp)

## Compare to poisson

extincs_ed_p_ext_comp <- update(extincs_ed_nb_ext_comp,
                           family = "poisson")

countsummary(extincs_ed_p_ext_comp)

compare_nested(extincs_ed_p_ext_comp, extincs_ed_nb_ext_comp)

### Compare to multilevel

extincs_ed_mnb_ext_comp <- update(extincs_ed_nb_ext_comp, add_cve)

countsummary(extincs_ed_mnb_ext_comp)

compare_nested(extincs_ed_nb_ext_comp, extincs_ed_mnb_ext_comp)

compare_alphas(extincs_ed_mnb_lag, extincs_ed_mnb_ext_comp)
AICtab(extincs_ed_mnb_lag, extincs_ed_mnb_ext_comp)

### compare to multilevel poisson

extincs_ed_mp_ext_comp <- update(extincs_ed_p_ext_comp, add_cve)

countsummary(extincs_ed_mp_ext_comp)

compare_nested(extincs_ed_mp_ext_comp, extincs_ed_mnb_ext_comp)

compare_nested(extincs_ed_p_ext_comp, extincs_ed_mp_ext_comp)


### Add risk heterogeneity

extincs_ed_nb_risk <- update(extincs_ed_nb_null, add_risk)

countsummary(extincs_ed_nb_risk)

compare_alphas(extincs_ed_nb_null, extincs_ed_nb_risk)

# compare to poisson

extincs_ed_p_risk <- update(extincs_ed_nb_risk, family = "poisson")

lrtest(extincs_ed_p_risk, extincs_ed_nb_risk)

### Add lag and compare

extincs_ed_nb_risk_ext_comp <- update(extincs_ed_nb_risk, add_ext_comp)

countsummary(extincs_ed_nb_risk_ext_comp)

compare_alphas(extincs_ed_nb_risk_lag, extincs_ed_nb_risk_ext_comp)
AICtab(extincs_ed_nb_risk_lag, extincs_ed_nb_risk_ext_comp)

### Compare adding lag to risk

lrtest(extincs_ed_nb_risk, extincs_ed_nb_risk_ext_comp)
compare_alphas(extincs_ed_nb_risk, extincs_ed_nb_risk_ext_comp)

## Compare adding risk to lag

lrtest(extincs_ed_nb_ext_comp, extincs_ed_nb_risk_ext_comp)
compare_alphas(extincs_ed_nb_ext_comp, extincs_ed_nb_risk_ext_comp)

## poisson risk lag

extincs_ed_p_risk_ext_comp <- update(extincs_ed_nb_risk_ext_comp,
                                family ="poisson")

countsummary(extincs_ed_p_risk_ext_comp)
compare_nested(extincs_ed_p_risk_ext_comp, extincs_ed_nb_risk_ext_comp)

### Add multilevel

extincs_ed_mnb_risk <- update(extincs_ed_nb_risk, add_cve)

countsummary(extincs_ed_mnb_risk)

compare_nested(extincs_ed_nb_risk, extincs_ed_mnb_risk)

# multilevel poisson

extincs_ed_mp_risk <- update(extincs_ed_p_risk, add_cve)

countsummary(extincs_ed_mp_risk)

compare_nested(extincs_ed_mnb_risk, extincs_ed_mp_risk)

compare_nested(extincs_ed_p_risk, extincs_ed_mp_risk)

## add lag

extincs_ed_mnb_risk_ext_comp <- update(extincs_ed_mnb_risk, add_ext_comp)

countsummary(extincs_ed_mnb_risk_ext_comp)

compare_nested(extincs_ed_nb_risk_ext_comp, extincs_ed_mnb_risk_ext_comp)

compare_alphas(extincs_ed_mnb_risk_lag, extincs_ed_mnb_risk_ext_comp)
AICtab(extincs_ed_mnb_risk_lag, extincs_ed_mnb_risk_ext_comp)

### Compare adding lag to risk

lrtest(extincs_ed_mnb_risk, extincs_ed_mnb_risk_ext_comp)
compare_alphas(extincs_ed_mnb_risk, extincs_ed_mnb_risk_ext_comp)

## Compare adding risk to lag

lrtest(extincs_ed_mnb_ext_comp, extincs_ed_mnb_risk_ext_comp)
compare_alphas(extincs_ed_mnb_ext_comp, extincs_ed_mnb_risk_ext_comp)

## m poisson risk lag

extincs_ed_mp_risk_ext_comp <- update(extincs_ed_mnb_risk_ext_comp,
                                family ="poisson")

countsummary(extincs_ed_mp_risk_ext_comp)
compare_nested(extincs_ed_mp_risk_ext_comp, extincs_ed_mnb_risk_ext_comp)

####### Test event dependence term using binary lag  #######

extincs_ed_nb_extincs_binlag <- update(extincs_ed_nb_null, add_extincs_binlag)

countsummary(extincs_ed_nb_extincs_binlag)

compare_alphas(extincs_ed_nb_null, extincs_ed_nb_extincs_binlag)

compare_alphas(extincs_ed_nb_lag, extincs_ed_nb_extincs_binlag)

## Compare to poisson

extincs_ed_p_extincs_binlag <- update(extincs_ed_nb_extincs_binlag,
                           family = "poisson")

countsummary(extincs_ed_p_extincs_binlag)

compare_nested(extincs_ed_p_extincs_binlag, extincs_ed_nb_extincs_binlag)

### Compare to multilevel

extincs_ed_mnb_extincs_binlag <- update(extincs_ed_nb_extincs_binlag, add_cve)

countsummary(extincs_ed_mnb_extincs_binlag)

compare_nested(extincs_ed_nb_extincs_binlag, extincs_ed_mnb_extincs_binlag)

compare_alphas(extincs_ed_mnb_lag, extincs_ed_mnb_extincs_binlag)
AICtab(extincs_ed_mnb_lag, extincs_ed_mnb_extincs_binlag)

### compare to multilevel poisson

extincs_ed_mp_extincs_binlag <- update(extincs_ed_p_extincs_binlag, add_cve)

countsummary(extincs_ed_mp_extincs_binlag)

compare_nested(extincs_ed_mp_extincs_binlag, extincs_ed_mnb_extincs_binlag)

compare_nested(extincs_ed_p_extincs_binlag, extincs_ed_mp_extincs_binlag)


### Add risk heterogeneity

extincs_ed_nb_risk <- update(extincs_ed_nb_null, add_risk)

countsummary(extincs_ed_nb_risk)

compare_alphas(extincs_ed_nb_null, extincs_ed_nb_risk)

# compare to poisson

extincs_ed_p_risk <- update(extincs_ed_nb_risk, family = "poisson")

lrtest(extincs_ed_p_risk, extincs_ed_nb_risk)

### Add lag and compare

extincs_ed_nb_risk_extincs_binlag <- update(extincs_ed_nb_risk, add_extincs_binlag)

countsummary(extincs_ed_nb_risk_extincs_binlag)

compare_alphas(extincs_ed_nb_risk_lag, extincs_ed_nb_risk_extincs_binlag)
AICtab(extincs_ed_nb_risk_lag, extincs_ed_nb_risk_extincs_binlag)

### Compare adding lag to risk

lrtest(extincs_ed_nb_risk, extincs_ed_nb_risk_extincs_binlag)
compare_alphas(extincs_ed_nb_risk, extincs_ed_nb_risk_extincs_binlag)

## Compare adding risk to lag

lrtest(extincs_ed_nb_extincs_binlag, extincs_ed_nb_risk_extincs_binlag)
compare_alphas(extincs_ed_nb_extincs_binlag, extincs_ed_nb_risk_extincs_binlag)

## poisson risk lag

extincs_ed_p_risk_extincs_binlag <- update(extincs_ed_nb_risk_extincs_binlag,
                                family ="poisson")

countsummary(extincs_ed_p_risk_extincs_binlag)
compare_nested(extincs_ed_p_risk_extincs_binlag, extincs_ed_nb_risk_extincs_binlag)

### Add multilevel

extincs_ed_mnb_risk <- update(extincs_ed_nb_risk, add_cve)

countsummary(extincs_ed_mnb_risk)

compare_nested(extincs_ed_nb_risk, extincs_ed_mnb_risk)

# multilevel poisson

extincs_ed_mp_risk <- update(extincs_ed_p_risk, add_cve)

countsummary(extincs_ed_mp_risk)

compare_nested(extincs_ed_mnb_risk, extincs_ed_mp_risk)

compare_nested(extincs_ed_p_risk, extincs_ed_mp_risk)

## add lag

extincs_ed_mnb_risk_extincs_binlag <- update(extincs_ed_mnb_risk, add_extincs_binlag)

countsummary(extincs_ed_mnb_risk_extincs_binlag)

compare_nested(extincs_ed_nb_risk_extincs_binlag, extincs_ed_mnb_risk_extincs_binlag)

compare_alphas(extincs_ed_mnb_risk_lag, extincs_ed_mnb_risk_extincs_binlag)
AICtab(extincs_ed_mnb_risk_lag, extincs_ed_mnb_risk_extincs_binlag)

### Compare adding lag to risk

lrtest(extincs_ed_mnb_risk, extincs_ed_mnb_risk_extincs_binlag)
compare_alphas(extincs_ed_mnb_risk, extincs_ed_mnb_risk_extincs_binlag)

## Compare adding risk to lag

lrtest(extincs_ed_mnb_extincs_binlag, extincs_ed_mnb_risk_extincs_binlag)
compare_alphas(extincs_ed_mnb_extincs_binlag, extincs_ed_mnb_risk_extincs_binlag)

## m poisson risk lag

extincs_ed_mp_risk_extincs_binlag <- update(extincs_ed_mnb_risk_extincs_binlag,
                                family ="poisson")

countsummary(extincs_ed_mp_risk_extincs_binlag)
compare_nested(extincs_ed_mp_risk_extincs_binlag, extincs_ed_mnb_risk_extincs_binlag)


```

Now estimate the effect of event dependence on prevalence.

```{r extincs-event-dependence-prevalence}


## Use enve_lag_nm_sem1

#### First test event dependence versus a null model

extincs_ed_logit_null <- update(extincs_ed_nb_null, mkbin(extincs) ~ .,
                                family = "binomial")

summary(extincs_ed_logit_null)

### Test event dependence term (then repeat for adjusted and compliance cats)

extincs_ed_logit_lag <- update(extincs_ed_logit_null, add_extincs_lag)

countsummary(extincs_ed_logit_lag)

compare_alphas(extincs_ed_logit_null, extincs_ed_logit_lag)


### Compare to multilevel

extincs_ed_mlogit_lag <- update(extincs_ed_logit_lag, add_cve)

countsummary(extincs_ed_mlogit_lag)

compare_nested(extincs_ed_logit_lag, extincs_ed_mlogit_lag)


### Add risk heterogeneity

extincs_ed_logit_risk <- update(extincs_ed_logit_null, add_risk)

countsummary(extincs_ed_logit_risk)

compare_alphas(extincs_ed_logit_null, extincs_ed_logit_risk)

### Add lag and compare

extincs_ed_logit_risk_lag <- update(extincs_ed_logit_risk, add_extincs_lag)

countsummary(extincs_ed_logit_risk_lag)

### Compare adding lag to risk

lrtest(extincs_ed_logit_risk, extincs_ed_logit_risk_lag)
compare_alphas(extincs_ed_logit_risk, extincs_ed_logit_risk_lag)

## Compare adding risk to lag

lrtest(extincs_ed_logit_lag, extincs_ed_logit_risk_lag)
compare_alphas(extincs_ed_logit_lag, extincs_ed_logit_risk_lag)


### Add multilevel

extincs_ed_mlogit_risk <- update(extincs_ed_logit_risk, add_cve)

countsummary(extincs_ed_mlogit_risk)

compare_nested(extincs_ed_logit_risk, extincs_ed_mlogit_risk)


## add lag

extincs_ed_mlogit_risk_lag <- update(extincs_ed_mlogit_risk, add_extincs_lag)

countsummary(extincs_ed_mlogit_risk_lag)

compare_nested(extincs_ed_logit_risk_lag, extincs_ed_mlogit_risk_lag)

### Compare adding lag to risk

lrtest(extincs_ed_mlogit_risk, extincs_ed_mlogit_risk_lag)
compare_alphas(extincs_ed_mlogit_risk, extincs_ed_mlogit_risk_lag)

## Compare adding risk to lag

lrtest(extincs_ed_mlogit_lag, extincs_ed_mlogit_risk_lag)
compare_alphas(extincs_ed_mlogit_lag, extincs_ed_mlogit_risk_lag)


####### Test event dependence term using adjusted rate #######

extincs_ed_logit_adj_lag <- update(extincs_ed_logit_null, add_extincs_adj_lag)

countsummary(extincs_ed_logit_adj_lag)

compare_alphas(extincs_ed_logit_null, extincs_ed_logit_adj_lag)

compare_alphas(extincs_ed_logit_lag, extincs_ed_logit_adj_lag)


### Compare to multilevel

extincs_ed_mlogit_adj_lag <- update(extincs_ed_logit_adj_lag, add_cve)

countsummary(extincs_ed_mlogit_adj_lag)

compare_nested(extincs_ed_logit_adj_lag, extincs_ed_mlogit_adj_lag)

compare_alphas(extincs_ed_mlogit_lag, extincs_ed_mlogit_adj_lag)
AICtab(extincs_ed_mlogit_lag, extincs_ed_mlogit_adj_lag)


### Add risk heterogeneity

extincs_ed_logit_risk <- update(extincs_ed_logit_null, add_risk)

countsummary(extincs_ed_logit_risk)

compare_alphas(extincs_ed_logit_null, extincs_ed_logit_risk)


### Add lag and compare

extincs_ed_logit_risk_adj_lag <- update(extincs_ed_logit_risk, add_extincs_adj_lag)

countsummary(extincs_ed_logit_risk_adj_lag)

compare_alphas(extincs_ed_logit_risk_lag, extincs_ed_logit_risk_adj_lag)
AICtab(extincs_ed_logit_risk_lag, extincs_ed_logit_risk_adj_lag)

### Compare adding lag to risk

lrtest(extincs_ed_logit_risk, extincs_ed_logit_risk_adj_lag)
compare_alphas(extincs_ed_logit_risk, extincs_ed_logit_risk_adj_lag)

## Compare adding risk to lag

lrtest(extincs_ed_logit_adj_lag, extincs_ed_logit_risk_adj_lag)
compare_alphas(extincs_ed_logit_adj_lag, extincs_ed_logit_risk_adj_lag)

### Add multilevel

extincs_ed_mlogit_risk <- update(extincs_ed_logit_risk, add_cve)

countsummary(extincs_ed_mlogit_risk)

compare_nested(extincs_ed_logit_risk, extincs_ed_mlogit_risk)

## add lag

extincs_ed_mlogit_risk_adj_lag <- update(extincs_ed_mlogit_risk, add_extincs_adj_lag)

countsummary(extincs_ed_mlogit_risk_adj_lag)

compare_nested(extincs_ed_logit_risk_adj_lag, extincs_ed_mlogit_risk_adj_lag)

compare_alphas(extincs_ed_mlogit_risk_lag, extincs_ed_mlogit_risk_adj_lag)
AICtab(extincs_ed_mlogit_risk_lag, extincs_ed_mlogit_risk_adj_lag)

### Compare adding lag to risk

lrtest(extincs_ed_mlogit_risk, extincs_ed_mlogit_risk_adj_lag)
compare_alphas(extincs_ed_mlogit_risk, extincs_ed_mlogit_risk_adj_lag)

## Compare adding risk to lag

lrtest(extincs_ed_mlogit_adj_lag, extincs_ed_mlogit_risk_adj_lag)
compare_alphas(extincs_ed_mlogit_adj_lag, extincs_ed_mlogit_risk_adj_lag)

####### Test event dependence term using compliance cats #######

extincs_ed_logit_ext_comp <- update(extincs_ed_logit_null, add_ext_comp)

countsummary(extincs_ed_logit_ext_comp)

compare_alphas(extincs_ed_logit_null, extincs_ed_logit_ext_comp)

compare_alphas(extincs_ed_logit_lag, extincs_ed_logit_ext_comp)

### Compare to multilevel

extincs_ed_mlogit_ext_comp <- update(extincs_ed_logit_ext_comp, add_cve)

countsummary(extincs_ed_mlogit_ext_comp)

compare_nested(extincs_ed_logit_ext_comp, extincs_ed_mlogit_ext_comp)

compare_alphas(extincs_ed_mlogit_lag, extincs_ed_mlogit_ext_comp)
AICtab(extincs_ed_mlogit_lag, extincs_ed_mlogit_ext_comp)


### Add risk heterogeneity

extincs_ed_logit_risk <- update(extincs_ed_logit_null, add_risk)

countsummary(extincs_ed_logit_risk)

compare_alphas(extincs_ed_logit_null, extincs_ed_logit_risk)

# compare to poisson

extincs_ed_p_risk <- update(extincs_ed_logit_risk, family = "poisson")

lrtest(extincs_ed_p_risk, extincs_ed_logit_risk)

### Add lag and compare

extincs_ed_logit_risk_ext_comp <- update(extincs_ed_logit_risk, add_ext_comp)

countsummary(extincs_ed_logit_risk_ext_comp)

compare_alphas(extincs_ed_logit_risk_lag, extincs_ed_logit_risk_ext_comp)
AICtab(extincs_ed_logit_risk_lag, extincs_ed_logit_risk_ext_comp)

### Compare adding lag to risk

lrtest(extincs_ed_logit_risk, extincs_ed_logit_risk_ext_comp)
compare_alphas(extincs_ed_logit_risk, extincs_ed_logit_risk_ext_comp)

## Compare adding risk to lag

lrtest(extincs_ed_logit_ext_comp, extincs_ed_logit_risk_ext_comp)
compare_alphas(extincs_ed_logit_ext_comp, extincs_ed_logit_risk_ext_comp)

### Add multilevel

extincs_ed_mlogit_risk <- update(extincs_ed_logit_risk, add_cve)

countsummary(extincs_ed_mlogit_risk)

compare_nested(extincs_ed_logit_risk, extincs_ed_mlogit_risk)

## add lag

extincs_ed_mlogit_risk_ext_comp <- update(extincs_ed_mlogit_risk, add_ext_comp)

countsummary(extincs_ed_mlogit_risk_ext_comp)

compare_nested(extincs_ed_logit_risk_ext_comp, extincs_ed_mlogit_risk_ext_comp)

compare_alphas(extincs_ed_mlogit_risk_lag, extincs_ed_mlogit_risk_ext_comp)
AICtab(extincs_ed_mlogit_risk_lag, extincs_ed_mlogit_risk_ext_comp)

### Compare adding lag to risk

lrtest(extincs_ed_mlogit_risk, extincs_ed_mlogit_risk_ext_comp)
compare_alphas(extincs_ed_mlogit_risk, extincs_ed_mlogit_risk_ext_comp)

## Compare adding risk to lag

lrtest(extincs_ed_mlogit_ext_comp, extincs_ed_mlogit_risk_ext_comp)
compare_alphas(extincs_ed_mlogit_ext_comp, extincs_ed_mlogit_risk_ext_comp)

####### Test event dependence term using binary lag #######

extincs_ed_logit_extincs_binlag <- update(extincs_ed_logit_null, add_extincs_binlag)

countsummary(extincs_ed_logit_extincs_binlag)

compare_alphas(extincs_ed_logit_null, extincs_ed_logit_extincs_binlag)

compare_alphas(extincs_ed_logit_lag, extincs_ed_logit_extincs_binlag)

### Compare to multilevel

extincs_ed_mlogit_extincs_binlag <- update(extincs_ed_logit_extincs_binlag, add_cve)

countsummary(extincs_ed_mlogit_extincs_binlag)

compare_nested(extincs_ed_logit_extincs_binlag, extincs_ed_mlogit_extincs_binlag)

compare_alphas(extincs_ed_mlogit_lag, extincs_ed_mlogit_extincs_binlag)
AICtab(extincs_ed_mlogit_lag, extincs_ed_mlogit_extincs_binlag)


### Add risk heterogeneity

extincs_ed_logit_risk <- update(extincs_ed_logit_null, add_risk)

countsummary(extincs_ed_logit_risk)

compare_alphas(extincs_ed_logit_null, extincs_ed_logit_risk)

# compare to poisson

extincs_ed_p_risk <- update(extincs_ed_logit_risk, family = "poisson")

lrtest(extincs_ed_p_risk, extincs_ed_logit_risk)

### Add lag and compare

extincs_ed_logit_risk_extincs_binlag <- update(extincs_ed_logit_risk, add_extincs_binlag)

countsummary(extincs_ed_logit_risk_extincs_binlag)

compare_alphas(extincs_ed_logit_risk_lag, extincs_ed_logit_risk_extincs_binlag)
AICtab(extincs_ed_logit_risk_lag, extincs_ed_logit_risk_extincs_binlag)

### Compare adding lag to risk

lrtest(extincs_ed_logit_risk, extincs_ed_logit_risk_extincs_binlag)
compare_alphas(extincs_ed_logit_risk, extincs_ed_logit_risk_extincs_binlag)

## Compare adding risk to lag

lrtest(extincs_ed_logit_extincs_binlag, extincs_ed_logit_risk_extincs_binlag)
compare_alphas(extincs_ed_logit_extincs_binlag, extincs_ed_logit_risk_extincs_binlag)

### Add multilevel

extincs_ed_mlogit_risk <- update(extincs_ed_logit_risk, add_cve)

countsummary(extincs_ed_mlogit_risk)

compare_nested(extincs_ed_logit_risk, extincs_ed_mlogit_risk)

## add lag

extincs_ed_mlogit_risk_extincs_binlag <- update(extincs_ed_mlogit_risk, add_extincs_binlag)

countsummary(extincs_ed_mlogit_risk_extincs_binlag)

compare_nested(extincs_ed_logit_risk_extincs_binlag, extincs_ed_mlogit_risk_extincs_binlag)

compare_alphas(extincs_ed_mlogit_risk_lag, extincs_ed_mlogit_risk_extincs_binlag)
AICtab(extincs_ed_mlogit_risk_lag, extincs_ed_mlogit_risk_extincs_binlag)

### Compare adding lag to risk

lrtest(extincs_ed_mlogit_risk, extincs_ed_mlogit_risk_extincs_binlag)
compare_alphas(extincs_ed_mlogit_risk, extincs_ed_mlogit_risk_extincs_binlag)

## Compare adding risk to lag

lrtest(extincs_ed_mlogit_extincs_binlag, extincs_ed_mlogit_risk_extincs_binlag)
compare_alphas(extincs_ed_mlogit_extincs_binlag, extincs_ed_mlogit_risk_extincs_binlag)

```

Next, estimate the effect of event dependence in the truncated count.

```{r extincs-event-dependence-concentration}


## Use enve_lag_nm_sem1

#### First test event dependence versus a null model

extincs_ed_tnb_null <- update(extincs_ed_nb_null,
                             data = subset(enve_lag_nm_sem1, extincs > 0),
                             family = "truncated_nbinom2")

summary(extincs_ed_tnb_null)

### Test event dependence term (then repeat for adjusted and compliance cats)

extincs_ed_tnb_lag <- update(extincs_ed_tnb_null, add_extincs_lag)

countsummary(extincs_ed_tnb_lag)

compare_alphas(extincs_ed_tnb_null, extincs_ed_tnb_lag)

## Compare to poisson

extincs_ed_tp_lag <- update(extincs_ed_tnb_lag,
                           family = "truncated_poisson")

countsummary(extincs_ed_tp_lag)

compare_nested(extincs_ed_tp_lag, extincs_ed_tnb_lag)

### Compare to multilevel

extincs_ed_mtnb_lag <- update(extincs_ed_tnb_lag, add_cve)

countsummary(extincs_ed_mtnb_lag)

compare_nested(extincs_ed_tnb_lag, extincs_ed_mtnb_lag)

### compare to multilevel poisson

extincs_ed_mtp_lag <- update(extincs_ed_tp_lag, add_cve)

countsummary(extincs_ed_mtp_lag)

compare_nested(extincs_ed_mtp_lag, extincs_ed_mtnb_lag)

compare_nested(extincs_ed_tp_lag, extincs_ed_mtp_lag)


### Add risk heterogeneity

extincs_ed_tnb_risk <- update(extincs_ed_tnb_null, add_risk)

countsummary(extincs_ed_tnb_risk)

compare_alphas(extincs_ed_tnb_null, extincs_ed_tnb_risk)

# compare to poisson

extincs_ed_tp_risk <- update(extincs_ed_tnb_risk, family = "truncated_poisson")

lrtest(extincs_ed_tp_risk, extincs_ed_tnb_risk)

### Add lag and compare

extincs_ed_tnb_risk_lag <- update(extincs_ed_tnb_risk, add_extincs_lag)

countsummary(extincs_ed_tnb_risk_lag)

### Compare adding lag to risk

lrtest(extincs_ed_tnb_risk, extincs_ed_tnb_risk_lag)
compare_alphas(extincs_ed_tnb_risk, extincs_ed_tnb_risk_lag)

## Compare adding risk to lag

lrtest(extincs_ed_tnb_lag, extincs_ed_tnb_risk_lag)
compare_alphas(extincs_ed_tnb_lag, extincs_ed_tnb_risk_lag)

## poisson risk lag

extincs_ed_tp_risk_lag <- update(extincs_ed_tnb_risk_lag,
                                family ="truncated_poisson")

countsummary(extincs_ed_tp_risk_lag)
compare_nested(extincs_ed_tp_risk_lag, extincs_ed_tnb_risk_lag)

### Add multilevel

extincs_ed_mtnb_risk <- update(extincs_ed_tnb_risk, add_cve)

countsummary(extincs_ed_mtnb_risk)

compare_nested(extincs_ed_tnb_risk, extincs_ed_mtnb_risk)

# multilevel poisson

extincs_ed_mtp_risk <- update(extincs_ed_tp_risk, add_cve)

countsummary(extincs_ed_mtp_risk)

compare_nested(extincs_ed_mtnb_risk, extincs_ed_mtp_risk)

compare_nested(extincs_ed_tp_risk, extincs_ed_mtp_risk)

## add lag

extincs_ed_mtnb_risk_lag <- update(extincs_ed_mtnb_risk, add_extincs_lag)

countsummary(extincs_ed_mtnb_risk_lag)

compare_nested(extincs_ed_tnb_risk_lag, extincs_ed_mtnb_risk_lag)

### Compare adding lag to risk

lrtest(extincs_ed_mtnb_risk, extincs_ed_mtnb_risk_lag)
compare_alphas(extincs_ed_mtnb_risk, extincs_ed_mtnb_risk_lag)

## Compare adding risk to lag

lrtest(extincs_ed_mtnb_lag, extincs_ed_mtnb_risk_lag)
compare_alphas(extincs_ed_mtnb_lag, extincs_ed_mtnb_risk_lag)

## m poisson risk lag

extincs_ed_mtp_risk_lag <- update(extincs_ed_mtnb_risk_lag,
                                family ="truncated_poisson")

countsummary(extincs_ed_mtp_risk_lag)
compare_nested(extincs_ed_mtp_risk_lag, extincs_ed_mtnb_risk_lag)


####### Test event dependence term using adjusted rate #######

extincs_ed_tnb_adj_lag <- update(extincs_ed_tnb_null, add_extincs_adj_lag)

countsummary(extincs_ed_tnb_adj_lag)

compare_alphas(extincs_ed_tnb_null, extincs_ed_tnb_adj_lag)

compare_alphas(extincs_ed_tnb_lag, extincs_ed_tnb_adj_lag)

## Compare to poisson

extincs_ed_tp_adj_lag <- update(extincs_ed_tnb_adj_lag,
                           family = "truncated_poisson")

countsummary(extincs_ed_tp_adj_lag)

compare_nested(extincs_ed_tp_adj_lag, extincs_ed_tnb_adj_lag)

### Compare to multilevel

extincs_ed_mtnb_adj_lag <- update(extincs_ed_tnb_adj_lag, add_cve)

countsummary(extincs_ed_mtnb_adj_lag)

compare_nested(extincs_ed_tnb_adj_lag, extincs_ed_mtnb_adj_lag)

compare_alphas(extincs_ed_mtnb_lag, extincs_ed_mtnb_adj_lag)
AICtab(extincs_ed_mtnb_lag, extincs_ed_mtnb_adj_lag)

### compare to multilevel poisson

extincs_ed_mtp_adj_lag <- update(extincs_ed_tp_adj_lag, add_cve)

countsummary(extincs_ed_mtp_adj_lag)

compare_nested(extincs_ed_mtp_adj_lag, extincs_ed_mtnb_adj_lag)

compare_nested(extincs_ed_tp_adj_lag, extincs_ed_mtp_adj_lag)


### Add risk heterogeneity

extincs_ed_tnb_risk <- update(extincs_ed_tnb_null, add_risk)

countsummary(extincs_ed_tnb_risk)

compare_alphas(extincs_ed_tnb_null, extincs_ed_tnb_risk)

# compare to poisson

extincs_ed_tp_risk <- update(extincs_ed_tnb_risk, family = "truncated_poisson")

lrtest(extincs_ed_tp_risk, extincs_ed_tnb_risk)

### Add lag and compare

extincs_ed_tnb_risk_adj_lag <- update(extincs_ed_tnb_risk, add_extincs_adj_lag)

countsummary(extincs_ed_tnb_risk_adj_lag)

compare_alphas(extincs_ed_tnb_risk_lag, extincs_ed_tnb_risk_adj_lag)
AICtab(extincs_ed_tnb_risk_lag, extincs_ed_tnb_risk_adj_lag)

### Compare adding lag to risk

lrtest(extincs_ed_tnb_risk, extincs_ed_tnb_risk_adj_lag)
compare_alphas(extincs_ed_tnb_risk, extincs_ed_tnb_risk_adj_lag)

## Compare adding risk to lag

lrtest(extincs_ed_tnb_adj_lag, extincs_ed_tnb_risk_adj_lag)
compare_alphas(extincs_ed_tnb_adj_lag, extincs_ed_tnb_risk_adj_lag)

## poisson risk lag

extincs_ed_tp_risk_adj_lag <- update(extincs_ed_tnb_risk_adj_lag,
                                family ="truncated_poisson")

countsummary(extincs_ed_tp_risk_adj_lag)
compare_nested(extincs_ed_tp_risk_adj_lag, extincs_ed_tnb_risk_adj_lag)

### Add multilevel

extincs_ed_mtnb_risk <- update(extincs_ed_tnb_risk, add_cve)

countsummary(extincs_ed_mtnb_risk)

compare_nested(extincs_ed_tnb_risk, extincs_ed_mtnb_risk)

# multilevel poisson

extincs_ed_mtp_risk <- update(extincs_ed_tp_risk, add_cve)

countsummary(extincs_ed_mtp_risk)

compare_nested(extincs_ed_mtnb_risk, extincs_ed_mtp_risk)

compare_nested(extincs_ed_tp_risk, extincs_ed_mtp_risk)

## add lag

extincs_ed_mtnb_risk_adj_lag <- update(extincs_ed_mtnb_risk, add_extincs_adj_lag)

countsummary(extincs_ed_mtnb_risk_adj_lag)

compare_nested(extincs_ed_tnb_risk_adj_lag, extincs_ed_mtnb_risk_adj_lag)

compare_alphas(extincs_ed_mtnb_risk_lag, extincs_ed_mtnb_risk_adj_lag)
AICtab(extincs_ed_mtnb_risk_lag, extincs_ed_mtnb_risk_adj_lag)

### Compare adding lag to risk

lrtest(extincs_ed_mtnb_risk, extincs_ed_mtnb_risk_adj_lag)
compare_alphas(extincs_ed_mtnb_risk, extincs_ed_mtnb_risk_adj_lag)

## Compare adding risk to lag

lrtest(extincs_ed_mtnb_adj_lag, extincs_ed_mtnb_risk_adj_lag)
compare_alphas(extincs_ed_mtnb_adj_lag, extincs_ed_mtnb_risk_adj_lag)

## m poisson risk lag

extincs_ed_mtp_risk_adj_lag <- update(extincs_ed_mtnb_risk_adj_lag,
                                family ="truncated_poisson")

countsummary(extincs_ed_mtp_risk_adj_lag)
compare_nested(extincs_ed_mtp_risk_adj_lag, extincs_ed_mtnb_risk_adj_lag)

####### Test event dependence term using compliance cats #######

extincs_ed_tnb_ext_comp <- update(extincs_ed_tnb_null, add_ext_comp)

countsummary(extincs_ed_tnb_ext_comp)

compare_alphas(extincs_ed_tnb_null, extincs_ed_tnb_ext_comp)

compare_alphas(extincs_ed_tnb_lag, extincs_ed_tnb_ext_comp)

## Compare to poisson

extincs_ed_tp_ext_comp <- update(extincs_ed_tnb_ext_comp,
                           family = "truncated_poisson")

countsummary(extincs_ed_tp_ext_comp)

compare_nested(extincs_ed_tp_ext_comp, extincs_ed_tnb_ext_comp)

### Compare to multilevel

extincs_ed_mtnb_ext_comp <- update(extincs_ed_tnb_ext_comp, add_cve)

countsummary(extincs_ed_mtnb_ext_comp)

compare_nested(extincs_ed_tnb_ext_comp, extincs_ed_mtnb_ext_comp)

compare_alphas(extincs_ed_mtnb_lag, extincs_ed_mtnb_ext_comp)
AICtab(extincs_ed_mtnb_lag, extincs_ed_mtnb_ext_comp)

### compare to multilevel poisson

extincs_ed_mtp_ext_comp <- update(extincs_ed_tp_ext_comp, add_cve)

countsummary(extincs_ed_mtp_ext_comp)

compare_nested(extincs_ed_mtp_ext_comp, extincs_ed_mtnb_ext_comp)

compare_nested(extincs_ed_tp_ext_comp, extincs_ed_mtp_ext_comp)


### Add risk heterogeneity

extincs_ed_tnb_risk <- update(extincs_ed_tnb_null, add_risk)

countsummary(extincs_ed_tnb_risk)

compare_alphas(extincs_ed_tnb_null, extincs_ed_tnb_risk)

# compare to poisson

extincs_ed_tp_risk <- update(extincs_ed_tnb_risk, family = "truncated_poisson")

lrtest(extincs_ed_tp_risk, extincs_ed_tnb_risk)

### Add lag and compare

extincs_ed_tnb_risk_ext_comp <- update(extincs_ed_tnb_risk, add_ext_comp)

countsummary(extincs_ed_tnb_risk_ext_comp)

compare_alphas(extincs_ed_tnb_risk_lag, extincs_ed_tnb_risk_ext_comp)
AICtab(extincs_ed_tnb_risk_lag, extincs_ed_tnb_risk_ext_comp)

### Compare adding lag to risk

lrtest(extincs_ed_tnb_risk, extincs_ed_tnb_risk_ext_comp)
compare_alphas(extincs_ed_tnb_risk, extincs_ed_tnb_risk_ext_comp)

## Compare adding risk to lag

lrtest(extincs_ed_tnb_ext_comp, extincs_ed_tnb_risk_ext_comp)
compare_alphas(extincs_ed_tnb_ext_comp, extincs_ed_tnb_risk_ext_comp)

## poisson risk lag

extincs_ed_tp_risk_ext_comp <- update(extincs_ed_tnb_risk_ext_comp,
                                family ="truncated_poisson")

countsummary(extincs_ed_tp_risk_ext_comp)
compare_nested(extincs_ed_tp_risk_ext_comp, extincs_ed_tnb_risk_ext_comp)

### Add multilevel

extincs_ed_mtnb_risk <- update(extincs_ed_tnb_risk, add_cve)

countsummary(extincs_ed_mtnb_risk)

compare_nested(extincs_ed_tnb_risk, extincs_ed_mtnb_risk)

# multilevel poisson

extincs_ed_mtp_risk <- update(extincs_ed_tp_risk, add_cve)

countsummary(extincs_ed_mtp_risk)

compare_nested(extincs_ed_mtnb_risk, extincs_ed_mtp_risk)

compare_nested(extincs_ed_tp_risk, extincs_ed_mtp_risk)

## add lag

extincs_ed_mtnb_risk_ext_comp <- update(extincs_ed_mtnb_risk, add_ext_comp)

countsummary(extincs_ed_mtnb_risk_ext_comp)

compare_nested(extincs_ed_tnb_risk_ext_comp, extincs_ed_mtnb_risk_ext_comp)

compare_alphas(extincs_ed_mtnb_risk_lag, extincs_ed_mtnb_risk_ext_comp)
AICtab(extincs_ed_mtnb_risk_lag, extincs_ed_mtnb_risk_ext_comp)

### Compare adding lag to risk

lrtest(extincs_ed_mtnb_risk, extincs_ed_mtnb_risk_ext_comp)
compare_alphas(extincs_ed_mtnb_risk, extincs_ed_mtnb_risk_ext_comp)

## Compare adding risk to lag

lrtest(extincs_ed_mtnb_ext_comp, extincs_ed_mtnb_risk_ext_comp)
compare_alphas(extincs_ed_mtnb_ext_comp, extincs_ed_mtnb_risk_ext_comp)

## m poisson risk lag

extincs_ed_mtp_risk_ext_comp <- update(extincs_ed_mtnb_risk_ext_comp,
                                family ="truncated_poisson")

countsummary(extincs_ed_mtp_risk_ext_comp)
compare_nested(extincs_ed_mtp_risk_ext_comp, extincs_ed_mtnb_risk_ext_comp)

####### Test event dependence term using binary lag #######

extincs_ed_tnb_extincs_binlag <- update(extincs_ed_tnb_null, add_extincs_binlag)

countsummary(extincs_ed_tnb_extincs_binlag)

compare_alphas(extincs_ed_tnb_null, extincs_ed_tnb_extincs_binlag)

compare_alphas(extincs_ed_tnb_lag, extincs_ed_tnb_extincs_binlag)

## Compare to poisson

extincs_ed_tp_extincs_binlag <- update(extincs_ed_tnb_extincs_binlag,
                           family = "truncated_poisson")

countsummary(extincs_ed_tp_extincs_binlag)

compare_nested(extincs_ed_tp_extincs_binlag, extincs_ed_tnb_extincs_binlag)

### Compare to multilevel

extincs_ed_mtnb_extincs_binlag <- update(extincs_ed_tnb_extincs_binlag, add_cve)

countsummary(extincs_ed_mtnb_extincs_binlag)

compare_nested(extincs_ed_tnb_extincs_binlag, extincs_ed_mtnb_extincs_binlag)

compare_alphas(extincs_ed_mtnb_lag, extincs_ed_mtnb_extincs_binlag)
AICtab(extincs_ed_mtnb_lag, extincs_ed_mtnb_extincs_binlag)

### compare to multilevel poisson

extincs_ed_mtp_extincs_binlag <- update(extincs_ed_tp_extincs_binlag, add_cve)

countsummary(extincs_ed_mtp_extincs_binlag)

compare_nested(extincs_ed_mtp_extincs_binlag, extincs_ed_mtnb_extincs_binlag)

compare_nested(extincs_ed_tp_extincs_binlag, extincs_ed_mtp_extincs_binlag)


### Add risk heterogeneity

extincs_ed_tnb_risk <- update(extincs_ed_tnb_null, add_risk)

countsummary(extincs_ed_tnb_risk)

compare_alphas(extincs_ed_tnb_null, extincs_ed_tnb_risk)

# compare to poisson

extincs_ed_tp_risk <- update(extincs_ed_tnb_risk, family = "truncated_poisson")

lrtest(extincs_ed_tp_risk, extincs_ed_tnb_risk)

### Add lag and compare

extincs_ed_tnb_risk_extincs_binlag <- update(extincs_ed_tnb_risk, add_extincs_binlag)

countsummary(extincs_ed_tnb_risk_extincs_binlag)

compare_alphas(extincs_ed_tnb_risk_lag, extincs_ed_tnb_risk_extincs_binlag)
AICtab(extincs_ed_tnb_risk_lag, extincs_ed_tnb_risk_extincs_binlag)

### Compare adding lag to risk

lrtest(extincs_ed_tnb_risk, extincs_ed_tnb_risk_extincs_binlag)
compare_alphas(extincs_ed_tnb_risk, extincs_ed_tnb_risk_extincs_binlag)

## Compare adding risk to lag

lrtest(extincs_ed_tnb_extincs_binlag, extincs_ed_tnb_risk_extincs_binlag)
compare_alphas(extincs_ed_tnb_extincs_binlag, extincs_ed_tnb_risk_extincs_binlag)

## poisson risk lag

extincs_ed_tp_risk_extincs_binlag <- update(extincs_ed_tnb_risk_extincs_binlag,
                                family ="truncated_poisson")

countsummary(extincs_ed_tp_risk_extincs_binlag)
compare_nested(extincs_ed_tp_risk_extincs_binlag, extincs_ed_tnb_risk_extincs_binlag)

### Add multilevel

extincs_ed_mtnb_risk <- update(extincs_ed_tnb_risk, add_cve)

countsummary(extincs_ed_mtnb_risk)

compare_nested(extincs_ed_tnb_risk, extincs_ed_mtnb_risk)

# multilevel poisson

extincs_ed_mtp_risk <- update(extincs_ed_tp_risk, add_cve)

countsummary(extincs_ed_mtp_risk)

compare_nested(extincs_ed_mtnb_risk, extincs_ed_mtp_risk)

compare_nested(extincs_ed_tp_risk, extincs_ed_mtp_risk)

## add lag

extincs_ed_mtnb_risk_extincs_binlag <- update(extincs_ed_mtnb_risk, add_extincs_binlag)

countsummary(extincs_ed_mtnb_risk_extincs_binlag)

compare_nested(extincs_ed_tnb_risk_extincs_binlag, extincs_ed_mtnb_risk_extincs_binlag)

compare_alphas(extincs_ed_mtnb_risk_lag, extincs_ed_mtnb_risk_extincs_binlag)
AICtab(extincs_ed_mtnb_risk_lag, extincs_ed_mtnb_risk_extincs_binlag)

### Compare adding lag to risk

lrtest(extincs_ed_mtnb_risk, extincs_ed_mtnb_risk_extincs_binlag)
compare_alphas(extincs_ed_mtnb_risk, extincs_ed_mtnb_risk_extincs_binlag)

## Compare adding risk to lag

lrtest(extincs_ed_mtnb_extincs_binlag, extincs_ed_mtnb_risk_extincs_binlag)
compare_alphas(extincs_ed_mtnb_extincs_binlag, extincs_ed_mtnb_risk_extincs_binlag)

## m poisson risk lag

extincs_ed_mtp_risk_extincs_binlag <- update(extincs_ed_mtnb_risk_extincs_binlag,
                                family ="truncated_poisson")

countsummary(extincs_ed_mtp_risk_extincs_binlag)
compare_nested(extincs_ed_mtp_risk_extincs_binlag, extincs_ed_mtnb_risk_extincs_binlag)




```


Repeat using glmmADMB

```{r extincs-event-dependence-concentration-glmmADMB}

## Use enve_lag_nm_sem1

#### First test event dependence versus a null model

extincs_admb_ed_tnb_null <- glmmadmb(formula(extincs_ed_tnb_null),
                             data = subset(enve_lag_nm_sem1, extincs > 0),
                             family = "truncnbinom",
                             zeroInflation = FALSE,
                             admb.opts = glmmADMB::admbControl(noinit = FALSE, shess=FALSE),
                             extra.args = "-ndi 60000")

summary(extincs_admb_ed_tnb_null)

### Test event dependence term (then repeat for adjusted and compliance cats)

extincs_admb_ed_tnb_lag <- update(extincs_admb_ed_tnb_null, add_extincs_lag)

countsummary(extincs_admb_ed_tnb_lag)

compare_alphas(extincs_admb_ed_tnb_null, extincs_admb_ed_tnb_lag)

## Compare to poisson

extincs_admb_ed_tp_lag <- update(extincs_admb_ed_tnb_lag,
                           family = "truncpoiss")

countsummary(extincs_admb_ed_tp_lag)

compare_nested(extincs_admb_ed_tp_lag, extincs_admb_ed_tnb_lag)

### Compare to multilevel

extincs_admb_ed_mtnb_lag <- update(extincs_admb_ed_tnb_lag, add_nom)

countsummary(extincs_admb_ed_mtnb_lag)

compare_nested(extincs_admb_ed_tnb_lag, extincs_admb_ed_mtnb_lag)

### compare to multilevel poisson

extincs_admb_ed_mtp_lag <- update(extincs_admb_ed_tp_lag, add_nom)

countsummary(extincs_admb_ed_mtp_lag)

compare_nested(extincs_admb_ed_mtp_lag, extincs_admb_ed_mtnb_lag)

compare_nested(extincs_admb_ed_tp_lag, extincs_admb_ed_mtp_lag)


### Add risk heterogeneity

extincs_admb_ed_tnb_risk <- update(extincs_admb_ed_tnb_null, add_risk)

countsummary(extincs_admb_ed_tnb_risk)

compare_alphas(extincs_admb_ed_tnb_null, extincs_admb_ed_tnb_risk)

# compare to poisson

extincs_admb_ed_tp_risk <- update(extincs_admb_ed_tnb_risk, family = "truncpoiss")

lrtest(extincs_admb_ed_tp_risk, extincs_admb_ed_tnb_risk)

### Add lag and compare

extincs_admb_ed_tnb_risk_lag <- update(extincs_admb_ed_tnb_risk, add_extincs_lag)

countsummary(extincs_admb_ed_tnb_risk_lag)

### Compare adding lag to risk

lrtest(extincs_admb_ed_tnb_risk, extincs_admb_ed_tnb_risk_lag)
compare_alphas(extincs_admb_ed_tnb_risk, extincs_admb_ed_tnb_risk_lag)

## Compare adding risk to lag

lrtest(extincs_admb_ed_tnb_lag, extincs_admb_ed_tnb_risk_lag)
compare_alphas(extincs_admb_ed_tnb_lag, extincs_admb_ed_tnb_risk_lag)

## poisson risk lag

extincs_admb_ed_tp_risk_lag <- update(extincs_admb_ed_tnb_risk_lag,
                                family ="truncpoiss")

countsummary(extincs_admb_ed_tp_risk_lag)
compare_nested(extincs_admb_ed_tp_risk_lag, extincs_admb_ed_tnb_risk_lag)

### Add multilevel

extincs_admb_ed_mtnb_risk <- update(extincs_admb_ed_tnb_risk, add_nom)

countsummary(extincs_admb_ed_mtnb_risk)

compare_nested(extincs_admb_ed_tnb_risk, extincs_admb_ed_mtnb_risk)

# multilevel poisson

extincs_admb_ed_mtp_risk <- update(extincs_admb_ed_tp_risk, add_nom)

countsummary(extincs_admb_ed_mtp_risk)

compare_nested(extincs_admb_ed_mtnb_risk, extincs_admb_ed_mtp_risk)

compare_nested(extincs_admb_ed_tp_risk, extincs_admb_ed_mtp_risk)

## add lag

extincs_admb_ed_mtnb_risk_lag <- update(extincs_admb_ed_mtnb_risk, add_extincs_lag)

countsummary(extincs_admb_ed_mtnb_risk_lag)

compare_nested(extincs_admb_ed_tnb_risk_lag, extincs_admb_ed_mtnb_risk_lag)

### Compare adding lag to risk

lrtest(extincs_admb_ed_mtnb_risk, extincs_admb_ed_mtnb_risk_lag)
compare_alphas(extincs_admb_ed_mtnb_risk, extincs_admb_ed_mtnb_risk_lag)

## Compare adding risk to lag

lrtest(extincs_admb_ed_mtnb_lag, extincs_admb_ed_mtnb_risk_lag)
compare_alphas(extincs_admb_ed_mtnb_lag, extincs_admb_ed_mtnb_risk_lag)

## m poisson risk lag

extincs_admb_ed_mtp_risk_lag <- update(extincs_admb_ed_mtnb_risk_lag,
                                family ="truncpoiss")

countsummary(extincs_admb_ed_mtp_risk_lag)
compare_nested(extincs_admb_ed_mtp_risk_lag, extincs_admb_ed_mtnb_risk_lag)


####### Test event dependence term using adjusted rate #######

extincs_admb_ed_tnb_adj_lag <- update(extincs_admb_ed_tnb_null, add_extincs_adj_lag)

countsummary(extincs_admb_ed_tnb_adj_lag)

compare_alphas(extincs_admb_ed_tnb_null, extincs_admb_ed_tnb_adj_lag)

compare_alphas(extincs_admb_ed_tnb_lag, extincs_admb_ed_tnb_adj_lag)

## Compare to poisson

extincs_admb_ed_tp_adj_lag <- update(extincs_admb_ed_tnb_adj_lag,
                           family = "truncpoiss")

countsummary(extincs_admb_ed_tp_adj_lag)

compare_nested(extincs_admb_ed_tp_adj_lag, extincs_admb_ed_tnb_adj_lag)

### Compare to multilevel

extincs_admb_ed_mtnb_adj_lag <- update(extincs_admb_ed_tnb_adj_lag, add_nom)

countsummary(extincs_admb_ed_mtnb_adj_lag)

compare_nested(extincs_admb_ed_tnb_adj_lag, extincs_admb_ed_mtnb_adj_lag)

compare_alphas(extincs_admb_ed_mtnb_lag, extincs_admb_ed_mtnb_adj_lag)
AICtab(extincs_admb_ed_mtnb_lag, extincs_admb_ed_mtnb_adj_lag)

### compare to multilevel poisson

extincs_admb_ed_mtp_adj_lag <- update(extincs_admb_ed_tp_adj_lag, add_nom)

countsummary(extincs_admb_ed_mtp_adj_lag)

compare_nested(extincs_admb_ed_mtp_adj_lag, extincs_admb_ed_mtnb_adj_lag)

compare_nested(extincs_admb_ed_tp_adj_lag, extincs_admb_ed_mtp_adj_lag)


### Add risk heterogeneity

extincs_admb_ed_tnb_risk <- update(extincs_admb_ed_tnb_null, add_risk)

countsummary(extincs_admb_ed_tnb_risk)

compare_alphas(extincs_admb_ed_tnb_null, extincs_admb_ed_tnb_risk)

# compare to poisson

extincs_admb_ed_tp_risk <- update(extincs_admb_ed_tnb_risk, family = "truncpoiss")

lrtest(extincs_admb_ed_tp_risk, extincs_admb_ed_tnb_risk)

### Add lag and compare

extincs_admb_ed_tnb_risk_adj_lag <- update(extincs_admb_ed_tnb_risk, add_extincs_adj_lag)

countsummary(extincs_admb_ed_tnb_risk_adj_lag)

compare_alphas(extincs_admb_ed_tnb_risk_lag, extincs_admb_ed_tnb_risk_adj_lag)
AICtab(extincs_admb_ed_tnb_risk_lag, extincs_admb_ed_tnb_risk_adj_lag)

### Compare adding lag to risk

lrtest(extincs_admb_ed_tnb_risk, extincs_admb_ed_tnb_risk_adj_lag)
compare_alphas(extincs_admb_ed_tnb_risk, extincs_admb_ed_tnb_risk_adj_lag)

## Compare adding risk to lag

lrtest(extincs_admb_ed_tnb_adj_lag, extincs_admb_ed_tnb_risk_adj_lag)
compare_alphas(extincs_admb_ed_tnb_adj_lag, extincs_admb_ed_tnb_risk_adj_lag)

## poisson risk lag

extincs_admb_ed_tp_risk_adj_lag <- update(extincs_admb_ed_tnb_risk_adj_lag,
                                family ="truncpoiss")

countsummary(extincs_admb_ed_tp_risk_adj_lag)
compare_nested(extincs_admb_ed_tp_risk_adj_lag, extincs_admb_ed_tnb_risk_adj_lag)

### Add multilevel

extincs_admb_ed_mtnb_risk <- update(extincs_admb_ed_tnb_risk, add_nom)

countsummary(extincs_admb_ed_mtnb_risk)

compare_nested(extincs_admb_ed_tnb_risk, extincs_admb_ed_mtnb_risk)

# multilevel poisson

extincs_admb_ed_mtp_risk <- update(extincs_admb_ed_tp_risk, add_nom)

countsummary(extincs_admb_ed_mtp_risk)

compare_nested(extincs_admb_ed_mtnb_risk, extincs_admb_ed_mtp_risk)

compare_nested(extincs_admb_ed_tp_risk, extincs_admb_ed_mtp_risk)

## add lag

extincs_admb_ed_mtnb_risk_adj_lag <- update(extincs_admb_ed_mtnb_risk, add_extincs_adj_lag)

countsummary(extincs_admb_ed_mtnb_risk_adj_lag)

compare_nested(extincs_admb_ed_tnb_risk_adj_lag, extincs_admb_ed_mtnb_risk_adj_lag)

compare_alphas(extincs_admb_ed_mtnb_risk_lag, extincs_admb_ed_mtnb_risk_adj_lag)
AICtab(extincs_admb_ed_mtnb_risk_lag, extincs_admb_ed_mtnb_risk_adj_lag)

### Compare adding lag to risk

lrtest(extincs_admb_ed_mtnb_risk, extincs_admb_ed_mtnb_risk_adj_lag)
compare_alphas(extincs_admb_ed_mtnb_risk, extincs_admb_ed_mtnb_risk_adj_lag)

## Compare adding risk to lag

lrtest(extincs_admb_ed_mtnb_adj_lag, extincs_admb_ed_mtnb_risk_adj_lag)
compare_alphas(extincs_admb_ed_mtnb_adj_lag, extincs_admb_ed_mtnb_risk_adj_lag)

## m poisson risk lag

extincs_admb_ed_mtp_risk_adj_lag <- update(extincs_admb_ed_mtnb_risk_adj_lag,
                                family ="truncpoiss")

countsummary(extincs_admb_ed_mtp_risk_adj_lag)
compare_nested(extincs_admb_ed_mtp_risk_adj_lag, extincs_admb_ed_mtnb_risk_adj_lag)

####### Test event dependence term using compliance cats #######

extincs_admb_ed_tnb_ext_comp <- update(extincs_admb_ed_tnb_null, add_ext_comp)

countsummary(extincs_admb_ed_tnb_ext_comp)

compare_alphas(extincs_admb_ed_tnb_null, extincs_admb_ed_tnb_ext_comp)

compare_alphas(extincs_admb_ed_tnb_lag, extincs_admb_ed_tnb_ext_comp)

## Compare to poisson

extincs_admb_ed_tp_ext_comp <- update(extincs_admb_ed_tnb_ext_comp,
                           family = "truncpoiss")

countsummary(extincs_admb_ed_tp_ext_comp)

compare_nested(extincs_admb_ed_tp_ext_comp, extincs_admb_ed_tnb_ext_comp)

### Compare to multilevel

extincs_admb_ed_mtnb_ext_comp <- update(extincs_admb_ed_tnb_ext_comp, add_nom)

countsummary(extincs_admb_ed_mtnb_ext_comp)

compare_nested(extincs_admb_ed_tnb_ext_comp, extincs_admb_ed_mtnb_ext_comp)

compare_alphas(extincs_admb_ed_mtnb_lag, extincs_admb_ed_mtnb_ext_comp)
AICtab(extincs_admb_ed_mtnb_lag, extincs_admb_ed_mtnb_ext_comp)

### compare to multilevel poisson

extincs_admb_ed_mtp_ext_comp <- update(extincs_admb_ed_tp_ext_comp, add_nom)

countsummary(extincs_admb_ed_mtp_ext_comp)

compare_nested(extincs_admb_ed_mtp_ext_comp, extincs_admb_ed_mtnb_ext_comp)

compare_nested(extincs_admb_ed_tp_ext_comp, extincs_admb_ed_mtp_ext_comp)


### Add risk heterogeneity

extincs_admb_ed_tnb_risk <- update(extincs_admb_ed_tnb_null, add_risk)

countsummary(extincs_admb_ed_tnb_risk)

compare_alphas(extincs_admb_ed_tnb_null, extincs_admb_ed_tnb_risk)

# compare to poisson

extincs_admb_ed_tp_risk <- update(extincs_admb_ed_tnb_risk, family = "truncpoiss")

lrtest(extincs_admb_ed_tp_risk, extincs_admb_ed_tnb_risk)

### Add lag and compare

extincs_admb_ed_tnb_risk_ext_comp <- update(extincs_admb_ed_tnb_risk, add_ext_comp)

countsummary(extincs_admb_ed_tnb_risk_ext_comp)

compare_alphas(extincs_admb_ed_tnb_risk_lag, extincs_admb_ed_tnb_risk_ext_comp)
AICtab(extincs_admb_ed_tnb_risk_lag, extincs_admb_ed_tnb_risk_ext_comp)

### Compare adding lag to risk

lrtest(extincs_admb_ed_tnb_risk, extincs_admb_ed_tnb_risk_ext_comp)
compare_alphas(extincs_admb_ed_tnb_risk, extincs_admb_ed_tnb_risk_ext_comp)

## Compare adding risk to lag

lrtest(extincs_admb_ed_tnb_ext_comp, extincs_admb_ed_tnb_risk_ext_comp)
compare_alphas(extincs_admb_ed_tnb_ext_comp, extincs_admb_ed_tnb_risk_ext_comp)

## poisson risk lag

extincs_admb_ed_tp_risk_ext_comp <- update(extincs_admb_ed_tnb_risk_ext_comp,
                                family ="truncpoiss")

countsummary(extincs_admb_ed_tp_risk_ext_comp)
compare_nested(extincs_admb_ed_tp_risk_ext_comp, extincs_admb_ed_tnb_risk_ext_comp)

### Add multilevel

extincs_admb_ed_mtnb_risk <- update(extincs_admb_ed_tnb_risk, add_nom)

countsummary(extincs_admb_ed_mtnb_risk)

compare_nested(extincs_admb_ed_tnb_risk, extincs_admb_ed_mtnb_risk)

# multilevel poisson

extincs_admb_ed_mtp_risk <- update(extincs_admb_ed_tp_risk, add_nom)

countsummary(extincs_admb_ed_mtp_risk)

compare_nested(extincs_admb_ed_mtnb_risk, extincs_admb_ed_mtp_risk)

compare_nested(extincs_admb_ed_tp_risk, extincs_admb_ed_mtp_risk)

## add lag

extincs_admb_ed_mtnb_risk_ext_comp <- update(extincs_admb_ed_mtnb_risk, add_ext_comp)

countsummary(extincs_admb_ed_mtnb_risk_ext_comp)

compare_nested(extincs_admb_ed_tnb_risk_ext_comp, extincs_admb_ed_mtnb_risk_ext_comp)

compare_alphas(extincs_admb_ed_mtnb_risk_lag, extincs_admb_ed_mtnb_risk_ext_comp)
AICtab(extincs_admb_ed_mtnb_risk_lag, extincs_admb_ed_mtnb_risk_ext_comp)

### Compare adding lag to risk

lrtest(extincs_admb_ed_mtnb_risk, extincs_admb_ed_mtnb_risk_ext_comp)
compare_alphas(extincs_admb_ed_mtnb_risk, extincs_admb_ed_mtnb_risk_ext_comp)

## Compare adding risk to lag

lrtest(extincs_admb_ed_mtnb_ext_comp, extincs_admb_ed_mtnb_risk_ext_comp)
compare_alphas(extincs_admb_ed_mtnb_ext_comp, extincs_admb_ed_mtnb_risk_ext_comp)

## m poisson risk lag

extincs_admb_ed_mtp_risk_ext_comp <- update(extincs_admb_ed_mtnb_risk_ext_comp,
                                family ="truncpoiss")

countsummary(extincs_admb_ed_mtp_risk_ext_comp)
compare_nested(extincs_admb_ed_mtp_risk_ext_comp, extincs_admb_ed_mtnb_risk_ext_comp)

####### Test event dependence term using binary lag #######

extincs_admb_ed_tnb_extincs_binlag <- update(extincs_admb_ed_tnb_null, add_extincs_binlag)

countsummary(extincs_admb_ed_tnb_extincs_binlag)

compare_alphas(extincs_admb_ed_tnb_null, extincs_admb_ed_tnb_extincs_binlag)

compare_alphas(extincs_admb_ed_tnb_lag, extincs_admb_ed_tnb_extincs_binlag)

## Compare to poisson

extincs_admb_ed_tp_extincs_binlag <- update(extincs_admb_ed_tnb_extincs_binlag,
                           family = "truncpoiss")

countsummary(extincs_admb_ed_tp_extincs_binlag)

compare_nested(extincs_admb_ed_tp_extincs_binlag, extincs_admb_ed_tnb_extincs_binlag)

### Compare to multilevel

extincs_admb_ed_mtnb_extincs_binlag <- update(extincs_admb_ed_tnb_extincs_binlag, add_nom)

countsummary(extincs_admb_ed_mtnb_extincs_binlag)

compare_nested(extincs_admb_ed_tnb_extincs_binlag, extincs_admb_ed_mtnb_extincs_binlag)

compare_alphas(extincs_admb_ed_mtnb_lag, extincs_admb_ed_mtnb_extincs_binlag)
AICtab(extincs_admb_ed_mtnb_lag, extincs_admb_ed_mtnb_extincs_binlag)

### compare to multilevel poisson

extincs_admb_ed_mtp_extincs_binlag <- update(extincs_admb_ed_tp_extincs_binlag, add_nom)

countsummary(extincs_admb_ed_mtp_extincs_binlag)

compare_nested(extincs_admb_ed_mtp_extincs_binlag, extincs_admb_ed_mtnb_extincs_binlag)

compare_nested(extincs_admb_ed_tp_extincs_binlag, extincs_admb_ed_mtp_extincs_binlag)


### Add risk heterogeneity

extincs_admb_ed_tnb_risk <- update(extincs_admb_ed_tnb_null, add_risk)

countsummary(extincs_admb_ed_tnb_risk)

compare_alphas(extincs_admb_ed_tnb_null, extincs_admb_ed_tnb_risk)

# compare to poisson

extincs_admb_ed_tp_risk <- update(extincs_admb_ed_tnb_risk, family = "truncpoiss")

lrtest(extincs_admb_ed_tp_risk, extincs_admb_ed_tnb_risk)

### Add lag and compare

extincs_admb_ed_tnb_risk_extincs_binlag <- update(extincs_admb_ed_tnb_risk, add_extincs_binlag)

countsummary(extincs_admb_ed_tnb_risk_extincs_binlag)

compare_alphas(extincs_admb_ed_tnb_risk_lag, extincs_admb_ed_tnb_risk_extincs_binlag)
AICtab(extincs_admb_ed_tnb_risk_lag, extincs_admb_ed_tnb_risk_extincs_binlag)

### Compare adding lag to risk

lrtest(extincs_admb_ed_tnb_risk, extincs_admb_ed_tnb_risk_extincs_binlag)
compare_alphas(extincs_admb_ed_tnb_risk, extincs_admb_ed_tnb_risk_extincs_binlag)

## Compare adding risk to lag

lrtest(extincs_admb_ed_tnb_extincs_binlag, extincs_admb_ed_tnb_risk_extincs_binlag)
compare_alphas(extincs_admb_ed_tnb_extincs_binlag, extincs_admb_ed_tnb_risk_extincs_binlag)

## poisson risk lag

extincs_admb_ed_tp_risk_extincs_binlag <- update(extincs_admb_ed_tnb_risk_extincs_binlag,
                                family ="truncpoiss")

countsummary(extincs_admb_ed_tp_risk_extincs_binlag)
compare_nested(extincs_admb_ed_tp_risk_extincs_binlag, extincs_admb_ed_tnb_risk_extincs_binlag)

### Add multilevel

extincs_admb_ed_mtnb_risk <- update(extincs_admb_ed_tnb_risk, add_nom)

countsummary(extincs_admb_ed_mtnb_risk)

compare_nested(extincs_admb_ed_tnb_risk, extincs_admb_ed_mtnb_risk)

# multilevel poisson

extincs_admb_ed_mtp_risk <- update(extincs_admb_ed_tp_risk, add_nom)

countsummary(extincs_admb_ed_mtp_risk)

compare_nested(extincs_admb_ed_mtnb_risk, extincs_admb_ed_mtp_risk)

compare_nested(extincs_admb_ed_tp_risk, extincs_admb_ed_mtp_risk)

## add lag

extincs_admb_ed_mtnb_risk_extincs_binlag <- update(extincs_admb_ed_mtnb_risk, add_extincs_binlag)

countsummary(extincs_admb_ed_mtnb_risk_extincs_binlag)

compare_nested(extincs_admb_ed_tnb_risk_extincs_binlag, extincs_admb_ed_mtnb_risk_extincs_binlag)

compare_alphas(extincs_admb_ed_mtnb_risk_lag, extincs_admb_ed_mtnb_risk_extincs_binlag)
AICtab(extincs_admb_ed_mtnb_risk_lag, extincs_admb_ed_mtnb_risk_extincs_binlag)

### Compare adding lag to risk

lrtest(extincs_admb_ed_mtnb_risk, extincs_admb_ed_mtnb_risk_extincs_binlag)
compare_alphas(extincs_admb_ed_mtnb_risk, extincs_admb_ed_mtnb_risk_extincs_binlag)

## Compare adding risk to lag

lrtest(extincs_admb_ed_mtnb_extincs_binlag, extincs_admb_ed_mtnb_risk_extincs_binlag)
compare_alphas(extincs_admb_ed_mtnb_extincs_binlag, extincs_admb_ed_mtnb_risk_extincs_binlag)

## m poisson risk lag

extincs_admb_ed_mtp_risk_extincs_binlag <- update(extincs_admb_ed_mtnb_risk_extincs_binlag,
                                family ="truncpoiss")

countsummary(extincs_admb_ed_mtp_risk_extincs_binlag)
compare_nested(extincs_admb_ed_mtp_risk_extincs_binlag, extincs_admb_ed_mtnb_risk_extincs_binlag)



```


#### Remote

Now repeat the analysis above for remote extortions.



```{r remote-event-dependence-formulas}

# LHS extincs formula

remote_null_f <- remote ~ 1

# Write RHS formulas for easier coding

# Add event dependence formulas

add_remote_lag <- . ~ . + lag_remote

add_remote_adj_lag <- . ~ . + lag_rmt_adj

add_remote_binlag <- . ~ . + mkbin(lag_remote)

### Compliance

add_remote_comp <- ~ + lag_rmt_comp_cat


```


```{r remote-event-dependence-incidence}

## Use enve_lag_nm_sem1

#### First test event dependence versus a null model

remote_ed_nb_null <- glmmTMB(remote_null_f,
                             data = enve_lag_nm_sem1,
                             family = "nbinom2")

summary(remote_ed_nb_null)

### Test event dependence term (then repeat for adjusted and compliance cats)

remote_ed_nb_lag <- update(remote_ed_nb_null, add_remote_lag)

countsummary(remote_ed_nb_lag)

compare_alphas(remote_ed_nb_null, remote_ed_nb_lag)

## Compare to poisson

remote_ed_p_lag <- update(remote_ed_nb_lag,
                           family = "poisson")

countsummary(remote_ed_p_lag)

compare_nested(remote_ed_p_lag, remote_ed_nb_lag)

### Compare to multilevel

remote_ed_mnb_lag <- update(remote_ed_nb_lag, add_cve)

countsummary(remote_ed_mnb_lag)

compare_nested(remote_ed_nb_lag, remote_ed_mnb_lag)

### compare to multilevel poisson

remote_ed_mp_lag <- update(remote_ed_p_lag, add_cve)

countsummary(remote_ed_mp_lag)

compare_nested(remote_ed_mp_lag, remote_ed_mnb_lag)

compare_nested(remote_ed_p_lag, remote_ed_mp_lag)


### Add risk heterogeneity

remote_ed_nb_risk <- update(remote_ed_nb_null, add_risk)

countsummary(remote_ed_nb_risk)

compare_alphas(remote_ed_nb_null, remote_ed_nb_risk)

# compare to poisson

remote_ed_p_risk <- update(remote_ed_nb_risk, family = "poisson")

lrtest(remote_ed_p_risk, remote_ed_nb_risk)

### Add lag and compare

remote_ed_nb_risk_lag <- update(remote_ed_nb_risk, add_remote_lag)

countsummary(remote_ed_nb_risk_lag)

### Compare adding lag to risk

lrtest(remote_ed_nb_risk, remote_ed_nb_risk_lag)
compare_alphas(remote_ed_nb_risk, remote_ed_nb_risk_lag)

## Compare adding risk to lag

lrtest(remote_ed_nb_lag, remote_ed_nb_risk_lag)
compare_alphas(remote_ed_nb_lag, remote_ed_nb_risk_lag)

## poisson risk lag

remote_ed_p_risk_lag <- update(remote_ed_nb_risk_lag,
                                family ="poisson")

countsummary(remote_ed_p_risk_lag)
compare_nested(remote_ed_p_risk_lag, remote_ed_nb_risk_lag)

### Add multilevel

remote_ed_mnb_risk <- update(remote_ed_nb_risk, add_cve)

countsummary(remote_ed_mnb_risk)

compare_nested(remote_ed_nb_risk, remote_ed_mnb_risk)

# multilevel poisson

remote_ed_mp_risk <- update(remote_ed_p_risk, add_cve)

countsummary(remote_ed_mp_risk)

compare_nested(remote_ed_mnb_risk, remote_ed_mp_risk)

compare_nested(remote_ed_p_risk, remote_ed_mp_risk)

## add lag

remote_ed_mnb_risk_lag <- update(remote_ed_mnb_risk, add_remote_lag)

countsummary(remote_ed_mnb_risk_lag)

compare_nested(remote_ed_nb_risk_lag, remote_ed_mnb_risk_lag)

### Compare adding lag to risk

lrtest(remote_ed_mnb_risk, remote_ed_mnb_risk_lag)
compare_alphas(remote_ed_mnb_risk, remote_ed_mnb_risk_lag)

## Compare adding risk to lag

lrtest(remote_ed_mnb_lag, remote_ed_mnb_risk_lag)
compare_alphas(remote_ed_mnb_lag, remote_ed_mnb_risk_lag)

## m poisson risk lag

remote_ed_mp_risk_lag <- update(remote_ed_mnb_risk_lag,
                                family ="poisson")

countsummary(remote_ed_mp_risk_lag)
compare_nested(remote_ed_mp_risk_lag, remote_ed_mnb_risk_lag)


####### Test event dependence term using adjusted rate #######

remote_ed_nb_adj_lag <- update(remote_ed_nb_null, add_remote_adj_lag)

countsummary(remote_ed_nb_adj_lag)

compare_alphas(remote_ed_nb_null, remote_ed_nb_adj_lag)

compare_alphas(remote_ed_nb_lag, remote_ed_nb_adj_lag)

## Compare to poisson

remote_ed_p_adj_lag <- update(remote_ed_nb_adj_lag,
                           family = "poisson")

countsummary(remote_ed_p_adj_lag)

compare_nested(remote_ed_p_adj_lag, remote_ed_nb_adj_lag)

### Compare to multilevel

remote_ed_mnb_adj_lag <- update(remote_ed_nb_adj_lag, add_cve)

countsummary(remote_ed_mnb_adj_lag)

compare_nested(remote_ed_nb_adj_lag, remote_ed_mnb_adj_lag)

compare_alphas(remote_ed_mnb_lag, remote_ed_mnb_adj_lag)
AICtab(remote_ed_mnb_lag, remote_ed_mnb_adj_lag)

### compare to multilevel poisson

remote_ed_mp_adj_lag <- update(remote_ed_p_adj_lag, add_cve)

countsummary(remote_ed_mp_adj_lag)

compare_nested(remote_ed_mp_adj_lag, remote_ed_mnb_adj_lag)

compare_nested(remote_ed_p_adj_lag, remote_ed_mp_adj_lag)


### Add risk heterogeneity

remote_ed_nb_risk <- update(remote_ed_nb_null, add_risk)

countsummary(remote_ed_nb_risk)

compare_alphas(remote_ed_nb_null, remote_ed_nb_risk)

# compare to poisson

remote_ed_p_risk <- update(remote_ed_nb_risk, family = "poisson")

lrtest(remote_ed_p_risk, remote_ed_nb_risk)

### Add lag and compare

remote_ed_nb_risk_adj_lag <- update(remote_ed_nb_risk, add_remote_adj_lag)

countsummary(remote_ed_nb_risk_adj_lag)

compare_alphas(remote_ed_nb_risk_lag, remote_ed_nb_risk_adj_lag)
AICtab(remote_ed_nb_risk_lag, remote_ed_nb_risk_adj_lag)

### Compare adding lag to risk

lrtest(remote_ed_nb_risk, remote_ed_nb_risk_adj_lag)
compare_alphas(remote_ed_nb_risk, remote_ed_nb_risk_adj_lag)

## Compare adding risk to lag

lrtest(remote_ed_nb_adj_lag, remote_ed_nb_risk_adj_lag)
compare_alphas(remote_ed_nb_adj_lag, remote_ed_nb_risk_adj_lag)

## poisson risk lag

remote_ed_p_risk_adj_lag <- update(remote_ed_nb_risk_adj_lag,
                                family ="poisson")

countsummary(remote_ed_p_risk_adj_lag)
compare_nested(remote_ed_p_risk_adj_lag, remote_ed_nb_risk_adj_lag)

### Add multilevel

remote_ed_mnb_risk <- update(remote_ed_nb_risk, add_cve)

countsummary(remote_ed_mnb_risk)

compare_nested(remote_ed_nb_risk, remote_ed_mnb_risk)

# multilevel poisson

remote_ed_mp_risk <- update(remote_ed_p_risk, add_cve)

countsummary(remote_ed_mp_risk)

compare_nested(remote_ed_mnb_risk, remote_ed_mp_risk)

compare_nested(remote_ed_p_risk, remote_ed_mp_risk)

## add lag

remote_ed_mnb_risk_adj_lag <- update(remote_ed_mnb_risk, add_remote_adj_lag)

countsummary(remote_ed_mnb_risk_adj_lag)

compare_nested(remote_ed_nb_risk_adj_lag, remote_ed_mnb_risk_adj_lag)

compare_alphas(remote_ed_mnb_risk_lag, remote_ed_mnb_risk_adj_lag)
AICtab(remote_ed_mnb_risk_lag, remote_ed_mnb_risk_adj_lag)

### Compare adding lag to risk

lrtest(remote_ed_mnb_risk, remote_ed_mnb_risk_adj_lag)
compare_alphas(remote_ed_mnb_risk, remote_ed_mnb_risk_adj_lag)

## Compare adding risk to lag

lrtest(remote_ed_mnb_adj_lag, remote_ed_mnb_risk_adj_lag)
compare_alphas(remote_ed_mnb_adj_lag, remote_ed_mnb_risk_adj_lag)

## m poisson risk lag

remote_ed_mp_risk_adj_lag <- update(remote_ed_mnb_risk_adj_lag,
                                family ="poisson")

countsummary(remote_ed_mp_risk_adj_lag)
compare_nested(remote_ed_mp_risk_adj_lag, remote_ed_mnb_risk_adj_lag)

####### Test event dependence term using compliance cats #######

remote_ed_nb_ext_comp <- update(remote_ed_nb_null, add_remote_comp)

countsummary(remote_ed_nb_ext_comp)

compare_alphas(remote_ed_nb_null, remote_ed_nb_ext_comp)

compare_alphas(remote_ed_nb_lag, remote_ed_nb_ext_comp)

## Compare to poisson

remote_ed_p_ext_comp <- update(remote_ed_nb_ext_comp,
                           family = "poisson")

countsummary(remote_ed_p_ext_comp)

compare_nested(remote_ed_p_ext_comp, remote_ed_nb_ext_comp)

### Compare to multilevel

remote_ed_mnb_ext_comp <- update(remote_ed_nb_ext_comp, add_cve)

countsummary(remote_ed_mnb_ext_comp)

compare_nested(remote_ed_nb_ext_comp, remote_ed_mnb_ext_comp)

compare_alphas(remote_ed_mnb_lag, remote_ed_mnb_ext_comp)
AICtab(remote_ed_mnb_lag, remote_ed_mnb_ext_comp)

### compare to multilevel poisson

remote_ed_mp_ext_comp <- update(remote_ed_p_ext_comp, add_cve)

countsummary(remote_ed_mp_ext_comp)

compare_nested(remote_ed_mp_ext_comp, remote_ed_mnb_ext_comp)

compare_nested(remote_ed_p_ext_comp, remote_ed_mp_ext_comp)


### Add risk heterogeneity

remote_ed_nb_risk <- update(remote_ed_nb_null, add_risk)

countsummary(remote_ed_nb_risk)

compare_alphas(remote_ed_nb_null, remote_ed_nb_risk)

# compare to poisson

remote_ed_p_risk <- update(remote_ed_nb_risk, family = "poisson")

lrtest(remote_ed_p_risk, remote_ed_nb_risk)

### Add lag and compare

remote_ed_nb_risk_ext_comp <- update(remote_ed_nb_risk, add_remote_comp)

countsummary(remote_ed_nb_risk_ext_comp)

compare_alphas(remote_ed_nb_risk_lag, remote_ed_nb_risk_ext_comp)
AICtab(remote_ed_nb_risk_lag, remote_ed_nb_risk_ext_comp)

### Compare adding lag to risk

lrtest(remote_ed_nb_risk, remote_ed_nb_risk_ext_comp)
compare_alphas(remote_ed_nb_risk, remote_ed_nb_risk_ext_comp)

## Compare adding risk to lag

lrtest(remote_ed_nb_ext_comp, remote_ed_nb_risk_ext_comp)
compare_alphas(remote_ed_nb_ext_comp, remote_ed_nb_risk_ext_comp)

## poisson risk lag

remote_ed_p_risk_ext_comp <- update(remote_ed_nb_risk_ext_comp,
                                family ="poisson")

countsummary(remote_ed_p_risk_ext_comp)
compare_nested(remote_ed_p_risk_ext_comp, remote_ed_nb_risk_ext_comp)

### Add multilevel

remote_ed_mnb_risk <- update(remote_ed_nb_risk, add_cve)

countsummary(remote_ed_mnb_risk)

compare_nested(remote_ed_nb_risk, remote_ed_mnb_risk)

# multilevel poisson

remote_ed_mp_risk <- update(remote_ed_p_risk, add_cve)

countsummary(remote_ed_mp_risk)

compare_nested(remote_ed_mnb_risk, remote_ed_mp_risk)

compare_nested(remote_ed_p_risk, remote_ed_mp_risk)

## add lag

remote_ed_mnb_risk_ext_comp <- update(remote_ed_mnb_risk, add_remote_comp)

countsummary(remote_ed_mnb_risk_ext_comp)

compare_nested(remote_ed_nb_risk_ext_comp, remote_ed_mnb_risk_ext_comp)

compare_alphas(remote_ed_mnb_risk_lag, remote_ed_mnb_risk_ext_comp)
AICtab(remote_ed_mnb_risk_lag, remote_ed_mnb_risk_ext_comp)

### Compare adding lag to risk

lrtest(remote_ed_mnb_risk, remote_ed_mnb_risk_ext_comp)
compare_alphas(remote_ed_mnb_risk, remote_ed_mnb_risk_ext_comp)

## Compare adding risk to lag

lrtest(remote_ed_mnb_ext_comp, remote_ed_mnb_risk_ext_comp)
compare_alphas(remote_ed_mnb_ext_comp, remote_ed_mnb_risk_ext_comp)

## m poisson risk lag

remote_ed_mp_risk_ext_comp <- update(remote_ed_mnb_risk_ext_comp,
                                family ="poisson")

countsummary(remote_ed_mp_risk_ext_comp)
compare_nested(remote_ed_mp_risk_ext_comp, remote_ed_mnb_risk_ext_comp)

####### Test event dependence term using binary lag #######

remote_ed_nb_binlag <- update(remote_ed_nb_null, add_remote_binlag)

countsummary(remote_ed_nb_binlag)

compare_alphas(remote_ed_nb_null, remote_ed_nb_binlag)

compare_alphas(remote_ed_nb_lag, remote_ed_nb_binlag)

## Compare to poisson

remote_ed_p_binlag <- update(remote_ed_nb_binlag,
                           family = "poisson")

countsummary(remote_ed_p_binlag)

compare_nested(remote_ed_p_binlag, remote_ed_nb_binlag)

### Compare to multilevel

remote_ed_mnb_binlag <- update(remote_ed_nb_binlag, add_cve)

countsummary(remote_ed_mnb_binlag)

compare_nested(remote_ed_nb_binlag, remote_ed_mnb_binlag)

compare_alphas(remote_ed_mnb_lag, remote_ed_mnb_binlag)
AICtab(remote_ed_mnb_lag, remote_ed_mnb_binlag)

### compare to multilevel poisson

remote_ed_mp_binlag <- update(remote_ed_p_binlag, add_cve)

countsummary(remote_ed_mp_binlag)

compare_nested(remote_ed_mp_binlag, remote_ed_mnb_binlag)

compare_nested(remote_ed_p_binlag, remote_ed_mp_binlag)


### Add risk heterogeneity

remote_ed_nb_risk <- update(remote_ed_nb_null, add_risk)

countsummary(remote_ed_nb_risk)

compare_alphas(remote_ed_nb_null, remote_ed_nb_risk)

# compare to poisson

remote_ed_p_risk <- update(remote_ed_nb_risk, family = "poisson")

lrtest(remote_ed_p_risk, remote_ed_nb_risk)

### Add lag and compare

remote_ed_nb_risk_binlag <- update(remote_ed_nb_risk, add_remote_binlag)

countsummary(remote_ed_nb_risk_binlag)

compare_alphas(remote_ed_nb_risk_lag, remote_ed_nb_risk_binlag)
AICtab(remote_ed_nb_risk_lag, remote_ed_nb_risk_binlag)

### Compare adding lag to risk

lrtest(remote_ed_nb_risk, remote_ed_nb_risk_binlag)
compare_alphas(remote_ed_nb_risk, remote_ed_nb_risk_binlag)

## Compare adding risk to lag

lrtest(remote_ed_nb_binlag, remote_ed_nb_risk_binlag)
compare_alphas(remote_ed_nb_binlag, remote_ed_nb_risk_binlag)

## poisson risk lag

remote_ed_p_risk_binlag <- update(remote_ed_nb_risk_binlag,
                                family ="poisson")

countsummary(remote_ed_p_risk_binlag)
compare_nested(remote_ed_p_risk_binlag, remote_ed_nb_risk_binlag)

### Add multilevel

remote_ed_mnb_risk <- update(remote_ed_nb_risk, add_cve)

countsummary(remote_ed_mnb_risk)

compare_nested(remote_ed_nb_risk, remote_ed_mnb_risk)

# multilevel poisson

remote_ed_mp_risk <- update(remote_ed_p_risk, add_cve)

countsummary(remote_ed_mp_risk)

compare_nested(remote_ed_mnb_risk, remote_ed_mp_risk)

compare_nested(remote_ed_p_risk, remote_ed_mp_risk)

## add lag

remote_ed_mnb_risk_binlag <- update(remote_ed_mnb_risk, add_remote_binlag)

countsummary(remote_ed_mnb_risk_binlag)

compare_nested(remote_ed_nb_risk_binlag, remote_ed_mnb_risk_binlag)

compare_alphas(remote_ed_mnb_risk_lag, remote_ed_mnb_risk_binlag)
AICtab(remote_ed_mnb_risk_lag, remote_ed_mnb_risk_binlag)

### Compare adding lag to risk

lrtest(remote_ed_mnb_risk, remote_ed_mnb_risk_binlag)
compare_alphas(remote_ed_mnb_risk, remote_ed_mnb_risk_binlag)

## Compare adding risk to lag

lrtest(remote_ed_mnb_binlag, remote_ed_mnb_risk_binlag)
compare_alphas(remote_ed_mnb_binlag, remote_ed_mnb_risk_binlag)

## m poisson risk lag

remote_ed_mp_risk_binlag <- update(remote_ed_mnb_risk_binlag,
                                family ="poisson")

countsummary(remote_ed_mp_risk_binlag)
compare_nested(remote_ed_mp_risk_binlag, remote_ed_mnb_risk_binlag)

```

Now estimate the effect of event dependence on prevalence.

```{r remote-event-dependence-prevalence}


## Use enve_lag_nm_sem1

#### First test event dependence versus a null model

remote_ed_logit_null <- update(remote_ed_nb_null, mkbin(remote) ~ .,
                                family = "binomial")

summary(remote_ed_logit_null)

### Test event dependence term (then repeat for adjusted and compliance cats)

remote_ed_logit_lag <- update(remote_ed_logit_null, add_remote_lag)

countsummary(remote_ed_logit_lag)

compare_alphas(remote_ed_logit_null, remote_ed_logit_lag)


### Compare to multilevel

remote_ed_mlogit_lag <- update(remote_ed_logit_lag, add_cve)

countsummary(remote_ed_mlogit_lag)

compare_nested(remote_ed_logit_lag, remote_ed_mlogit_lag)


### Add risk heterogeneity

remote_ed_logit_risk <- update(remote_ed_logit_null, add_risk)

countsummary(remote_ed_logit_risk)

compare_alphas(remote_ed_logit_null, remote_ed_logit_risk)

### Add lag and compare

remote_ed_logit_risk_lag <- update(remote_ed_logit_risk, add_remote_lag)

countsummary(remote_ed_logit_risk_lag)

### Compare adding lag to risk

lrtest(remote_ed_logit_risk, remote_ed_logit_risk_lag)
compare_alphas(remote_ed_logit_risk, remote_ed_logit_risk_lag)

## Compare adding risk to lag

lrtest(remote_ed_logit_lag, remote_ed_logit_risk_lag)
compare_alphas(remote_ed_logit_lag, remote_ed_logit_risk_lag)


### Add multilevel

remote_ed_mlogit_risk <- update(remote_ed_logit_risk, add_cve)

countsummary(remote_ed_mlogit_risk)

compare_nested(remote_ed_logit_risk, remote_ed_mlogit_risk)


## add lag

remote_ed_mlogit_risk_lag <- update(remote_ed_mlogit_risk, add_remote_lag)

countsummary(remote_ed_mlogit_risk_lag)

compare_nested(remote_ed_logit_risk_lag, remote_ed_mlogit_risk_lag)

### Compare adding lag to risk

lrtest(remote_ed_mlogit_risk, remote_ed_mlogit_risk_lag)
compare_alphas(remote_ed_mlogit_risk, remote_ed_mlogit_risk_lag)

## Compare adding risk to lag

lrtest(remote_ed_mlogit_lag, remote_ed_mlogit_risk_lag)
compare_alphas(remote_ed_mlogit_lag, remote_ed_mlogit_risk_lag)


####### Test event dependence term using adjusted rate #######

remote_ed_logit_adj_lag <- update(remote_ed_logit_null, add_remote_adj_lag)

countsummary(remote_ed_logit_adj_lag)

compare_alphas(remote_ed_logit_null, remote_ed_logit_adj_lag)

compare_alphas(remote_ed_logit_lag, remote_ed_logit_adj_lag)


### Compare to multilevel

remote_ed_mlogit_adj_lag <- update(remote_ed_logit_adj_lag, add_cve)

countsummary(remote_ed_mlogit_adj_lag)

compare_nested(remote_ed_logit_adj_lag, remote_ed_mlogit_adj_lag)

compare_alphas(remote_ed_mlogit_lag, remote_ed_mlogit_adj_lag)
AICtab(remote_ed_mlogit_lag, remote_ed_mlogit_adj_lag)


### Add risk heterogeneity

remote_ed_logit_risk <- update(remote_ed_logit_null, add_risk)

countsummary(remote_ed_logit_risk)

compare_alphas(remote_ed_logit_null, remote_ed_logit_risk)


### Add lag and compare

remote_ed_logit_risk_adj_lag <- update(remote_ed_logit_risk, add_remote_adj_lag)

countsummary(remote_ed_logit_risk_adj_lag)

compare_alphas(remote_ed_logit_risk_lag, remote_ed_logit_risk_adj_lag)
AICtab(remote_ed_logit_risk_lag, remote_ed_logit_risk_adj_lag)

### Compare adding lag to risk

lrtest(remote_ed_logit_risk, remote_ed_logit_risk_adj_lag)
compare_alphas(remote_ed_logit_risk, remote_ed_logit_risk_adj_lag)

## Compare adding risk to lag

lrtest(remote_ed_logit_adj_lag, remote_ed_logit_risk_adj_lag)
compare_alphas(remote_ed_logit_adj_lag, remote_ed_logit_risk_adj_lag)

### Add multilevel

remote_ed_mlogit_risk <- update(remote_ed_logit_risk, add_cve)

countsummary(remote_ed_mlogit_risk)

compare_nested(remote_ed_logit_risk, remote_ed_mlogit_risk)

## add lag

remote_ed_mlogit_risk_adj_lag <- update(remote_ed_mlogit_risk, add_remote_adj_lag)

countsummary(remote_ed_mlogit_risk_adj_lag)

compare_nested(remote_ed_logit_risk_adj_lag, remote_ed_mlogit_risk_adj_lag)

compare_alphas(remote_ed_mlogit_risk_lag, remote_ed_mlogit_risk_adj_lag)
AICtab(remote_ed_mlogit_risk_lag, remote_ed_mlogit_risk_adj_lag)

### Compare adding lag to risk

lrtest(remote_ed_mlogit_risk, remote_ed_mlogit_risk_adj_lag)
compare_alphas(remote_ed_mlogit_risk, remote_ed_mlogit_risk_adj_lag)

## Compare adding risk to lag

lrtest(remote_ed_mlogit_adj_lag, remote_ed_mlogit_risk_adj_lag)
compare_alphas(remote_ed_mlogit_adj_lag, remote_ed_mlogit_risk_adj_lag)

####### Test event dependence term using compliance cats #######

remote_ed_logit_ext_comp <- update(remote_ed_logit_null, add_remote_comp)

countsummary(remote_ed_logit_ext_comp)

compare_alphas(remote_ed_logit_null, remote_ed_logit_ext_comp)

compare_alphas(remote_ed_logit_lag, remote_ed_logit_ext_comp)

### Compare to multilevel

remote_ed_mlogit_ext_comp <- update(remote_ed_logit_ext_comp, add_cve)

countsummary(remote_ed_mlogit_ext_comp)

compare_nested(remote_ed_logit_ext_comp, remote_ed_mlogit_ext_comp)

compare_alphas(remote_ed_mlogit_lag, remote_ed_mlogit_ext_comp)
AICtab(remote_ed_mlogit_lag, remote_ed_mlogit_ext_comp)


### Add risk heterogeneity

remote_ed_logit_risk <- update(remote_ed_logit_null, add_risk)

countsummary(remote_ed_logit_risk)

compare_alphas(remote_ed_logit_null, remote_ed_logit_risk)

# compare to poisson

remote_ed_p_risk <- update(remote_ed_logit_risk, family = "poisson")

lrtest(remote_ed_p_risk, remote_ed_logit_risk)

### Add lag and compare

remote_ed_logit_risk_ext_comp <- update(remote_ed_logit_risk, add_remote_comp)

countsummary(remote_ed_logit_risk_ext_comp)

compare_alphas(remote_ed_logit_risk_lag, remote_ed_logit_risk_ext_comp)
AICtab(remote_ed_logit_risk_lag, remote_ed_logit_risk_ext_comp)

### Compare adding lag to risk

lrtest(remote_ed_logit_risk, remote_ed_logit_risk_ext_comp)
compare_alphas(remote_ed_logit_risk, remote_ed_logit_risk_ext_comp)

## Compare adding risk to lag

lrtest(remote_ed_logit_ext_comp, remote_ed_logit_risk_ext_comp)
compare_alphas(remote_ed_logit_ext_comp, remote_ed_logit_risk_ext_comp)

### Add multilevel

remote_ed_mlogit_risk <- update(remote_ed_logit_risk, add_cve)

countsummary(remote_ed_mlogit_risk)

compare_nested(remote_ed_logit_risk, remote_ed_mlogit_risk)

## add lag

remote_ed_mlogit_risk_ext_comp <- update(remote_ed_mlogit_risk, add_remote_comp)

countsummary(remote_ed_mlogit_risk_ext_comp)

compare_nested(remote_ed_logit_risk_ext_comp, remote_ed_mlogit_risk_ext_comp)

compare_alphas(remote_ed_mlogit_risk_lag, remote_ed_mlogit_risk_ext_comp)
AICtab(remote_ed_mlogit_risk_lag, remote_ed_mlogit_risk_ext_comp)

### Compare adding lag to risk

lrtest(remote_ed_mlogit_risk, remote_ed_mlogit_risk_ext_comp)
compare_alphas(remote_ed_mlogit_risk, remote_ed_mlogit_risk_ext_comp)

## Compare adding risk to lag

lrtest(remote_ed_mlogit_ext_comp, remote_ed_mlogit_risk_ext_comp)
compare_alphas(remote_ed_mlogit_ext_comp, remote_ed_mlogit_risk_ext_comp)

####### Test event dependence term using binary lag #######

remote_ed_logit_binlag <- update(remote_ed_logit_null, add_remote_binlag)

countsummary(remote_ed_logit_binlag)

compare_alphas(remote_ed_logit_null, remote_ed_logit_binlag)

compare_alphas(remote_ed_logit_lag, remote_ed_logit_binlag)

### Compare to multilevel

remote_ed_mlogit_binlag <- update(remote_ed_logit_binlag, add_cve)

countsummary(remote_ed_mlogit_binlag)

compare_nested(remote_ed_logit_binlag, remote_ed_mlogit_binlag)

compare_alphas(remote_ed_mlogit_lag, remote_ed_mlogit_binlag)
AICtab(remote_ed_mlogit_lag, remote_ed_mlogit_binlag)


### Add risk heterogeneity

remote_ed_logit_risk <- update(remote_ed_logit_null, add_risk)

countsummary(remote_ed_logit_risk)

compare_alphas(remote_ed_logit_null, remote_ed_logit_risk)

# compare to poisson

remote_ed_p_risk <- update(remote_ed_logit_risk, family = "poisson")

lrtest(remote_ed_p_risk, remote_ed_logit_risk)

### Add lag and compare

remote_ed_logit_risk_binlag <- update(remote_ed_logit_risk, add_remote_binlag)

countsummary(remote_ed_logit_risk_binlag)

compare_alphas(remote_ed_logit_risk_lag, remote_ed_logit_risk_binlag)
AICtab(remote_ed_logit_risk_lag, remote_ed_logit_risk_binlag)

### Compare adding lag to risk

lrtest(remote_ed_logit_risk, remote_ed_logit_risk_binlag)
compare_alphas(remote_ed_logit_risk, remote_ed_logit_risk_binlag)

## Compare adding risk to lag

lrtest(remote_ed_logit_binlag, remote_ed_logit_risk_binlag)
compare_alphas(remote_ed_logit_binlag, remote_ed_logit_risk_binlag)

### Add multilevel

remote_ed_mlogit_risk <- update(remote_ed_logit_risk, add_cve)

countsummary(remote_ed_mlogit_risk)

compare_nested(remote_ed_logit_risk, remote_ed_mlogit_risk)

## add lag

remote_ed_mlogit_risk_binlag <- update(remote_ed_mlogit_risk, add_remote_binlag)

countsummary(remote_ed_mlogit_risk_binlag)

compare_nested(remote_ed_logit_risk_binlag, remote_ed_mlogit_risk_binlag)

compare_alphas(remote_ed_mlogit_risk_lag, remote_ed_mlogit_risk_binlag)
AICtab(remote_ed_mlogit_risk_lag, remote_ed_mlogit_risk_binlag)

### Compare adding lag to risk

lrtest(remote_ed_mlogit_risk, remote_ed_mlogit_risk_binlag)
compare_alphas(remote_ed_mlogit_risk, remote_ed_mlogit_risk_binlag)

## Compare adding risk to lag

lrtest(remote_ed_mlogit_binlag, remote_ed_mlogit_risk_binlag)
compare_alphas(remote_ed_mlogit_binlag, remote_ed_mlogit_risk_binlag)



```

Next, estimate the effect of event dependence in the truncated count.

```{r remote-event-dependence-concentration}


## Use enve_lag_nm_sem1

#### First test event dependence versus a null model

remote_ed_tnb_null <- update(remote_ed_nb_null,
                             data = subset(enve_lag_nm_sem1, remote > 0),
                             family = "truncated_nbinom2")

summary(remote_ed_tnb_null)

### Test event dependence term (then repeat for adjusted and compliance cats)

remote_ed_tnb_lag <- update(remote_ed_tnb_null, add_remote_lag)

countsummary(remote_ed_tnb_lag)

compare_alphas(remote_ed_tnb_null, remote_ed_tnb_lag)

## Compare to poisson

remote_ed_tp_lag <- update(remote_ed_tnb_lag,
                           family = "truncated_poisson")

countsummary(remote_ed_tp_lag)

compare_nested(remote_ed_tp_lag, remote_ed_tnb_lag)

### Compare to multilevel

remote_ed_mtnb_lag <- update(remote_ed_tnb_lag, add_cve)

countsummary(remote_ed_mtnb_lag)

compare_nested(remote_ed_tnb_lag, remote_ed_mtnb_lag)

### compare to multilevel poisson

remote_ed_mtp_lag <- update(remote_ed_tp_lag, add_cve)

countsummary(remote_ed_mtp_lag)

compare_nested(remote_ed_mtp_lag, remote_ed_mtnb_lag)

compare_nested(remote_ed_tp_lag, remote_ed_mtp_lag)


### Add risk heterogeneity

remote_ed_tnb_risk <- update(remote_ed_tnb_null, add_risk)

countsummary(remote_ed_tnb_risk)

compare_alphas(remote_ed_tnb_null, remote_ed_tnb_risk)

# compare to poisson

remote_ed_tp_risk <- update(remote_ed_tnb_risk, family = "truncated_poisson")

lrtest(remote_ed_tp_risk, remote_ed_tnb_risk)

### Add lag and compare

remote_ed_tnb_risk_lag <- update(remote_ed_tnb_risk, add_remote_lag)

countsummary(remote_ed_tnb_risk_lag)

### Compare adding lag to risk

lrtest(remote_ed_tnb_risk, remote_ed_tnb_risk_lag)
compare_alphas(remote_ed_tnb_risk, remote_ed_tnb_risk_lag)

## Compare adding risk to lag

lrtest(remote_ed_tnb_lag, remote_ed_tnb_risk_lag)
compare_alphas(remote_ed_tnb_lag, remote_ed_tnb_risk_lag)

## poisson risk lag

remote_ed_tp_risk_lag <- update(remote_ed_tnb_risk_lag,
                                family ="truncated_poisson")

countsummary(remote_ed_tp_risk_lag)
compare_nested(remote_ed_tp_risk_lag, remote_ed_tnb_risk_lag)

### Add multilevel

remote_ed_mtnb_risk <- update(remote_ed_tnb_risk, add_cve)

countsummary(remote_ed_mtnb_risk)

compare_nested(remote_ed_tnb_risk, remote_ed_mtnb_risk)

# multilevel poisson

remote_ed_mtp_risk <- update(remote_ed_tp_risk, add_cve)

countsummary(remote_ed_mtp_risk)

compare_nested(remote_ed_mtnb_risk, remote_ed_mtp_risk)

compare_nested(remote_ed_tp_risk, remote_ed_mtp_risk)

## add lag

remote_ed_mtnb_risk_lag <- update(remote_ed_mtnb_risk, add_remote_lag)

countsummary(remote_ed_mtnb_risk_lag)

compare_nested(remote_ed_tnb_risk_lag, remote_ed_mtnb_risk_lag)

### Compare adding lag to risk

lrtest(remote_ed_mtnb_risk, remote_ed_mtnb_risk_lag)
compare_alphas(remote_ed_mtnb_risk, remote_ed_mtnb_risk_lag)

## Compare adding risk to lag

lrtest(remote_ed_mtnb_lag, remote_ed_mtnb_risk_lag)
compare_alphas(remote_ed_mtnb_lag, remote_ed_mtnb_risk_lag)

## m poisson risk lag

remote_ed_mtp_risk_lag <- update(remote_ed_mtnb_risk_lag,
                                family ="truncated_poisson")

countsummary(remote_ed_mtp_risk_lag)
compare_nested(remote_ed_mtp_risk_lag, remote_ed_mtnb_risk_lag)


####### Test event dependence term using adjusted rate #######

remote_ed_tnb_adj_lag <- update(remote_ed_tnb_null, add_remote_adj_lag)

countsummary(remote_ed_tnb_adj_lag)

compare_alphas(remote_ed_tnb_null, remote_ed_tnb_adj_lag)

compare_alphas(remote_ed_tnb_lag, remote_ed_tnb_adj_lag)

## Compare to poisson

remote_ed_tp_adj_lag <- update(remote_ed_tnb_adj_lag,
                           family = "truncated_poisson")

countsummary(remote_ed_tp_adj_lag)

compare_nested(remote_ed_tp_adj_lag, remote_ed_tnb_adj_lag)

### Compare to multilevel

remote_ed_mtnb_adj_lag <- update(remote_ed_tnb_adj_lag, add_cve)

countsummary(remote_ed_mtnb_adj_lag)

compare_nested(remote_ed_tnb_adj_lag, remote_ed_mtnb_adj_lag)

compare_alphas(remote_ed_mtnb_lag, remote_ed_mtnb_adj_lag)
AICtab(remote_ed_mtnb_lag, remote_ed_mtnb_adj_lag)

### compare to multilevel poisson

remote_ed_mtp_adj_lag <- update(remote_ed_tp_adj_lag, add_cve)

countsummary(remote_ed_mtp_adj_lag)

compare_nested(remote_ed_mtp_adj_lag, remote_ed_mtnb_adj_lag)

compare_nested(remote_ed_tp_adj_lag, remote_ed_mtp_adj_lag)


### Add risk heterogeneity

remote_ed_tnb_risk <- update(remote_ed_tnb_null, add_risk)

countsummary(remote_ed_tnb_risk)

compare_alphas(remote_ed_tnb_null, remote_ed_tnb_risk)

# compare to poisson

remote_ed_tp_risk <- update(remote_ed_tnb_risk, family = "truncated_poisson")

lrtest(remote_ed_tp_risk, remote_ed_tnb_risk)

### Add lag and compare

remote_ed_tnb_risk_adj_lag <- update(remote_ed_tnb_risk, add_remote_adj_lag)

countsummary(remote_ed_tnb_risk_adj_lag)

compare_alphas(remote_ed_tnb_risk_lag, remote_ed_tnb_risk_adj_lag)
AICtab(remote_ed_tnb_risk_lag, remote_ed_tnb_risk_adj_lag)

### Compare adding lag to risk

lrtest(remote_ed_tnb_risk, remote_ed_tnb_risk_adj_lag)
compare_alphas(remote_ed_tnb_risk, remote_ed_tnb_risk_adj_lag)

## Compare adding risk to lag

lrtest(remote_ed_tnb_adj_lag, remote_ed_tnb_risk_adj_lag)
compare_alphas(remote_ed_tnb_adj_lag, remote_ed_tnb_risk_adj_lag)

## poisson risk lag

remote_ed_tp_risk_adj_lag <- update(remote_ed_tnb_risk_adj_lag,
                                family ="truncated_poisson")

countsummary(remote_ed_tp_risk_adj_lag)
compare_nested(remote_ed_tp_risk_adj_lag, remote_ed_tnb_risk_adj_lag)

### Add multilevel

remote_ed_mtnb_risk <- update(remote_ed_tnb_risk, add_cve)

countsummary(remote_ed_mtnb_risk)

compare_nested(remote_ed_tnb_risk, remote_ed_mtnb_risk)

# multilevel poisson

remote_ed_mtp_risk <- update(remote_ed_tp_risk, add_cve)

countsummary(remote_ed_mtp_risk)

compare_nested(remote_ed_mtnb_risk, remote_ed_mtp_risk)

compare_nested(remote_ed_tp_risk, remote_ed_mtp_risk)

## add lag

remote_ed_mtnb_risk_adj_lag <- update(remote_ed_mtnb_risk, add_remote_adj_lag)

countsummary(remote_ed_mtnb_risk_adj_lag)

compare_nested(remote_ed_tnb_risk_adj_lag, remote_ed_mtnb_risk_adj_lag)

compare_alphas(remote_ed_mtnb_risk_lag, remote_ed_mtnb_risk_adj_lag)
AICtab(remote_ed_mtnb_risk_lag, remote_ed_mtnb_risk_adj_lag)

### Compare adding lag to risk

lrtest(remote_ed_mtnb_risk, remote_ed_mtnb_risk_adj_lag)
compare_alphas(remote_ed_mtnb_risk, remote_ed_mtnb_risk_adj_lag)

## Compare adding risk to lag

lrtest(remote_ed_mtnb_adj_lag, remote_ed_mtnb_risk_adj_lag)
compare_alphas(remote_ed_mtnb_adj_lag, remote_ed_mtnb_risk_adj_lag)

## m poisson risk lag

remote_ed_mtp_risk_adj_lag <- update(remote_ed_mtnb_risk_adj_lag,
                                family ="truncated_poisson")

countsummary(remote_ed_mtp_risk_adj_lag)
compare_nested(remote_ed_mtp_risk_adj_lag, remote_ed_mtnb_risk_adj_lag)

####### Test event dependence term using compliance cats #######

remote_ed_tnb_ext_comp <- update(remote_ed_tnb_null, add_remote_comp)

countsummary(remote_ed_tnb_ext_comp)

compare_alphas(remote_ed_tnb_null, remote_ed_tnb_ext_comp)

compare_alphas(remote_ed_tnb_lag, remote_ed_tnb_ext_comp)

## Compare to poisson

remote_ed_tp_ext_comp <- update(remote_ed_tnb_ext_comp,
                           family = "truncated_poisson")

countsummary(remote_ed_tp_ext_comp)

compare_nested(remote_ed_tp_ext_comp, remote_ed_tnb_ext_comp)

### Compare to multilevel

remote_ed_mtnb_ext_comp <- update(remote_ed_tnb_ext_comp, add_cve)

countsummary(remote_ed_mtnb_ext_comp)

compare_nested(remote_ed_tnb_ext_comp, remote_ed_mtnb_ext_comp)

compare_alphas(remote_ed_mtnb_lag, remote_ed_mtnb_ext_comp)
AICtab(remote_ed_mtnb_lag, remote_ed_mtnb_ext_comp)

### compare to multilevel poisson

remote_ed_mtp_ext_comp <- update(remote_ed_tp_ext_comp, add_cve)

countsummary(remote_ed_mtp_ext_comp)

compare_nested(remote_ed_mtp_ext_comp, remote_ed_mtnb_ext_comp)

compare_nested(remote_ed_tp_ext_comp, remote_ed_mtp_ext_comp)


### Add risk heterogeneity

remote_ed_tnb_risk <- update(remote_ed_tnb_null, add_risk)

countsummary(remote_ed_tnb_risk)

compare_alphas(remote_ed_tnb_null, remote_ed_tnb_risk)

# compare to poisson

remote_ed_tp_risk <- update(remote_ed_tnb_risk, family = "truncated_poisson")

lrtest(remote_ed_tp_risk, remote_ed_tnb_risk)

### Add lag and compare

remote_ed_tnb_risk_ext_comp <- update(remote_ed_tnb_risk, add_remote_comp)

countsummary(remote_ed_tnb_risk_ext_comp)

compare_alphas(remote_ed_tnb_risk_lag, remote_ed_tnb_risk_ext_comp)
AICtab(remote_ed_tnb_risk_lag, remote_ed_tnb_risk_ext_comp)

### Compare adding lag to risk

lrtest(remote_ed_tnb_risk, remote_ed_tnb_risk_ext_comp)
compare_alphas(remote_ed_tnb_risk, remote_ed_tnb_risk_ext_comp)

## Compare adding risk to lag

lrtest(remote_ed_tnb_ext_comp, remote_ed_tnb_risk_ext_comp)
compare_alphas(remote_ed_tnb_ext_comp, remote_ed_tnb_risk_ext_comp)

## poisson risk lag

remote_ed_tp_risk_ext_comp <- update(remote_ed_tnb_risk_ext_comp,
                                family ="truncated_poisson")

countsummary(remote_ed_tp_risk_ext_comp)
compare_nested(remote_ed_tp_risk_ext_comp, remote_ed_tnb_risk_ext_comp)

### Add multilevel

remote_ed_mtnb_risk <- update(remote_ed_tnb_risk, add_cve)

countsummary(remote_ed_mtnb_risk)

compare_nested(remote_ed_tnb_risk, remote_ed_mtnb_risk)

# multilevel poisson

remote_ed_mtp_risk <- update(remote_ed_tp_risk, add_cve)

countsummary(remote_ed_mtp_risk)

compare_nested(remote_ed_mtnb_risk, remote_ed_mtp_risk)

compare_nested(remote_ed_tp_risk, remote_ed_mtp_risk)

## add lag

remote_ed_mtnb_risk_ext_comp <- update(remote_ed_mtnb_risk, add_remote_comp)

countsummary(remote_ed_mtnb_risk_ext_comp)

compare_nested(remote_ed_tnb_risk_ext_comp, remote_ed_mtnb_risk_ext_comp)

compare_alphas(remote_ed_mtnb_risk_lag, remote_ed_mtnb_risk_ext_comp)
AICtab(remote_ed_mtnb_risk_lag, remote_ed_mtnb_risk_ext_comp)

### Compare adding lag to risk

lrtest(remote_ed_mtnb_risk, remote_ed_mtnb_risk_ext_comp)
compare_alphas(remote_ed_mtnb_risk, remote_ed_mtnb_risk_ext_comp)

## Compare adding risk to lag

lrtest(remote_ed_mtnb_ext_comp, remote_ed_mtnb_risk_ext_comp)
compare_alphas(remote_ed_mtnb_ext_comp, remote_ed_mtnb_risk_ext_comp)

## m poisson risk lag

remote_ed_mtp_risk_ext_comp <- update(remote_ed_mtnb_risk_ext_comp,
                                family ="truncated_poisson")

countsummary(remote_ed_mtp_risk_ext_comp)
compare_nested(remote_ed_mtp_risk_ext_comp, remote_ed_mtnb_risk_ext_comp)


####### Test event dependence term using binary lag #######

remote_ed_tnb_binlag <- update(remote_ed_tnb_null, add_remote_binlag)

countsummary(remote_ed_tnb_binlag)

compare_alphas(remote_ed_tnb_null, remote_ed_tnb_binlag)

compare_alphas(remote_ed_tnb_lag, remote_ed_tnb_binlag)

## Compare to poisson

remote_ed_tp_binlag <- update(remote_ed_tnb_binlag,
                           family = "truncated_poisson")

countsummary(remote_ed_tp_binlag)

compare_nested(remote_ed_tp_binlag, remote_ed_tnb_binlag)

### Compare to multilevel

remote_ed_mtnb_binlag <- update(remote_ed_tnb_binlag, add_cve)

countsummary(remote_ed_mtnb_binlag)

compare_nested(remote_ed_tnb_binlag, remote_ed_mtnb_binlag)

compare_alphas(remote_ed_mtnb_lag, remote_ed_mtnb_binlag)
AICtab(remote_ed_mtnb_lag, remote_ed_mtnb_binlag)

### compare to multilevel poisson

remote_ed_mtp_binlag <- update(remote_ed_tp_binlag, add_cve)

countsummary(remote_ed_mtp_binlag)

compare_nested(remote_ed_mtp_binlag, remote_ed_mtnb_binlag)

compare_nested(remote_ed_tp_binlag, remote_ed_mtp_binlag)


### Add risk heterogeneity

remote_ed_tnb_risk <- update(remote_ed_tnb_null, add_risk)

countsummary(remote_ed_tnb_risk)

compare_alphas(remote_ed_tnb_null, remote_ed_tnb_risk)

# compare to poisson

remote_ed_tp_risk <- update(remote_ed_tnb_risk, family = "truncated_poisson")

lrtest(remote_ed_tp_risk, remote_ed_tnb_risk)

### Add lag and compare

remote_ed_tnb_risk_binlag <- update(remote_ed_tnb_risk, add_remote_binlag)

countsummary(remote_ed_tnb_risk_binlag)

compare_alphas(remote_ed_tnb_risk_lag, remote_ed_tnb_risk_binlag)
AICtab(remote_ed_tnb_risk_lag, remote_ed_tnb_risk_binlag)

### Compare adding lag to risk

lrtest(remote_ed_tnb_risk, remote_ed_tnb_risk_binlag)
compare_alphas(remote_ed_tnb_risk, remote_ed_tnb_risk_binlag)

## Compare adding risk to lag

lrtest(remote_ed_tnb_binlag, remote_ed_tnb_risk_binlag)
compare_alphas(remote_ed_tnb_binlag, remote_ed_tnb_risk_binlag)

## poisson risk lag

remote_ed_tp_risk_binlag <- update(remote_ed_tnb_risk_binlag,
                                family ="truncated_poisson")

countsummary(remote_ed_tp_risk_binlag)
compare_nested(remote_ed_tp_risk_binlag, remote_ed_tnb_risk_binlag)

### Add multilevel

remote_ed_mtnb_risk <- update(remote_ed_tnb_risk, add_cve)

countsummary(remote_ed_mtnb_risk)

compare_nested(remote_ed_tnb_risk, remote_ed_mtnb_risk)

# multilevel poisson

remote_ed_mtp_risk <- update(remote_ed_tp_risk, add_cve)

countsummary(remote_ed_mtp_risk)

compare_nested(remote_ed_mtnb_risk, remote_ed_mtp_risk)

compare_nested(remote_ed_tp_risk, remote_ed_mtp_risk)

## add lag

remote_ed_mtnb_risk_binlag <- update(remote_ed_mtnb_risk, add_remote_binlag)

countsummary(remote_ed_mtnb_risk_binlag)

compare_nested(remote_ed_tnb_risk_binlag, remote_ed_mtnb_risk_binlag)

compare_alphas(remote_ed_mtnb_risk_lag, remote_ed_mtnb_risk_binlag)
AICtab(remote_ed_mtnb_risk_lag, remote_ed_mtnb_risk_binlag)

### Compare adding lag to risk

lrtest(remote_ed_mtnb_risk, remote_ed_mtnb_risk_binlag)
compare_alphas(remote_ed_mtnb_risk, remote_ed_mtnb_risk_binlag)

## Compare adding risk to lag

lrtest(remote_ed_mtnb_binlag, remote_ed_mtnb_risk_binlag)
compare_alphas(remote_ed_mtnb_binlag, remote_ed_mtnb_risk_binlag)

## m poisson risk lag

remote_ed_mtp_risk_binlag <- update(remote_ed_mtnb_risk_binlag,
                                family ="truncated_poisson")

countsummary(remote_ed_mtp_risk_binlag)
compare_nested(remote_ed_mtp_risk_binlag, remote_ed_mtnb_risk_binlag)



```

Repeat using glmmADMB


```{r remote-event-dependence-concentration-glmmADMB}

## Use enve_lag_nm_sem1

#### First test event dependence versus a null model

remote_admb_ed_tnb_null <- glmmadmb(formula(remote_ed_tnb_null),
                             data = subset(enve_lag_nm_sem1, remote > 0),
                             family = "truncnbinom",
                             zeroInflation = FALSE,
                             admb.opts = glmmADMB::admbControl(noinit = FALSE, shess=FALSE),
                             extra.args = "-ndi 60000")

summary(remote_admb_ed_tnb_null)

### Test event dependence term (then repeat for adjusted and compliance cats)

remote_admb_ed_tnb_lag <- update(remote_admb_ed_tnb_null, add_remote_lag)

countsummary(remote_admb_ed_tnb_lag)

compare_alphas(remote_admb_ed_tnb_null, remote_admb_ed_tnb_lag)

## Compare to poisson

remote_admb_ed_tp_lag <- update(remote_admb_ed_tnb_lag,
                           family = "truncpoiss")

countsummary(remote_admb_ed_tp_lag)

compare_nested(remote_admb_ed_tp_lag, remote_admb_ed_tnb_lag)

### Compare to multilevel

remote_admb_ed_mtnb_lag <- update(remote_admb_ed_tnb_lag, add_nom)

countsummary(remote_admb_ed_mtnb_lag)

compare_nested(remote_admb_ed_tnb_lag, remote_admb_ed_mtnb_lag)

### compare to multilevel poisson

remote_admb_ed_mtp_lag <- update(remote_admb_ed_tp_lag, add_nom)

countsummary(remote_admb_ed_mtp_lag)

compare_nested(remote_admb_ed_mtp_lag, remote_admb_ed_mtnb_lag)

compare_nested(remote_admb_ed_tp_lag, remote_admb_ed_mtp_lag)


### Add risk heterogeneity

remote_admb_ed_tnb_risk <- update(remote_admb_ed_tnb_null, add_risk)

countsummary(remote_admb_ed_tnb_risk)

compare_alphas(remote_admb_ed_tnb_null, remote_admb_ed_tnb_risk)

# compare to poisson

remote_admb_ed_tp_risk <- update(remote_admb_ed_tnb_risk, family = "truncpoiss")

lrtest(remote_admb_ed_tp_risk, remote_admb_ed_tnb_risk)

### Add lag and compare

remote_admb_ed_tnb_risk_lag <- update(remote_admb_ed_tnb_risk, add_remote_lag)

countsummary(remote_admb_ed_tnb_risk_lag)

### Compare adding lag to risk

lrtest(remote_admb_ed_tnb_risk, remote_admb_ed_tnb_risk_lag)
compare_alphas(remote_admb_ed_tnb_risk, remote_admb_ed_tnb_risk_lag)

## Compare adding risk to lag

lrtest(remote_admb_ed_tnb_lag, remote_admb_ed_tnb_risk_lag)
compare_alphas(remote_admb_ed_tnb_lag, remote_admb_ed_tnb_risk_lag)

## poisson risk lag

remote_admb_ed_tp_risk_lag <- update(remote_admb_ed_tnb_risk_lag,
                                family ="truncpoiss")

countsummary(remote_admb_ed_tp_risk_lag)
compare_nested(remote_admb_ed_tp_risk_lag, remote_admb_ed_tnb_risk_lag)

### Add multilevel

remote_admb_ed_mtnb_risk <- update(remote_admb_ed_tnb_risk, add_nom)

countsummary(remote_admb_ed_mtnb_risk)

compare_nested(remote_admb_ed_tnb_risk, remote_admb_ed_mtnb_risk)

# multilevel poisson

remote_admb_ed_mtp_risk <- update(remote_admb_ed_tp_risk, add_nom)

countsummary(remote_admb_ed_mtp_risk)

compare_nested(remote_admb_ed_mtnb_risk, remote_admb_ed_mtp_risk)

compare_nested(remote_admb_ed_tp_risk, remote_admb_ed_mtp_risk)

## add lag

remote_admb_ed_mtnb_risk_lag <- update(remote_admb_ed_mtnb_risk, add_remote_lag)

countsummary(remote_admb_ed_mtnb_risk_lag)

compare_nested(remote_admb_ed_tnb_risk_lag, remote_admb_ed_mtnb_risk_lag)

### Compare adding lag to risk

lrtest(remote_admb_ed_mtnb_risk, remote_admb_ed_mtnb_risk_lag)
compare_alphas(remote_admb_ed_mtnb_risk, remote_admb_ed_mtnb_risk_lag)

## Compare adding risk to lag

lrtest(remote_admb_ed_mtnb_lag, remote_admb_ed_mtnb_risk_lag)
compare_alphas(remote_admb_ed_mtnb_lag, remote_admb_ed_mtnb_risk_lag)

## m poisson risk lag

remote_admb_ed_mtp_risk_lag <- update(remote_admb_ed_mtnb_risk_lag,
                                family ="truncpoiss")

countsummary(remote_admb_ed_mtp_risk_lag)
compare_nested(remote_admb_ed_mtp_risk_lag, remote_admb_ed_mtnb_risk_lag)


####### Test event dependence term using adjusted rate #######

remote_admb_ed_tnb_adj_lag <- update(remote_admb_ed_tnb_null, add_remote_adj_lag)

countsummary(remote_admb_ed_tnb_adj_lag)

compare_alphas(remote_admb_ed_tnb_null, remote_admb_ed_tnb_adj_lag)

compare_alphas(remote_admb_ed_tnb_lag, remote_admb_ed_tnb_adj_lag)

## Compare to poisson

remote_admb_ed_tp_adj_lag <- update(remote_admb_ed_tnb_adj_lag,
                           family = "truncpoiss")

countsummary(remote_admb_ed_tp_adj_lag)

compare_nested(remote_admb_ed_tp_adj_lag, remote_admb_ed_tnb_adj_lag)

### Compare to multilevel

remote_admb_ed_mtnb_adj_lag <- update(remote_admb_ed_tnb_adj_lag, add_nom)

countsummary(remote_admb_ed_mtnb_adj_lag)

compare_nested(remote_admb_ed_tnb_adj_lag, remote_admb_ed_mtnb_adj_lag)

compare_alphas(remote_admb_ed_mtnb_lag, remote_admb_ed_mtnb_adj_lag)
AICtab(remote_admb_ed_mtnb_lag, remote_admb_ed_mtnb_adj_lag)

### compare to multilevel poisson

remote_admb_ed_mtp_adj_lag <- update(remote_admb_ed_tp_adj_lag, add_nom)

countsummary(remote_admb_ed_mtp_adj_lag)

compare_nested(remote_admb_ed_mtp_adj_lag, remote_admb_ed_mtnb_adj_lag)

compare_nested(remote_admb_ed_tp_adj_lag, remote_admb_ed_mtp_adj_lag)


### Add risk heterogeneity

remote_admb_ed_tnb_risk <- update(remote_admb_ed_tnb_null, add_risk)

countsummary(remote_admb_ed_tnb_risk)

compare_alphas(remote_admb_ed_tnb_null, remote_admb_ed_tnb_risk)

# compare to poisson

remote_admb_ed_tp_risk <- update(remote_admb_ed_tnb_risk, family = "truncpoiss")

lrtest(remote_admb_ed_tp_risk, remote_admb_ed_tnb_risk)

### Add lag and compare

remote_admb_ed_tnb_risk_adj_lag <- update(remote_admb_ed_tnb_risk, add_remote_adj_lag)

countsummary(remote_admb_ed_tnb_risk_adj_lag)

compare_alphas(remote_admb_ed_tnb_risk_lag, remote_admb_ed_tnb_risk_adj_lag)
AICtab(remote_admb_ed_tnb_risk_lag, remote_admb_ed_tnb_risk_adj_lag)

### Compare adding lag to risk

lrtest(remote_admb_ed_tnb_risk, remote_admb_ed_tnb_risk_adj_lag)
compare_alphas(remote_admb_ed_tnb_risk, remote_admb_ed_tnb_risk_adj_lag)

## Compare adding risk to lag

lrtest(remote_admb_ed_tnb_adj_lag, remote_admb_ed_tnb_risk_adj_lag)
compare_alphas(remote_admb_ed_tnb_adj_lag, remote_admb_ed_tnb_risk_adj_lag)

## poisson risk lag

remote_admb_ed_tp_risk_adj_lag <- update(remote_admb_ed_tnb_risk_adj_lag,
                                family ="truncpoiss")

countsummary(remote_admb_ed_tp_risk_adj_lag)
compare_nested(remote_admb_ed_tp_risk_adj_lag, remote_admb_ed_tnb_risk_adj_lag)

### Add multilevel

remote_admb_ed_mtnb_risk <- update(remote_admb_ed_tnb_risk, add_nom)

countsummary(remote_admb_ed_mtnb_risk)

compare_nested(remote_admb_ed_tnb_risk, remote_admb_ed_mtnb_risk)

# multilevel poisson

remote_admb_ed_mtp_risk <- update(remote_admb_ed_tp_risk, add_nom)

countsummary(remote_admb_ed_mtp_risk)

compare_nested(remote_admb_ed_mtnb_risk, remote_admb_ed_mtp_risk)

compare_nested(remote_admb_ed_tp_risk, remote_admb_ed_mtp_risk)

## add lag

remote_admb_ed_mtnb_risk_adj_lag <- update(remote_admb_ed_mtnb_risk, add_remote_adj_lag)

countsummary(remote_admb_ed_mtnb_risk_adj_lag)

compare_nested(remote_admb_ed_tnb_risk_adj_lag, remote_admb_ed_mtnb_risk_adj_lag)

compare_alphas(remote_admb_ed_mtnb_risk_lag, remote_admb_ed_mtnb_risk_adj_lag)
AICtab(remote_admb_ed_mtnb_risk_lag, remote_admb_ed_mtnb_risk_adj_lag)

### Compare adding lag to risk

lrtest(remote_admb_ed_mtnb_risk, remote_admb_ed_mtnb_risk_adj_lag)
compare_alphas(remote_admb_ed_mtnb_risk, remote_admb_ed_mtnb_risk_adj_lag)

## Compare adding risk to lag

lrtest(remote_admb_ed_mtnb_adj_lag, remote_admb_ed_mtnb_risk_adj_lag)
compare_alphas(remote_admb_ed_mtnb_adj_lag, remote_admb_ed_mtnb_risk_adj_lag)

## m poisson risk lag

remote_admb_ed_mtp_risk_adj_lag <- update(remote_admb_ed_mtnb_risk_adj_lag,
                                family ="truncpoiss")

countsummary(remote_admb_ed_mtp_risk_adj_lag)
compare_nested(remote_admb_ed_mtp_risk_adj_lag, remote_admb_ed_mtnb_risk_adj_lag)

####### Test event dependence term using compliance cats #######

remote_admb_ed_tnb_ext_comp <- update(remote_admb_ed_tnb_null, add_remote_comp)

countsummary(remote_admb_ed_tnb_ext_comp)

compare_alphas(remote_admb_ed_tnb_null, remote_admb_ed_tnb_ext_comp)

compare_alphas(remote_admb_ed_tnb_lag, remote_admb_ed_tnb_ext_comp)

## Compare to poisson

remote_admb_ed_tp_ext_comp <- update(remote_admb_ed_tnb_ext_comp,
                           family = "truncpoiss")

countsummary(remote_admb_ed_tp_ext_comp)

compare_nested(remote_admb_ed_tp_ext_comp, remote_admb_ed_tnb_ext_comp)

### Compare to multilevel

remote_admb_ed_mtnb_ext_comp <- update(remote_admb_ed_tnb_ext_comp, add_nom)

countsummary(remote_admb_ed_mtnb_ext_comp)

compare_nested(remote_admb_ed_tnb_ext_comp, remote_admb_ed_mtnb_ext_comp)

compare_alphas(remote_admb_ed_mtnb_lag, remote_admb_ed_mtnb_ext_comp)
AICtab(remote_admb_ed_mtnb_lag, remote_admb_ed_mtnb_ext_comp)

### compare to multilevel poisson

remote_admb_ed_mtp_ext_comp <- update(remote_admb_ed_tp_ext_comp, add_nom)

countsummary(remote_admb_ed_mtp_ext_comp)

compare_nested(remote_admb_ed_mtp_ext_comp, remote_admb_ed_mtnb_ext_comp)

compare_nested(remote_admb_ed_tp_ext_comp, remote_admb_ed_mtp_ext_comp)


### Add risk heterogeneity

remote_admb_ed_tnb_risk <- update(remote_admb_ed_tnb_null, add_risk)

countsummary(remote_admb_ed_tnb_risk)

compare_alphas(remote_admb_ed_tnb_null, remote_admb_ed_tnb_risk)

# compare to poisson

remote_admb_ed_tp_risk <- update(remote_admb_ed_tnb_risk, family = "truncpoiss")

lrtest(remote_admb_ed_tp_risk, remote_admb_ed_tnb_risk)

### Add lag and compare

remote_admb_ed_tnb_risk_ext_comp <- update(remote_admb_ed_tnb_risk, add_remote_comp)

countsummary(remote_admb_ed_tnb_risk_ext_comp)

compare_alphas(remote_admb_ed_tnb_risk_lag, remote_admb_ed_tnb_risk_ext_comp)
AICtab(remote_admb_ed_tnb_risk_lag, remote_admb_ed_tnb_risk_ext_comp)

### Compare adding lag to risk

lrtest(remote_admb_ed_tnb_risk, remote_admb_ed_tnb_risk_ext_comp)
compare_alphas(remote_admb_ed_tnb_risk, remote_admb_ed_tnb_risk_ext_comp)

## Compare adding risk to lag

lrtest(remote_admb_ed_tnb_ext_comp, remote_admb_ed_tnb_risk_ext_comp)
compare_alphas(remote_admb_ed_tnb_ext_comp, remote_admb_ed_tnb_risk_ext_comp)

## poisson risk lag

remote_admb_ed_tp_risk_ext_comp <- update(remote_admb_ed_tnb_risk_ext_comp,
                                family ="truncpoiss")

countsummary(remote_admb_ed_tp_risk_ext_comp)
compare_nested(remote_admb_ed_tp_risk_ext_comp, remote_admb_ed_tnb_risk_ext_comp)

### Add multilevel

remote_admb_ed_mtnb_risk <- update(remote_admb_ed_tnb_risk, add_nom)

countsummary(remote_admb_ed_mtnb_risk)

compare_nested(remote_admb_ed_tnb_risk, remote_admb_ed_mtnb_risk)

# multilevel poisson

remote_admb_ed_mtp_risk <- update(remote_admb_ed_tp_risk, add_nom)

countsummary(remote_admb_ed_mtp_risk)

compare_nested(remote_admb_ed_mtnb_risk, remote_admb_ed_mtp_risk)

compare_nested(remote_admb_ed_tp_risk, remote_admb_ed_mtp_risk)

## add lag

remote_admb_ed_mtnb_risk_ext_comp <- update(remote_admb_ed_mtnb_risk, add_remote_comp)

countsummary(remote_admb_ed_mtnb_risk_ext_comp)

compare_nested(remote_admb_ed_tnb_risk_ext_comp, remote_admb_ed_mtnb_risk_ext_comp)

compare_alphas(remote_admb_ed_mtnb_risk_lag, remote_admb_ed_mtnb_risk_ext_comp)
AICtab(remote_admb_ed_mtnb_risk_lag, remote_admb_ed_mtnb_risk_ext_comp)

### Compare adding lag to risk

lrtest(remote_admb_ed_mtnb_risk, remote_admb_ed_mtnb_risk_ext_comp)
compare_alphas(remote_admb_ed_mtnb_risk, remote_admb_ed_mtnb_risk_ext_comp)

## Compare adding risk to lag

lrtest(remote_admb_ed_mtnb_ext_comp, remote_admb_ed_mtnb_risk_ext_comp)
compare_alphas(remote_admb_ed_mtnb_ext_comp, remote_admb_ed_mtnb_risk_ext_comp)

## m poisson risk lag

remote_admb_ed_mtp_risk_ext_comp <- update(remote_admb_ed_mtnb_risk_ext_comp,
                                family ="truncpoiss")

countsummary(remote_admb_ed_mtp_risk_ext_comp)
compare_nested(remote_admb_ed_mtp_risk_ext_comp, remote_admb_ed_mtnb_risk_ext_comp)

####### Test event dependence term using binary lag #######

remote_admb_ed_tnb_binlag <- update(remote_admb_ed_tnb_null,add_remote_binlag)

countsummary(remote_admb_ed_tnb_binlag)

compare_alphas(remote_admb_ed_tnb_null, remote_admb_ed_tnb_binlag)

compare_alphas(remote_admb_ed_tnb_lag, remote_admb_ed_tnb_binlag)

## Compare to poisson

remote_admb_ed_tp_binlag <- update(remote_admb_ed_tnb_binlag,
                           family = "truncpoiss")

countsummary(remote_admb_ed_tp_binlag)

compare_nested(remote_admb_ed_tp_binlag, remote_admb_ed_tnb_binlag)

### Compare to multilevel

remote_admb_ed_mtnb_binlag <- update(remote_admb_ed_tnb_binlag, add_nom)

countsummary(remote_admb_ed_mtnb_binlag)

compare_nested(remote_admb_ed_tnb_binlag, remote_admb_ed_mtnb_binlag)

compare_alphas(remote_admb_ed_mtnb_lag, remote_admb_ed_mtnb_binlag)
AICtab(remote_admb_ed_mtnb_lag, remote_admb_ed_mtnb_binlag)

### compare to multilevel poisson

remote_admb_ed_mtp_binlag <- update(remote_admb_ed_tp_binlag, add_nom)

countsummary(remote_admb_ed_mtp_binlag)

compare_nested(remote_admb_ed_mtp_binlag, remote_admb_ed_mtnb_binlag)

compare_nested(remote_admb_ed_tp_binlag, remote_admb_ed_mtp_binlag)


### Add risk heterogeneity

remote_admb_ed_tnb_risk <- update(remote_admb_ed_tnb_null, add_risk)

countsummary(remote_admb_ed_tnb_risk)

compare_alphas(remote_admb_ed_tnb_null, remote_admb_ed_tnb_risk)

# compare to poisson

remote_admb_ed_tp_risk <- update(remote_admb_ed_tnb_risk, family = "truncpoiss")

lrtest(remote_admb_ed_tp_risk, remote_admb_ed_tnb_risk)

### Add lag and compare

remote_admb_ed_tnb_risk_binlag <- update(remote_admb_ed_tnb_risk,add_remote_binlag)

countsummary(remote_admb_ed_tnb_risk_binlag)

compare_alphas(remote_admb_ed_tnb_risk_lag, remote_admb_ed_tnb_risk_binlag)
AICtab(remote_admb_ed_tnb_risk_lag, remote_admb_ed_tnb_risk_binlag)

### Compare adding lag to risk

lrtest(remote_admb_ed_tnb_risk, remote_admb_ed_tnb_risk_binlag)
compare_alphas(remote_admb_ed_tnb_risk, remote_admb_ed_tnb_risk_binlag)

## Compare adding risk to lag

lrtest(remote_admb_ed_tnb_binlag, remote_admb_ed_tnb_risk_binlag)
compare_alphas(remote_admb_ed_tnb_binlag, remote_admb_ed_tnb_risk_binlag)

## poisson risk lag

remote_admb_ed_tp_risk_binlag <- update(remote_admb_ed_tnb_risk_binlag,
                                family ="truncpoiss")

countsummary(remote_admb_ed_tp_risk_binlag)
compare_nested(remote_admb_ed_tp_risk_binlag, remote_admb_ed_tnb_risk_binlag)

### Add multilevel

remote_admb_ed_mtnb_risk <- update(remote_admb_ed_tnb_risk, add_nom)

countsummary(remote_admb_ed_mtnb_risk)

compare_nested(remote_admb_ed_tnb_risk, remote_admb_ed_mtnb_risk)

# multilevel poisson

remote_admb_ed_mtp_risk <- update(remote_admb_ed_tp_risk, add_nom)

countsummary(remote_admb_ed_mtp_risk)

compare_nested(remote_admb_ed_mtnb_risk, remote_admb_ed_mtp_risk)

compare_nested(remote_admb_ed_tp_risk, remote_admb_ed_mtp_risk)

## add lag

remote_admb_ed_mtnb_risk_binlag <- update(remote_admb_ed_mtnb_risk,add_remote_binlag)

countsummary(remote_admb_ed_mtnb_risk_binlag)

compare_nested(remote_admb_ed_tnb_risk_binlag, remote_admb_ed_mtnb_risk_binlag)

compare_alphas(remote_admb_ed_mtnb_risk_lag, remote_admb_ed_mtnb_risk_binlag)
AICtab(remote_admb_ed_mtnb_risk_lag, remote_admb_ed_mtnb_risk_binlag)

### Compare adding lag to risk

lrtest(remote_admb_ed_mtnb_risk, remote_admb_ed_mtnb_risk_binlag)
compare_alphas(remote_admb_ed_mtnb_risk, remote_admb_ed_mtnb_risk_binlag)

## Compare adding risk to lag

lrtest(remote_admb_ed_mtnb_binlag, remote_admb_ed_mtnb_risk_binlag)
compare_alphas(remote_admb_ed_mtnb_binlag, remote_admb_ed_mtnb_risk_binlag)

## m poisson risk lag

remote_admb_ed_mtp_risk_binlag <- update(remote_admb_ed_mtnb_risk_binlag,
                                family ="truncpoiss")

countsummary(remote_admb_ed_mtp_risk_binlag)
compare_nested(remote_admb_ed_mtp_risk_binlag, remote_admb_ed_mtnb_risk_binlag)


```

#### In person

Repeat for in-person


```{r inperson-event-dependence-formulas}

# LHS extincs formula

inperson_null_f <- inperson ~ 1

# Write RHS formulas for easier coding

# Add event dependence formulas

add_inperson_lag <- . ~ . + lag_inperson

add_inperson_adj_lag <- . ~ . + lag_inp_adj

add_inperson_binlag <- . ~ . + mkbin(lag_inperson)

### Compliance

add_inperson_comp <- ~ + lag_inp_comp_cat

```


```{r inperson-event-dependence-incidence}

## Use enve_lag_nm_sem1

#### First test event dependence versus a null model

inperson_ed_nb_null <- glmmTMB(inperson_null_f,
                             data = enve_lag_nm_sem1,
                             family = "nbinom2")

summary(inperson_ed_nb_null)

### Test event dependence term (then repeat for adjusted and compliance cats)

inperson_ed_nb_lag <- update(inperson_ed_nb_null, add_inperson_lag)

countsummary(inperson_ed_nb_lag)

compare_alphas(inperson_ed_nb_null, inperson_ed_nb_lag)

## Compare to poisson

inperson_ed_p_lag <- update(inperson_ed_nb_lag,
                           family = "poisson")

countsummary(inperson_ed_p_lag)

compare_nested(inperson_ed_p_lag, inperson_ed_nb_lag)

### Compare to multilevel

inperson_ed_mnb_lag <- update(inperson_ed_nb_lag, add_cve)

countsummary(inperson_ed_mnb_lag)

compare_nested(inperson_ed_nb_lag, inperson_ed_mnb_lag)

### compare to multilevel poisson

inperson_ed_mp_lag <- update(inperson_ed_p_lag, add_cve)

countsummary(inperson_ed_mp_lag)

compare_nested(inperson_ed_mp_lag, inperson_ed_mnb_lag)

compare_nested(inperson_ed_p_lag, inperson_ed_mp_lag)


### Add risk heterogeneity

inperson_ed_nb_risk <- update(inperson_ed_nb_null, add_risk)

countsummary(inperson_ed_nb_risk)

compare_alphas(inperson_ed_nb_null, inperson_ed_nb_risk)

# compare to poisson

inperson_ed_p_risk <- update(inperson_ed_nb_risk, family = "poisson")

lrtest(inperson_ed_p_risk, inperson_ed_nb_risk)

### Add lag and compare

inperson_ed_nb_risk_lag <- update(inperson_ed_nb_risk, add_inperson_lag)

countsummary(inperson_ed_nb_risk_lag)

### Compare adding lag to risk

lrtest(inperson_ed_nb_risk, inperson_ed_nb_risk_lag)
compare_alphas(inperson_ed_nb_risk, inperson_ed_nb_risk_lag)

## Compare adding risk to lag

lrtest(inperson_ed_nb_lag, inperson_ed_nb_risk_lag)
compare_alphas(inperson_ed_nb_lag, inperson_ed_nb_risk_lag)

## poisson risk lag

inperson_ed_p_risk_lag <- update(inperson_ed_nb_risk_lag,
                                family ="poisson")

countsummary(inperson_ed_p_risk_lag)
compare_nested(inperson_ed_p_risk_lag, inperson_ed_nb_risk_lag)

### Add multilevel

inperson_ed_mnb_risk <- update(inperson_ed_nb_risk, add_cve)

countsummary(inperson_ed_mnb_risk)

compare_nested(inperson_ed_nb_risk, inperson_ed_mnb_risk)

# multilevel poisson

inperson_ed_mp_risk <- update(inperson_ed_p_risk, add_cve)

countsummary(inperson_ed_mp_risk)

compare_nested(inperson_ed_mnb_risk, inperson_ed_mp_risk)

compare_nested(inperson_ed_p_risk, inperson_ed_mp_risk)

## add lag

inperson_ed_mnb_risk_lag <- update(inperson_ed_mnb_risk, add_inperson_lag)

countsummary(inperson_ed_mnb_risk_lag)

compare_nested(inperson_ed_nb_risk_lag, inperson_ed_mnb_risk_lag)

### Compare adding lag to risk

lrtest(inperson_ed_mnb_risk, inperson_ed_mnb_risk_lag)
compare_alphas(inperson_ed_mnb_risk, inperson_ed_mnb_risk_lag)

## Compare adding risk to lag

lrtest(inperson_ed_mnb_lag, inperson_ed_mnb_risk_lag)
compare_alphas(inperson_ed_mnb_lag, inperson_ed_mnb_risk_lag)

## m poisson risk lag

inperson_ed_mp_risk_lag <- update(inperson_ed_mnb_risk_lag,
                                family ="poisson")

countsummary(inperson_ed_mp_risk_lag)
compare_nested(inperson_ed_mp_risk_lag, inperson_ed_mnb_risk_lag)


####### Test event dependence term using adjusted rate #######

inperson_ed_nb_adj_lag <- update(inperson_ed_nb_null, add_inperson_adj_lag)

countsummary(inperson_ed_nb_adj_lag)

compare_alphas(inperson_ed_nb_null, inperson_ed_nb_adj_lag)

compare_alphas(inperson_ed_nb_lag, inperson_ed_nb_adj_lag)

## Compare to poisson

inperson_ed_p_adj_lag <- update(inperson_ed_nb_adj_lag,
                           family = "poisson")

countsummary(inperson_ed_p_adj_lag)

compare_nested(inperson_ed_p_adj_lag, inperson_ed_nb_adj_lag)

### Compare to multilevel

inperson_ed_mnb_adj_lag <- update(inperson_ed_nb_adj_lag, add_cve)

countsummary(inperson_ed_mnb_adj_lag)

compare_nested(inperson_ed_nb_adj_lag, inperson_ed_mnb_adj_lag)

compare_alphas(inperson_ed_mnb_lag, inperson_ed_mnb_adj_lag)
AICtab(inperson_ed_mnb_lag, inperson_ed_mnb_adj_lag)

### compare to multilevel poisson

inperson_ed_mp_adj_lag <- update(inperson_ed_p_adj_lag, add_cve)

countsummary(inperson_ed_mp_adj_lag)

compare_nested(inperson_ed_mp_adj_lag, inperson_ed_mnb_adj_lag)

compare_nested(inperson_ed_p_adj_lag, inperson_ed_mp_adj_lag)


### Add risk heterogeneity

inperson_ed_nb_risk <- update(inperson_ed_nb_null, add_risk)

countsummary(inperson_ed_nb_risk)

compare_alphas(inperson_ed_nb_null, inperson_ed_nb_risk)

# compare to poisson

inperson_ed_p_risk <- update(inperson_ed_nb_risk, family = "poisson")

lrtest(inperson_ed_p_risk, inperson_ed_nb_risk)

### Add lag and compare

inperson_ed_nb_risk_adj_lag <- update(inperson_ed_nb_risk, add_inperson_adj_lag)

countsummary(inperson_ed_nb_risk_adj_lag)

compare_alphas(inperson_ed_nb_risk_lag, inperson_ed_nb_risk_adj_lag)
AICtab(inperson_ed_nb_risk_lag, inperson_ed_nb_risk_adj_lag)

### Compare adding lag to risk

lrtest(inperson_ed_nb_risk, inperson_ed_nb_risk_adj_lag)
compare_alphas(inperson_ed_nb_risk, inperson_ed_nb_risk_adj_lag)

## Compare adding risk to lag

lrtest(inperson_ed_nb_adj_lag, inperson_ed_nb_risk_adj_lag)
compare_alphas(inperson_ed_nb_adj_lag, inperson_ed_nb_risk_adj_lag)

## poisson risk lag

inperson_ed_p_risk_adj_lag <- update(inperson_ed_nb_risk_adj_lag,
                                family ="poisson")

countsummary(inperson_ed_p_risk_adj_lag)
compare_nested(inperson_ed_p_risk_adj_lag, inperson_ed_nb_risk_adj_lag)

### Add multilevel

inperson_ed_mnb_risk <- update(inperson_ed_nb_risk, add_cve)

countsummary(inperson_ed_mnb_risk)

compare_nested(inperson_ed_nb_risk, inperson_ed_mnb_risk)

# multilevel poisson

inperson_ed_mp_risk <- update(inperson_ed_p_risk, add_cve)

countsummary(inperson_ed_mp_risk)

compare_nested(inperson_ed_mnb_risk, inperson_ed_mp_risk)

compare_nested(inperson_ed_p_risk, inperson_ed_mp_risk)

## add lag

inperson_ed_mnb_risk_adj_lag <- update(inperson_ed_mnb_risk, add_inperson_adj_lag)

countsummary(inperson_ed_mnb_risk_adj_lag)

compare_nested(inperson_ed_nb_risk_adj_lag, inperson_ed_mnb_risk_adj_lag)

compare_alphas(inperson_ed_mnb_risk_lag, inperson_ed_mnb_risk_adj_lag)
AICtab(inperson_ed_mnb_risk_lag, inperson_ed_mnb_risk_adj_lag)

### Compare adding lag to risk

lrtest(inperson_ed_mnb_risk, inperson_ed_mnb_risk_adj_lag)
compare_alphas(inperson_ed_mnb_risk, inperson_ed_mnb_risk_adj_lag)

## Compare adding risk to lag

lrtest(inperson_ed_mnb_adj_lag, inperson_ed_mnb_risk_adj_lag)
compare_alphas(inperson_ed_mnb_adj_lag, inperson_ed_mnb_risk_adj_lag)

## m poisson risk lag

inperson_ed_mp_risk_adj_lag <- update(inperson_ed_mnb_risk_adj_lag,
                                family ="poisson")

countsummary(inperson_ed_mp_risk_adj_lag)
compare_nested(inperson_ed_mp_risk_adj_lag, inperson_ed_mnb_risk_adj_lag)

####### Test event dependence term using compliance cats #######

inperson_ed_nb_ext_comp <- update(inperson_ed_nb_null, add_inperson_comp)

countsummary(inperson_ed_nb_ext_comp)

compare_alphas(inperson_ed_nb_null, inperson_ed_nb_ext_comp)

compare_alphas(inperson_ed_nb_lag, inperson_ed_nb_ext_comp)

## Compare to poisson

inperson_ed_p_ext_comp <- update(inperson_ed_nb_ext_comp,
                           family = "poisson")

countsummary(inperson_ed_p_ext_comp)

compare_nested(inperson_ed_p_ext_comp, inperson_ed_nb_ext_comp)

### Compare to multilevel

inperson_ed_mnb_ext_comp <- update(inperson_ed_nb_ext_comp, add_cve)

countsummary(inperson_ed_mnb_ext_comp)

compare_nested(inperson_ed_nb_ext_comp, inperson_ed_mnb_ext_comp)

compare_alphas(inperson_ed_mnb_lag, inperson_ed_mnb_ext_comp)
AICtab(inperson_ed_mnb_lag, inperson_ed_mnb_ext_comp)

### compare to multilevel poisson

inperson_ed_mp_ext_comp <- update(inperson_ed_p_ext_comp, add_cve)

countsummary(inperson_ed_mp_ext_comp)

compare_nested(inperson_ed_mp_ext_comp, inperson_ed_mnb_ext_comp)

compare_nested(inperson_ed_p_ext_comp, inperson_ed_mp_ext_comp)


### Add risk heterogeneity

inperson_ed_nb_risk <- update(inperson_ed_nb_null, add_risk)

countsummary(inperson_ed_nb_risk)

compare_alphas(inperson_ed_nb_null, inperson_ed_nb_risk)

# compare to poisson

inperson_ed_p_risk <- update(inperson_ed_nb_risk, family = "poisson")

lrtest(inperson_ed_p_risk, inperson_ed_nb_risk)

### Add lag and compare

inperson_ed_nb_risk_ext_comp <- update(inperson_ed_nb_risk, add_inperson_comp)

countsummary(inperson_ed_nb_risk_ext_comp)

compare_alphas(inperson_ed_nb_risk_lag, inperson_ed_nb_risk_ext_comp)
AICtab(inperson_ed_nb_risk_lag, inperson_ed_nb_risk_ext_comp)

### Compare adding lag to risk

lrtest(inperson_ed_nb_risk, inperson_ed_nb_risk_ext_comp)
compare_alphas(inperson_ed_nb_risk, inperson_ed_nb_risk_ext_comp)

## Compare adding risk to lag

lrtest(inperson_ed_nb_ext_comp, inperson_ed_nb_risk_ext_comp)
compare_alphas(inperson_ed_nb_ext_comp, inperson_ed_nb_risk_ext_comp)

## poisson risk lag

inperson_ed_p_risk_ext_comp <- update(inperson_ed_nb_risk_ext_comp,
                                family ="poisson")

countsummary(inperson_ed_p_risk_ext_comp)
compare_nested(inperson_ed_p_risk_ext_comp, inperson_ed_nb_risk_ext_comp)

### Add multilevel

inperson_ed_mnb_risk <- update(inperson_ed_nb_risk, add_cve)

countsummary(inperson_ed_mnb_risk)

compare_nested(inperson_ed_nb_risk, inperson_ed_mnb_risk)

# multilevel poisson

inperson_ed_mp_risk <- update(inperson_ed_p_risk, add_cve)

countsummary(inperson_ed_mp_risk)

compare_nested(inperson_ed_mnb_risk, inperson_ed_mp_risk)

compare_nested(inperson_ed_p_risk, inperson_ed_mp_risk)

## add lag

inperson_ed_mnb_risk_ext_comp <- update(inperson_ed_mnb_risk, add_inperson_comp)

countsummary(inperson_ed_mnb_risk_ext_comp)

compare_nested(inperson_ed_nb_risk_ext_comp, inperson_ed_mnb_risk_ext_comp)

compare_alphas(inperson_ed_mnb_risk_lag, inperson_ed_mnb_risk_ext_comp)
AICtab(inperson_ed_mnb_risk_lag, inperson_ed_mnb_risk_ext_comp)

### Compare adding lag to risk

lrtest(inperson_ed_mnb_risk, inperson_ed_mnb_risk_ext_comp)
compare_alphas(inperson_ed_mnb_risk, inperson_ed_mnb_risk_ext_comp)

## Compare adding risk to lag

lrtest(inperson_ed_mnb_ext_comp, inperson_ed_mnb_risk_ext_comp)
compare_alphas(inperson_ed_mnb_ext_comp, inperson_ed_mnb_risk_ext_comp)

## m poisson risk lag

inperson_ed_mp_risk_ext_comp <- update(inperson_ed_mnb_risk_ext_comp,
                                family ="poisson")

countsummary(inperson_ed_mp_risk_ext_comp)
compare_nested(inperson_ed_mp_risk_ext_comp, inperson_ed_mnb_risk_ext_comp)

####### Test event dependence term using binary lag #######

inperson_ed_nb_binlag <- update(inperson_ed_nb_null, add_inperson_binlag)

countsummary(inperson_ed_nb_binlag)

compare_alphas(inperson_ed_nb_null, inperson_ed_nb_binlag)

compare_alphas(inperson_ed_nb_lag, inperson_ed_nb_binlag)

## Compare to poisson

inperson_ed_p_binlag <- update(inperson_ed_nb_binlag,
                           family = "poisson")

countsummary(inperson_ed_p_binlag)

compare_nested(inperson_ed_p_binlag, inperson_ed_nb_binlag)

### Compare to multilevel

inperson_ed_mnb_binlag <- update(inperson_ed_nb_binlag, add_cve)

countsummary(inperson_ed_mnb_binlag)

compare_nested(inperson_ed_nb_binlag, inperson_ed_mnb_binlag)

compare_alphas(inperson_ed_mnb_lag, inperson_ed_mnb_binlag)
AICtab(inperson_ed_mnb_lag, inperson_ed_mnb_binlag)

### compare to multilevel poisson

inperson_ed_mp_binlag <- update(inperson_ed_p_binlag, add_cve)

countsummary(inperson_ed_mp_binlag)

compare_nested(inperson_ed_mp_binlag, inperson_ed_mnb_binlag)

compare_nested(inperson_ed_p_binlag, inperson_ed_mp_binlag)


### Add risk heterogeneity

inperson_ed_nb_risk <- update(inperson_ed_nb_null, add_risk)

countsummary(inperson_ed_nb_risk)

compare_alphas(inperson_ed_nb_null, inperson_ed_nb_risk)

# compare to poisson

inperson_ed_p_risk <- update(inperson_ed_nb_risk, family = "poisson")

lrtest(inperson_ed_p_risk, inperson_ed_nb_risk)

### Add lag and compare

inperson_ed_nb_risk_binlag <- update(inperson_ed_nb_risk, add_inperson_binlag)

countsummary(inperson_ed_nb_risk_binlag)

compare_alphas(inperson_ed_nb_risk_lag, inperson_ed_nb_risk_binlag)
AICtab(inperson_ed_nb_risk_lag, inperson_ed_nb_risk_binlag)

### Compare adding lag to risk

lrtest(inperson_ed_nb_risk, inperson_ed_nb_risk_binlag)
compare_alphas(inperson_ed_nb_risk, inperson_ed_nb_risk_binlag)

## Compare adding risk to lag

lrtest(inperson_ed_nb_binlag, inperson_ed_nb_risk_binlag)
compare_alphas(inperson_ed_nb_binlag, inperson_ed_nb_risk_binlag)

## poisson risk lag

inperson_ed_p_risk_binlag <- update(inperson_ed_nb_risk_binlag,
                                family ="poisson")

countsummary(inperson_ed_p_risk_binlag)
compare_nested(inperson_ed_p_risk_binlag, inperson_ed_nb_risk_binlag)

### Add multilevel

inperson_ed_mnb_risk <- update(inperson_ed_nb_risk, add_cve)

countsummary(inperson_ed_mnb_risk)

compare_nested(inperson_ed_nb_risk, inperson_ed_mnb_risk)

# multilevel poisson

inperson_ed_mp_risk <- update(inperson_ed_p_risk, add_cve)

countsummary(inperson_ed_mp_risk)

compare_nested(inperson_ed_mnb_risk, inperson_ed_mp_risk)

compare_nested(inperson_ed_p_risk, inperson_ed_mp_risk)

## add lag

inperson_ed_mnb_risk_binlag <- update(inperson_ed_mnb_risk, add_inperson_binlag)

countsummary(inperson_ed_mnb_risk_binlag)

compare_nested(inperson_ed_nb_risk_binlag, inperson_ed_mnb_risk_binlag)

compare_alphas(inperson_ed_mnb_risk_lag, inperson_ed_mnb_risk_binlag)
AICtab(inperson_ed_mnb_risk_lag, inperson_ed_mnb_risk_binlag)

### Compare adding lag to risk

lrtest(inperson_ed_mnb_risk, inperson_ed_mnb_risk_binlag)
compare_alphas(inperson_ed_mnb_risk, inperson_ed_mnb_risk_binlag)

## Compare adding risk to lag

lrtest(inperson_ed_mnb_binlag, inperson_ed_mnb_risk_binlag)
compare_alphas(inperson_ed_mnb_binlag, inperson_ed_mnb_risk_binlag)

## m poisson risk lag

inperson_ed_mp_risk_binlag <- update(inperson_ed_mnb_risk_binlag,
                                family ="poisson")

countsummary(inperson_ed_mp_risk_binlag)
compare_nested(inperson_ed_mp_risk_binlag, inperson_ed_mnb_risk_binlag)




```

Now estimate the effect of event dependence on prevalence.

```{r inperson-event-dependence-prevalence}


## Use enve_lag_nm_sem1

#### First test event dependence versus a null model

inperson_ed_logit_null <- update(inperson_ed_nb_null, mkbin(inperson) ~ .,
                                family = "binomial")

summary(inperson_ed_logit_null)

### Test event dependence term (then repeat for adjusted and compliance cats)

inperson_ed_logit_lag <- update(inperson_ed_logit_null, add_inperson_lag)

countsummary(inperson_ed_logit_lag)

compare_alphas(inperson_ed_logit_null, inperson_ed_logit_lag)


### Compare to multilevel

inperson_ed_mlogit_lag <- update(inperson_ed_logit_lag, add_cve)

countsummary(inperson_ed_mlogit_lag)

compare_nested(inperson_ed_logit_lag, inperson_ed_mlogit_lag)


### Add risk heterogeneity

inperson_ed_logit_risk <- update(inperson_ed_logit_null, add_risk)

countsummary(inperson_ed_logit_risk)

compare_alphas(inperson_ed_logit_null, inperson_ed_logit_risk)

### Add lag and compare

inperson_ed_logit_risk_lag <- update(inperson_ed_logit_risk, add_inperson_lag)

countsummary(inperson_ed_logit_risk_lag)

### Compare adding lag to risk

lrtest(inperson_ed_logit_risk, inperson_ed_logit_risk_lag)
compare_alphas(inperson_ed_logit_risk, inperson_ed_logit_risk_lag)

## Compare adding risk to lag

lrtest(inperson_ed_logit_lag, inperson_ed_logit_risk_lag)
compare_alphas(inperson_ed_logit_lag, inperson_ed_logit_risk_lag)


### Add multilevel

inperson_ed_mlogit_risk <- update(inperson_ed_logit_risk, add_cve)

countsummary(inperson_ed_mlogit_risk)

compare_nested(inperson_ed_logit_risk, inperson_ed_mlogit_risk)


## add lag

inperson_ed_mlogit_risk_lag <- update(inperson_ed_mlogit_risk, add_inperson_lag)

countsummary(inperson_ed_mlogit_risk_lag)

compare_nested(inperson_ed_logit_risk_lag, inperson_ed_mlogit_risk_lag)

### Compare adding lag to risk

lrtest(inperson_ed_mlogit_risk, inperson_ed_mlogit_risk_lag)
compare_alphas(inperson_ed_mlogit_risk, inperson_ed_mlogit_risk_lag)

## Compare adding risk to lag

lrtest(inperson_ed_mlogit_lag, inperson_ed_mlogit_risk_lag)
compare_alphas(inperson_ed_mlogit_lag, inperson_ed_mlogit_risk_lag)


####### Test event dependence term using adjusted rate #######

inperson_ed_logit_adj_lag <- update(inperson_ed_logit_null, add_inperson_adj_lag)

countsummary(inperson_ed_logit_adj_lag)

compare_alphas(inperson_ed_logit_null, inperson_ed_logit_adj_lag)

compare_alphas(inperson_ed_logit_lag, inperson_ed_logit_adj_lag)


### Compare to multilevel

inperson_ed_mlogit_adj_lag <- update(inperson_ed_logit_adj_lag, add_cve)

countsummary(inperson_ed_mlogit_adj_lag)

compare_nested(inperson_ed_logit_adj_lag, inperson_ed_mlogit_adj_lag)

compare_alphas(inperson_ed_mlogit_lag, inperson_ed_mlogit_adj_lag)
AICtab(inperson_ed_mlogit_lag, inperson_ed_mlogit_adj_lag)


### Add risk heterogeneity

inperson_ed_logit_risk <- update(inperson_ed_logit_null, add_risk)

countsummary(inperson_ed_logit_risk)

compare_alphas(inperson_ed_logit_null, inperson_ed_logit_risk)


### Add lag and compare

inperson_ed_logit_risk_adj_lag <- update(inperson_ed_logit_risk, add_inperson_adj_lag)

countsummary(inperson_ed_logit_risk_adj_lag)

compare_alphas(inperson_ed_logit_risk_lag, inperson_ed_logit_risk_adj_lag)
AICtab(inperson_ed_logit_risk_lag, inperson_ed_logit_risk_adj_lag)

### Compare adding lag to risk

lrtest(inperson_ed_logit_risk, inperson_ed_logit_risk_adj_lag)
compare_alphas(inperson_ed_logit_risk, inperson_ed_logit_risk_adj_lag)

## Compare adding risk to lag

lrtest(inperson_ed_logit_adj_lag, inperson_ed_logit_risk_adj_lag)
compare_alphas(inperson_ed_logit_adj_lag, inperson_ed_logit_risk_adj_lag)

### Add multilevel

inperson_ed_mlogit_risk <- update(inperson_ed_logit_risk, add_cve)

countsummary(inperson_ed_mlogit_risk)

compare_nested(inperson_ed_logit_risk, inperson_ed_mlogit_risk)

## add lag

inperson_ed_mlogit_risk_adj_lag <- update(inperson_ed_mlogit_risk, add_inperson_adj_lag)

countsummary(inperson_ed_mlogit_risk_adj_lag)

compare_nested(inperson_ed_logit_risk_adj_lag, inperson_ed_mlogit_risk_adj_lag)

compare_alphas(inperson_ed_mlogit_risk_lag, inperson_ed_mlogit_risk_adj_lag)
AICtab(inperson_ed_mlogit_risk_lag, inperson_ed_mlogit_risk_adj_lag)

### Compare adding lag to risk

lrtest(inperson_ed_mlogit_risk, inperson_ed_mlogit_risk_adj_lag)
compare_alphas(inperson_ed_mlogit_risk, inperson_ed_mlogit_risk_adj_lag)

## Compare adding risk to lag

lrtest(inperson_ed_mlogit_adj_lag, inperson_ed_mlogit_risk_adj_lag)
compare_alphas(inperson_ed_mlogit_adj_lag, inperson_ed_mlogit_risk_adj_lag)

####### Test event dependence term using compliance cats #######

inperson_ed_logit_ext_comp <- update(inperson_ed_logit_null, add_inperson_comp)

countsummary(inperson_ed_logit_ext_comp)

compare_alphas(inperson_ed_logit_null, inperson_ed_logit_ext_comp)

compare_alphas(inperson_ed_logit_lag, inperson_ed_logit_ext_comp)

### Compare to multilevel

inperson_ed_mlogit_ext_comp <- update(inperson_ed_logit_ext_comp, add_cve)

countsummary(inperson_ed_mlogit_ext_comp)

compare_nested(inperson_ed_logit_ext_comp, inperson_ed_mlogit_ext_comp)

compare_alphas(inperson_ed_mlogit_lag, inperson_ed_mlogit_ext_comp)
AICtab(inperson_ed_mlogit_lag, inperson_ed_mlogit_ext_comp)


### Add risk heterogeneity

inperson_ed_logit_risk <- update(inperson_ed_logit_null, add_risk)

countsummary(inperson_ed_logit_risk)

compare_alphas(inperson_ed_logit_null, inperson_ed_logit_risk)

# compare to poisson

inperson_ed_p_risk <- update(inperson_ed_logit_risk, family = "poisson")

lrtest(inperson_ed_p_risk, inperson_ed_logit_risk)

### Add lag and compare

inperson_ed_logit_risk_ext_comp <- update(inperson_ed_logit_risk, add_inperson_comp)

countsummary(inperson_ed_logit_risk_ext_comp)

compare_alphas(inperson_ed_logit_risk_lag, inperson_ed_logit_risk_ext_comp)
AICtab(inperson_ed_logit_risk_lag, inperson_ed_logit_risk_ext_comp)

### Compare adding lag to risk

lrtest(inperson_ed_logit_risk, inperson_ed_logit_risk_ext_comp)
compare_alphas(inperson_ed_logit_risk, inperson_ed_logit_risk_ext_comp)

## Compare adding risk to lag

lrtest(inperson_ed_logit_ext_comp, inperson_ed_logit_risk_ext_comp)
compare_alphas(inperson_ed_logit_ext_comp, inperson_ed_logit_risk_ext_comp)

### Add multilevel

inperson_ed_mlogit_risk <- update(inperson_ed_logit_risk, add_cve)

countsummary(inperson_ed_mlogit_risk)

compare_nested(inperson_ed_logit_risk, inperson_ed_mlogit_risk)

## add lag

inperson_ed_mlogit_risk_ext_comp <- update(inperson_ed_mlogit_risk, add_inperson_comp)

countsummary(inperson_ed_mlogit_risk_ext_comp)

compare_nested(inperson_ed_logit_risk_ext_comp, inperson_ed_mlogit_risk_ext_comp)

compare_alphas(inperson_ed_mlogit_risk_lag, inperson_ed_mlogit_risk_ext_comp)
AICtab(inperson_ed_mlogit_risk_lag, inperson_ed_mlogit_risk_ext_comp)

### Compare adding lag to risk

lrtest(inperson_ed_mlogit_risk, inperson_ed_mlogit_risk_ext_comp)
compare_alphas(inperson_ed_mlogit_risk, inperson_ed_mlogit_risk_ext_comp)

## Compare adding risk to lag

lrtest(inperson_ed_mlogit_ext_comp, inperson_ed_mlogit_risk_ext_comp)
compare_alphas(inperson_ed_mlogit_ext_comp, inperson_ed_mlogit_risk_ext_comp)

####### Test event dependence term using binary lag #######

inperson_ed_logit_binlag <- update(inperson_ed_logit_null, add_inperson_binlag)

countsummary(inperson_ed_logit_binlag)

compare_alphas(inperson_ed_logit_null, inperson_ed_logit_binlag)

compare_alphas(inperson_ed_logit_lag, inperson_ed_logit_binlag)

### Compare to multilevel

inperson_ed_mlogit_binlag <- update(inperson_ed_logit_binlag, add_cve)

countsummary(inperson_ed_mlogit_binlag)

compare_nested(inperson_ed_logit_binlag, inperson_ed_mlogit_binlag)

compare_alphas(inperson_ed_mlogit_lag, inperson_ed_mlogit_binlag)
AICtab(inperson_ed_mlogit_lag, inperson_ed_mlogit_binlag)


### Add risk heterogeneity

inperson_ed_logit_risk <- update(inperson_ed_logit_null, add_risk)

countsummary(inperson_ed_logit_risk)

compare_alphas(inperson_ed_logit_null, inperson_ed_logit_risk)

# compare to poisson

inperson_ed_p_risk <- update(inperson_ed_logit_risk, family = "poisson")

lrtest(inperson_ed_p_risk, inperson_ed_logit_risk)

### Add lag and compare

inperson_ed_logit_risk_binlag <- update(inperson_ed_logit_risk, add_inperson_binlag)

countsummary(inperson_ed_logit_risk_binlag)

compare_alphas(inperson_ed_logit_risk_lag, inperson_ed_logit_risk_binlag)
AICtab(inperson_ed_logit_risk_lag, inperson_ed_logit_risk_binlag)

### Compare adding lag to risk

lrtest(inperson_ed_logit_risk, inperson_ed_logit_risk_binlag)
compare_alphas(inperson_ed_logit_risk, inperson_ed_logit_risk_binlag)

## Compare adding risk to lag

lrtest(inperson_ed_logit_binlag, inperson_ed_logit_risk_binlag)
compare_alphas(inperson_ed_logit_binlag, inperson_ed_logit_risk_binlag)

### Add multilevel

inperson_ed_mlogit_risk <- update(inperson_ed_logit_risk, add_cve)

countsummary(inperson_ed_mlogit_risk)

compare_nested(inperson_ed_logit_risk, inperson_ed_mlogit_risk)

## add lag

inperson_ed_mlogit_risk_binlag <- update(inperson_ed_mlogit_risk, add_inperson_binlag)

countsummary(inperson_ed_mlogit_risk_binlag)

compare_nested(inperson_ed_logit_risk_binlag, inperson_ed_mlogit_risk_binlag)

compare_alphas(inperson_ed_mlogit_risk_lag, inperson_ed_mlogit_risk_binlag)
AICtab(inperson_ed_mlogit_risk_lag, inperson_ed_mlogit_risk_binlag)

### Compare adding lag to risk

lrtest(inperson_ed_mlogit_risk, inperson_ed_mlogit_risk_binlag)
compare_alphas(inperson_ed_mlogit_risk, inperson_ed_mlogit_risk_binlag)

## Compare adding risk to lag

lrtest(inperson_ed_mlogit_binlag, inperson_ed_mlogit_risk_binlag)
compare_alphas(inperson_ed_mlogit_binlag, inperson_ed_mlogit_risk_binlag)


```

Next, estimate the effect of event dependence in the truncated count.

```{r inperson-event-dependence-concentration}


## Use enve_lag_nm_sem1

#### First test event dependence versus a null model

inperson_ed_tnb_null <- update(inperson_ed_nb_null,
                             data = subset(enve_lag_nm_sem1, inperson > 0),
                             family = "truncated_nbinom2")

summary(inperson_ed_tnb_null)

### Test event dependence term (then repeat for adjusted and compliance cats)

inperson_ed_tnb_lag <- update(inperson_ed_tnb_null, add_inperson_lag)

countsummary(inperson_ed_tnb_lag)

compare_alphas(inperson_ed_tnb_null, inperson_ed_tnb_lag)

## Compare to poisson

inperson_ed_tp_lag <- update(inperson_ed_tnb_lag,
                           family = "truncated_poisson")

countsummary(inperson_ed_tp_lag)

compare_nested(inperson_ed_tp_lag, inperson_ed_tnb_lag)

### Compare to multilevel

inperson_ed_mtnb_lag <- update(inperson_ed_tnb_lag, add_cve)

countsummary(inperson_ed_mtnb_lag)

compare_nested(inperson_ed_tnb_lag, inperson_ed_mtnb_lag)

### compare to multilevel poisson

inperson_ed_mtp_lag <- update(inperson_ed_tp_lag, add_cve)

countsummary(inperson_ed_mtp_lag)

compare_nested(inperson_ed_mtp_lag, inperson_ed_mtnb_lag)

compare_nested(inperson_ed_tp_lag, inperson_ed_mtp_lag)


### Add risk heterogeneity

inperson_ed_tnb_risk <- update(inperson_ed_tnb_null, add_risk)

countsummary(inperson_ed_tnb_risk)

compare_alphas(inperson_ed_tnb_null, inperson_ed_tnb_risk)

# compare to poisson

inperson_ed_tp_risk <- update(inperson_ed_tnb_risk, family = "truncated_poisson")

lrtest(inperson_ed_tp_risk, inperson_ed_tnb_risk)

### Add lag and compare

inperson_ed_tnb_risk_lag <- update(inperson_ed_tnb_risk, add_inperson_lag)

countsummary(inperson_ed_tnb_risk_lag)

### Compare adding lag to risk

lrtest(inperson_ed_tnb_risk, inperson_ed_tnb_risk_lag)
compare_alphas(inperson_ed_tnb_risk, inperson_ed_tnb_risk_lag)

## Compare adding risk to lag

lrtest(inperson_ed_tnb_lag, inperson_ed_tnb_risk_lag)
compare_alphas(inperson_ed_tnb_lag, inperson_ed_tnb_risk_lag)

## poisson risk lag

inperson_ed_tp_risk_lag <- update(inperson_ed_tnb_risk_lag,
                                family ="truncated_poisson")

countsummary(inperson_ed_tp_risk_lag)
compare_nested(inperson_ed_tp_risk_lag, inperson_ed_tnb_risk_lag)

### Add multilevel

inperson_ed_mtnb_risk <- update(inperson_ed_tnb_risk, add_cve)

countsummary(inperson_ed_mtnb_risk)

compare_nested(inperson_ed_tnb_risk, inperson_ed_mtnb_risk)

# multilevel poisson

inperson_ed_mtp_risk <- update(inperson_ed_tp_risk, add_cve)

countsummary(inperson_ed_mtp_risk)

compare_nested(inperson_ed_mtnb_risk, inperson_ed_mtp_risk)

compare_nested(inperson_ed_tp_risk, inperson_ed_mtp_risk)

## add lag

inperson_ed_mtnb_risk_lag <- update(inperson_ed_mtnb_risk, add_inperson_lag)

countsummary(inperson_ed_mtnb_risk_lag)

compare_nested(inperson_ed_tnb_risk_lag, inperson_ed_mtnb_risk_lag)

### Compare adding lag to risk

lrtest(inperson_ed_mtnb_risk, inperson_ed_mtnb_risk_lag)
compare_alphas(inperson_ed_mtnb_risk, inperson_ed_mtnb_risk_lag)

## Compare adding risk to lag

lrtest(inperson_ed_mtnb_lag, inperson_ed_mtnb_risk_lag)
compare_alphas(inperson_ed_mtnb_lag, inperson_ed_mtnb_risk_lag)

## m poisson risk lag

inperson_ed_mtp_risk_lag <- update(inperson_ed_mtnb_risk_lag,
                                family ="truncated_poisson")

countsummary(inperson_ed_mtp_risk_lag)
compare_nested(inperson_ed_mtp_risk_lag, inperson_ed_mtnb_risk_lag)


####### Test event dependence term using adjusted rate #######

inperson_ed_tnb_adj_lag <- update(inperson_ed_tnb_null, add_inperson_adj_lag)

countsummary(inperson_ed_tnb_adj_lag)

compare_alphas(inperson_ed_tnb_null, inperson_ed_tnb_adj_lag)

compare_alphas(inperson_ed_tnb_lag, inperson_ed_tnb_adj_lag)

## Compare to poisson

inperson_ed_tp_adj_lag <- update(inperson_ed_tnb_adj_lag,
                           family = "truncated_poisson")

countsummary(inperson_ed_tp_adj_lag)

compare_nested(inperson_ed_tp_adj_lag, inperson_ed_tnb_adj_lag)

### Compare to multilevel

inperson_ed_mtnb_adj_lag <- update(inperson_ed_tnb_adj_lag, add_cve)

countsummary(inperson_ed_mtnb_adj_lag)

compare_nested(inperson_ed_tnb_adj_lag, inperson_ed_mtnb_adj_lag)

compare_alphas(inperson_ed_mtnb_lag, inperson_ed_mtnb_adj_lag)
AICtab(inperson_ed_mtnb_lag, inperson_ed_mtnb_adj_lag)

### compare to multilevel poisson

inperson_ed_mtp_adj_lag <- update(inperson_ed_tp_adj_lag, add_cve)

countsummary(inperson_ed_mtp_adj_lag)

compare_nested(inperson_ed_mtp_adj_lag, inperson_ed_mtnb_adj_lag)

compare_nested(inperson_ed_tp_adj_lag, inperson_ed_mtp_adj_lag)


### Add risk heterogeneity

inperson_ed_tnb_risk <- update(inperson_ed_tnb_null, add_risk)

countsummary(inperson_ed_tnb_risk)

compare_alphas(inperson_ed_tnb_null, inperson_ed_tnb_risk)

# compare to poisson

inperson_ed_tp_risk <- update(inperson_ed_tnb_risk, family = "truncated_poisson")

lrtest(inperson_ed_tp_risk, inperson_ed_tnb_risk)

### Add lag and compare

inperson_ed_tnb_risk_adj_lag <- update(inperson_ed_tnb_risk, add_inperson_adj_lag)

countsummary(inperson_ed_tnb_risk_adj_lag)

compare_alphas(inperson_ed_tnb_risk_lag, inperson_ed_tnb_risk_adj_lag)
AICtab(inperson_ed_tnb_risk_lag, inperson_ed_tnb_risk_adj_lag)

### Compare adding lag to risk

lrtest(inperson_ed_tnb_risk, inperson_ed_tnb_risk_adj_lag)
compare_alphas(inperson_ed_tnb_risk, inperson_ed_tnb_risk_adj_lag)

## Compare adding risk to lag

lrtest(inperson_ed_tnb_adj_lag, inperson_ed_tnb_risk_adj_lag)
compare_alphas(inperson_ed_tnb_adj_lag, inperson_ed_tnb_risk_adj_lag)

## poisson risk lag

inperson_ed_tp_risk_adj_lag <- update(inperson_ed_tnb_risk_adj_lag,
                                family ="truncated_poisson")

countsummary(inperson_ed_tp_risk_adj_lag)
compare_nested(inperson_ed_tp_risk_adj_lag, inperson_ed_tnb_risk_adj_lag)

### Add multilevel

inperson_ed_mtnb_risk <- update(inperson_ed_tnb_risk, add_cve)

countsummary(inperson_ed_mtnb_risk)

compare_nested(inperson_ed_tnb_risk, inperson_ed_mtnb_risk)

# multilevel poisson

inperson_ed_mtp_risk <- update(inperson_ed_tp_risk, add_cve)

countsummary(inperson_ed_mtp_risk)

compare_nested(inperson_ed_mtnb_risk, inperson_ed_mtp_risk)

compare_nested(inperson_ed_tp_risk, inperson_ed_mtp_risk)

## add lag

inperson_ed_mtnb_risk_adj_lag <- update(inperson_ed_mtnb_risk, add_inperson_adj_lag)

countsummary(inperson_ed_mtnb_risk_adj_lag)

compare_nested(inperson_ed_tnb_risk_adj_lag, inperson_ed_mtnb_risk_adj_lag)

compare_alphas(inperson_ed_mtnb_risk_lag, inperson_ed_mtnb_risk_adj_lag)
AICtab(inperson_ed_mtnb_risk_lag, inperson_ed_mtnb_risk_adj_lag)

### Compare adding lag to risk

lrtest(inperson_ed_mtnb_risk, inperson_ed_mtnb_risk_adj_lag)
compare_alphas(inperson_ed_mtnb_risk, inperson_ed_mtnb_risk_adj_lag)

## Compare adding risk to lag

lrtest(inperson_ed_mtnb_adj_lag, inperson_ed_mtnb_risk_adj_lag)
compare_alphas(inperson_ed_mtnb_adj_lag, inperson_ed_mtnb_risk_adj_lag)

## m poisson risk lag

inperson_ed_mtp_risk_adj_lag <- update(inperson_ed_mtnb_risk_adj_lag,
                                family ="truncated_poisson")

countsummary(inperson_ed_mtp_risk_adj_lag)
compare_nested(inperson_ed_mtp_risk_adj_lag, inperson_ed_mtnb_risk_adj_lag)

####### Test event dependence term using compliance cats #######

inperson_ed_tnb_ext_comp <- update(inperson_ed_tnb_null, add_inperson_comp)

countsummary(inperson_ed_tnb_ext_comp)

compare_alphas(inperson_ed_tnb_null, inperson_ed_tnb_ext_comp)

compare_alphas(inperson_ed_tnb_lag, inperson_ed_tnb_ext_comp)

## Compare to poisson

inperson_ed_tp_ext_comp <- update(inperson_ed_tnb_ext_comp,
                           family = "truncated_poisson")

countsummary(inperson_ed_tp_ext_comp)

compare_nested(inperson_ed_tp_ext_comp, inperson_ed_tnb_ext_comp)

### Compare to multilevel

inperson_ed_mtnb_ext_comp <- update(inperson_ed_tnb_ext_comp, add_cve)

countsummary(inperson_ed_mtnb_ext_comp)

compare_nested(inperson_ed_tnb_ext_comp, inperson_ed_mtnb_ext_comp)

compare_alphas(inperson_ed_mtnb_lag, inperson_ed_mtnb_ext_comp)
AICtab(inperson_ed_mtnb_lag, inperson_ed_mtnb_ext_comp)

### compare to multilevel poisson

inperson_ed_mtp_ext_comp <- update(inperson_ed_tp_ext_comp, add_cve)

countsummary(inperson_ed_mtp_ext_comp)

compare_nested(inperson_ed_mtp_ext_comp, inperson_ed_mtnb_ext_comp)

compare_nested(inperson_ed_tp_ext_comp, inperson_ed_mtp_ext_comp)


### Add risk heterogeneity

inperson_ed_tnb_risk <- update(inperson_ed_tnb_null, add_risk)

countsummary(inperson_ed_tnb_risk)

compare_alphas(inperson_ed_tnb_null, inperson_ed_tnb_risk)

# compare to poisson

inperson_ed_tp_risk <- update(inperson_ed_tnb_risk, family = "truncated_poisson")

lrtest(inperson_ed_tp_risk, inperson_ed_tnb_risk)

### Add lag and compare

inperson_ed_tnb_risk_ext_comp <- update(inperson_ed_tnb_risk, add_inperson_comp)

countsummary(inperson_ed_tnb_risk_ext_comp)

compare_alphas(inperson_ed_tnb_risk_lag, inperson_ed_tnb_risk_ext_comp)
AICtab(inperson_ed_tnb_risk_lag, inperson_ed_tnb_risk_ext_comp)

### Compare adding lag to risk

lrtest(inperson_ed_tnb_risk, inperson_ed_tnb_risk_ext_comp)
compare_alphas(inperson_ed_tnb_risk, inperson_ed_tnb_risk_ext_comp)

## Compare adding risk to lag

lrtest(inperson_ed_tnb_ext_comp, inperson_ed_tnb_risk_ext_comp)
compare_alphas(inperson_ed_tnb_ext_comp, inperson_ed_tnb_risk_ext_comp)

## poisson risk lag

inperson_ed_tp_risk_ext_comp <- update(inperson_ed_tnb_risk_ext_comp,
                                family ="truncated_poisson")

countsummary(inperson_ed_tp_risk_ext_comp)
compare_nested(inperson_ed_tp_risk_ext_comp, inperson_ed_tnb_risk_ext_comp)

### Add multilevel

inperson_ed_mtnb_risk <- update(inperson_ed_tnb_risk, add_cve)

countsummary(inperson_ed_mtnb_risk)

compare_nested(inperson_ed_tnb_risk, inperson_ed_mtnb_risk)

# multilevel poisson

inperson_ed_mtp_risk <- update(inperson_ed_tp_risk, add_cve)

countsummary(inperson_ed_mtp_risk)

compare_nested(inperson_ed_mtnb_risk, inperson_ed_mtp_risk)

compare_nested(inperson_ed_tp_risk, inperson_ed_mtp_risk)

## add lag

inperson_ed_mtnb_risk_ext_comp <- update(inperson_ed_mtnb_risk, add_inperson_comp)

countsummary(inperson_ed_mtnb_risk_ext_comp)

compare_nested(inperson_ed_tnb_risk_ext_comp, inperson_ed_mtnb_risk_ext_comp)

compare_alphas(inperson_ed_mtnb_risk_lag, inperson_ed_mtnb_risk_ext_comp)
AICtab(inperson_ed_mtnb_risk_lag, inperson_ed_mtnb_risk_ext_comp)

### Compare adding lag to risk

lrtest(inperson_ed_mtnb_risk, inperson_ed_mtnb_risk_ext_comp)
compare_alphas(inperson_ed_mtnb_risk, inperson_ed_mtnb_risk_ext_comp)

## Compare adding risk to lag

lrtest(inperson_ed_mtnb_ext_comp, inperson_ed_mtnb_risk_ext_comp)
compare_alphas(inperson_ed_mtnb_ext_comp, inperson_ed_mtnb_risk_ext_comp)

## m poisson risk lag

inperson_ed_mtp_risk_ext_comp <- update(inperson_ed_mtnb_risk_ext_comp,
                                family ="truncated_poisson")

countsummary(inperson_ed_mtp_risk_ext_comp)
compare_nested(inperson_ed_mtp_risk_ext_comp, inperson_ed_mtnb_risk_ext_comp)


####### Test event dependence term using binary lag #######

inperson_ed_tnb_ext_binlag <- update(inperson_ed_tnb_null, add_inperson_binlag)

countsummary(inperson_ed_tnb_ext_binlag)

compare_alphas(inperson_ed_tnb_null, inperson_ed_tnb_ext_binlag)

compare_alphas(inperson_ed_tnb_lag, inperson_ed_tnb_ext_binlag)

## Compare to poisson

inperson_ed_tp_ext_binlag <- update(inperson_ed_tnb_ext_binlag,
                           family = "truncated_poisson")

countsummary(inperson_ed_tp_ext_binlag)

compare_nested(inperson_ed_tp_ext_binlag, inperson_ed_tnb_ext_binlag)

### Compare to multilevel

inperson_ed_mtnb_ext_binlag <- update(inperson_ed_tnb_ext_binlag, add_cve)

countsummary(inperson_ed_mtnb_ext_binlag)

compare_nested(inperson_ed_tnb_ext_binlag, inperson_ed_mtnb_ext_binlag)

compare_alphas(inperson_ed_mtnb_lag, inperson_ed_mtnb_ext_binlag)
AICtab(inperson_ed_mtnb_lag, inperson_ed_mtnb_ext_binlag)

### compare to multilevel poisson

inperson_ed_mtp_ext_binlag <- update(inperson_ed_tp_ext_binlag, add_cve)

countsummary(inperson_ed_mtp_ext_binlag)

compare_nested(inperson_ed_mtp_ext_binlag, inperson_ed_mtnb_ext_binlag)

compare_nested(inperson_ed_tp_ext_binlag, inperson_ed_mtp_ext_binlag)


### Add risk heterogeneity

inperson_ed_tnb_risk <- update(inperson_ed_tnb_null, add_risk)

countsummary(inperson_ed_tnb_risk)

compare_alphas(inperson_ed_tnb_null, inperson_ed_tnb_risk)

# compare to poisson

inperson_ed_tp_risk <- update(inperson_ed_tnb_risk, family = "truncated_poisson")

lrtest(inperson_ed_tp_risk, inperson_ed_tnb_risk)

### Add lag and compare

inperson_ed_tnb_risk_ext_binlag <- update(inperson_ed_tnb_risk, add_inperson_binlag)

countsummary(inperson_ed_tnb_risk_ext_binlag)

compare_alphas(inperson_ed_tnb_risk_lag, inperson_ed_tnb_risk_ext_binlag)
AICtab(inperson_ed_tnb_risk_lag, inperson_ed_tnb_risk_ext_binlag)

### Compare adding lag to risk

lrtest(inperson_ed_tnb_risk, inperson_ed_tnb_risk_ext_binlag)
compare_alphas(inperson_ed_tnb_risk, inperson_ed_tnb_risk_ext_binlag)

## Compare adding risk to lag

lrtest(inperson_ed_tnb_ext_binlag, inperson_ed_tnb_risk_ext_binlag)
compare_alphas(inperson_ed_tnb_ext_binlag, inperson_ed_tnb_risk_ext_binlag)

## poisson risk lag

inperson_ed_tp_risk_ext_binlag <- update(inperson_ed_tnb_risk_ext_binlag,
                                family ="truncated_poisson")

countsummary(inperson_ed_tp_risk_ext_binlag)
compare_nested(inperson_ed_tp_risk_ext_binlag, inperson_ed_tnb_risk_ext_binlag)

### Add multilevel

inperson_ed_mtnb_risk <- update(inperson_ed_tnb_risk, add_cve)

countsummary(inperson_ed_mtnb_risk)

compare_nested(inperson_ed_tnb_risk, inperson_ed_mtnb_risk)

# multilevel poisson

inperson_ed_mtp_risk <- update(inperson_ed_tp_risk, add_cve)

countsummary(inperson_ed_mtp_risk)

compare_nested(inperson_ed_mtnb_risk, inperson_ed_mtp_risk)

compare_nested(inperson_ed_tp_risk, inperson_ed_mtp_risk)

## add lag

inperson_ed_mtnb_risk_ext_binlag <- update(inperson_ed_mtnb_risk, add_inperson_binlag)

countsummary(inperson_ed_mtnb_risk_ext_binlag)

compare_nested(inperson_ed_tnb_risk_ext_binlag, inperson_ed_mtnb_risk_ext_binlag)

compare_alphas(inperson_ed_mtnb_risk_lag, inperson_ed_mtnb_risk_ext_binlag)
AICtab(inperson_ed_mtnb_risk_lag, inperson_ed_mtnb_risk_ext_binlag)

### Compare adding lag to risk

lrtest(inperson_ed_mtnb_risk, inperson_ed_mtnb_risk_ext_binlag)
compare_alphas(inperson_ed_mtnb_risk, inperson_ed_mtnb_risk_ext_binlag)

## Compare adding risk to lag

lrtest(inperson_ed_mtnb_ext_binlag, inperson_ed_mtnb_risk_ext_binlag)
compare_alphas(inperson_ed_mtnb_ext_binlag, inperson_ed_mtnb_risk_ext_binlag)

## m poisson risk lag

inperson_ed_mtp_risk_ext_binlag <- update(inperson_ed_mtnb_risk_ext_binlag,
                                family ="truncated_poisson")

countsummary(inperson_ed_mtp_risk_ext_binlag)
compare_nested(inperson_ed_mtp_risk_ext_binlag, inperson_ed_mtnb_risk_ext_binlag)




```

Repeat using glmmADMB


```{r inperson-event-dependence-concentration-glmmADMB}

## Use enve_lag_nm_sem1

#### First test event dependence versus a null model

inperson_admb_ed_tnb_null <- glmmadmb(formula(inperson_ed_tnb_null),
                             data = subset(enve_lag_nm_sem1, inperson > 0),
                             family = "truncnbinom",
                             zeroInflation = FALSE,
                             admb.opts = glmmADMB::admbControl(noinit = FALSE, shess=FALSE),
                             extra.args = "-ndi 60000")

summary(inperson_admb_ed_tnb_null)

### Test event dependence term (then repeat for adjusted and compliance cats)

inperson_admb_ed_tnb_lag <- update(inperson_admb_ed_tnb_null, add_inperson_lag)

countsummary(inperson_admb_ed_tnb_lag)

compare_alphas(inperson_admb_ed_tnb_null, inperson_admb_ed_tnb_lag)

## Compare to poisson

inperson_admb_ed_tp_lag <- update(inperson_admb_ed_tnb_lag,
                           family = "truncpoiss")

countsummary(inperson_admb_ed_tp_lag)

compare_nested(inperson_admb_ed_tp_lag, inperson_admb_ed_tnb_lag)

### Compare to multilevel

inperson_admb_ed_mtnb_lag <- update(inperson_admb_ed_tnb_lag, add_nom)

countsummary(inperson_admb_ed_mtnb_lag)

compare_nested(inperson_admb_ed_tnb_lag, inperson_admb_ed_mtnb_lag)

### compare to multilevel poisson

inperson_admb_ed_mtp_lag <- update(inperson_admb_ed_tp_lag, add_nom)

countsummary(inperson_admb_ed_mtp_lag)

compare_nested(inperson_admb_ed_mtp_lag, inperson_admb_ed_mtnb_lag)

compare_nested(inperson_admb_ed_tp_lag, inperson_admb_ed_mtp_lag)


### Add risk heterogeneity

inperson_admb_ed_tnb_risk <- update(inperson_admb_ed_tnb_null, add_risk)

countsummary(inperson_admb_ed_tnb_risk)

compare_alphas(inperson_admb_ed_tnb_null, inperson_admb_ed_tnb_risk)

# compare to poisson

inperson_admb_ed_tp_risk <- update(inperson_admb_ed_tnb_risk, family = "truncpoiss")

lrtest(inperson_admb_ed_tp_risk, inperson_admb_ed_tnb_risk)

### Add lag and compare

inperson_admb_ed_tnb_risk_lag <- update(inperson_admb_ed_tnb_risk, add_inperson_lag)

countsummary(inperson_admb_ed_tnb_risk_lag)

### Compare adding lag to risk

lrtest(inperson_admb_ed_tnb_risk, inperson_admb_ed_tnb_risk_lag)
compare_alphas(inperson_admb_ed_tnb_risk, inperson_admb_ed_tnb_risk_lag)

## Compare adding risk to lag

lrtest(inperson_admb_ed_tnb_lag, inperson_admb_ed_tnb_risk_lag)
compare_alphas(inperson_admb_ed_tnb_lag, inperson_admb_ed_tnb_risk_lag)

## poisson risk lag

inperson_admb_ed_tp_risk_lag <- update(inperson_admb_ed_tnb_risk_lag,
                                family ="truncpoiss")

countsummary(inperson_admb_ed_tp_risk_lag)
compare_nested(inperson_admb_ed_tp_risk_lag, inperson_admb_ed_tnb_risk_lag)

### Add multilevel

inperson_admb_ed_mtnb_risk <- update(inperson_admb_ed_tnb_risk, add_nom)

countsummary(inperson_admb_ed_mtnb_risk)

compare_nested(inperson_admb_ed_tnb_risk, inperson_admb_ed_mtnb_risk)

# multilevel poisson

inperson_admb_ed_mtp_risk <- update(inperson_admb_ed_tp_risk, add_nom)

countsummary(inperson_admb_ed_mtp_risk)

compare_nested(inperson_admb_ed_mtnb_risk, inperson_admb_ed_mtp_risk)

compare_nested(inperson_admb_ed_tp_risk, inperson_admb_ed_mtp_risk)

## add lag

inperson_admb_ed_mtnb_risk_lag <- update(inperson_admb_ed_mtnb_risk, add_inperson_lag)

countsummary(inperson_admb_ed_mtnb_risk_lag)

compare_nested(inperson_admb_ed_tnb_risk_lag, inperson_admb_ed_mtnb_risk_lag)

### Compare adding lag to risk

lrtest(inperson_admb_ed_mtnb_risk, inperson_admb_ed_mtnb_risk_lag)
compare_alphas(inperson_admb_ed_mtnb_risk, inperson_admb_ed_mtnb_risk_lag)

## Compare adding risk to lag

lrtest(inperson_admb_ed_mtnb_lag, inperson_admb_ed_mtnb_risk_lag)
compare_alphas(inperson_admb_ed_mtnb_lag, inperson_admb_ed_mtnb_risk_lag)

## m poisson risk lag

inperson_admb_ed_mtp_risk_lag <- update(inperson_admb_ed_mtnb_risk_lag,
                                family ="truncpoiss")

countsummary(inperson_admb_ed_mtp_risk_lag)
compare_nested(inperson_admb_ed_mtp_risk_lag, inperson_admb_ed_mtnb_risk_lag)


####### Test event dependence term using adjusted rate #######

inperson_admb_ed_tnb_adj_lag <- update(inperson_admb_ed_tnb_null, add_inperson_adj_lag)

countsummary(inperson_admb_ed_tnb_adj_lag)

compare_alphas(inperson_admb_ed_tnb_null, inperson_admb_ed_tnb_adj_lag)

compare_alphas(inperson_admb_ed_tnb_lag, inperson_admb_ed_tnb_adj_lag)

## Compare to poisson

inperson_admb_ed_tp_adj_lag <- update(inperson_admb_ed_tnb_adj_lag,
                           family = "truncpoiss")

countsummary(inperson_admb_ed_tp_adj_lag)

compare_nested(inperson_admb_ed_tp_adj_lag, inperson_admb_ed_tnb_adj_lag)

### Compare to multilevel

inperson_admb_ed_mtnb_adj_lag <- update(inperson_admb_ed_tnb_adj_lag, add_nom)

countsummary(inperson_admb_ed_mtnb_adj_lag)

compare_nested(inperson_admb_ed_tnb_adj_lag, inperson_admb_ed_mtnb_adj_lag)

compare_alphas(inperson_admb_ed_mtnb_lag, inperson_admb_ed_mtnb_adj_lag)
AICtab(inperson_admb_ed_mtnb_lag, inperson_admb_ed_mtnb_adj_lag)

### compare to multilevel poisson

inperson_admb_ed_mtp_adj_lag <- update(inperson_admb_ed_tp_adj_lag, add_nom)

countsummary(inperson_admb_ed_mtp_adj_lag)

compare_nested(inperson_admb_ed_mtp_adj_lag, inperson_admb_ed_mtnb_adj_lag)

compare_nested(inperson_admb_ed_tp_adj_lag, inperson_admb_ed_mtp_adj_lag)


### Add risk heterogeneity

inperson_admb_ed_tnb_risk <- update(inperson_admb_ed_tnb_null, add_risk)

countsummary(inperson_admb_ed_tnb_risk)

compare_alphas(inperson_admb_ed_tnb_null, inperson_admb_ed_tnb_risk)

# compare to poisson

inperson_admb_ed_tp_risk <- update(inperson_admb_ed_tnb_risk, family = "truncpoiss")

lrtest(inperson_admb_ed_tp_risk, inperson_admb_ed_tnb_risk)

### Add lag and compare

inperson_admb_ed_tnb_risk_adj_lag <- update(inperson_admb_ed_tnb_risk, add_inperson_adj_lag)

countsummary(inperson_admb_ed_tnb_risk_adj_lag)

compare_alphas(inperson_admb_ed_tnb_risk_lag, inperson_admb_ed_tnb_risk_adj_lag)
AICtab(inperson_admb_ed_tnb_risk_lag, inperson_admb_ed_tnb_risk_adj_lag)

### Compare adding lag to risk

lrtest(inperson_admb_ed_tnb_risk, inperson_admb_ed_tnb_risk_adj_lag)
compare_alphas(inperson_admb_ed_tnb_risk, inperson_admb_ed_tnb_risk_adj_lag)

## Compare adding risk to lag

lrtest(inperson_admb_ed_tnb_adj_lag, inperson_admb_ed_tnb_risk_adj_lag)
compare_alphas(inperson_admb_ed_tnb_adj_lag, inperson_admb_ed_tnb_risk_adj_lag)

## poisson risk lag

inperson_admb_ed_tp_risk_adj_lag <- update(inperson_admb_ed_tnb_risk_adj_lag,
                                family ="truncpoiss")

countsummary(inperson_admb_ed_tp_risk_adj_lag)
compare_nested(inperson_admb_ed_tp_risk_adj_lag, inperson_admb_ed_tnb_risk_adj_lag)

### Add multilevel

inperson_admb_ed_mtnb_risk <- update(inperson_admb_ed_tnb_risk, add_nom)

countsummary(inperson_admb_ed_mtnb_risk)

compare_nested(inperson_admb_ed_tnb_risk, inperson_admb_ed_mtnb_risk)

# multilevel poisson

inperson_admb_ed_mtp_risk <- update(inperson_admb_ed_tp_risk, add_nom)

countsummary(inperson_admb_ed_mtp_risk)

compare_nested(inperson_admb_ed_mtnb_risk, inperson_admb_ed_mtp_risk)

compare_nested(inperson_admb_ed_tp_risk, inperson_admb_ed_mtp_risk)

## add lag

inperson_admb_ed_mtnb_risk_adj_lag <- update(inperson_admb_ed_mtnb_risk, add_inperson_adj_lag)

countsummary(inperson_admb_ed_mtnb_risk_adj_lag)

compare_nested(inperson_admb_ed_tnb_risk_adj_lag, inperson_admb_ed_mtnb_risk_adj_lag)

compare_alphas(inperson_admb_ed_mtnb_risk_lag, inperson_admb_ed_mtnb_risk_adj_lag)
AICtab(inperson_admb_ed_mtnb_risk_lag, inperson_admb_ed_mtnb_risk_adj_lag)

### Compare adding lag to risk

lrtest(inperson_admb_ed_mtnb_risk, inperson_admb_ed_mtnb_risk_adj_lag)
compare_alphas(inperson_admb_ed_mtnb_risk, inperson_admb_ed_mtnb_risk_adj_lag)

## Compare adding risk to lag

lrtest(inperson_admb_ed_mtnb_adj_lag, inperson_admb_ed_mtnb_risk_adj_lag)
compare_alphas(inperson_admb_ed_mtnb_adj_lag, inperson_admb_ed_mtnb_risk_adj_lag)

## m poisson risk lag

inperson_admb_ed_mtp_risk_adj_lag <- update(inperson_admb_ed_mtnb_risk_adj_lag,
                                family ="truncpoiss")

countsummary(inperson_admb_ed_mtp_risk_adj_lag)
compare_nested(inperson_admb_ed_mtp_risk_adj_lag, inperson_admb_ed_mtnb_risk_adj_lag)

####### Test event dependence term using compliance cats #######

inperson_admb_ed_tnb_ext_comp <- update(inperson_admb_ed_tnb_null, add_inperson_comp)

countsummary(inperson_admb_ed_tnb_ext_comp)

compare_alphas(inperson_admb_ed_tnb_null, inperson_admb_ed_tnb_ext_comp)

compare_alphas(inperson_admb_ed_tnb_lag, inperson_admb_ed_tnb_ext_comp)

## Compare to poisson

inperson_admb_ed_tp_ext_comp <- update(inperson_admb_ed_tnb_ext_comp,
                           family = "truncpoiss")

countsummary(inperson_admb_ed_tp_ext_comp)

compare_nested(inperson_admb_ed_tp_ext_comp, inperson_admb_ed_tnb_ext_comp)

### Compare to multilevel

inperson_admb_ed_mtnb_ext_comp <- update(inperson_admb_ed_tnb_ext_comp, add_nom)

countsummary(inperson_admb_ed_mtnb_ext_comp)

compare_nested(inperson_admb_ed_tnb_ext_comp, inperson_admb_ed_mtnb_ext_comp)

compare_alphas(inperson_admb_ed_mtnb_lag, inperson_admb_ed_mtnb_ext_comp)
AICtab(inperson_admb_ed_mtnb_lag, inperson_admb_ed_mtnb_ext_comp)

### compare to multilevel poisson

inperson_admb_ed_mtp_ext_comp <- update(inperson_admb_ed_tp_ext_comp, add_nom)

countsummary(inperson_admb_ed_mtp_ext_comp)

compare_nested(inperson_admb_ed_mtp_ext_comp, inperson_admb_ed_mtnb_ext_comp)

compare_nested(inperson_admb_ed_tp_ext_comp, inperson_admb_ed_mtp_ext_comp)


### Add risk heterogeneity

inperson_admb_ed_tnb_risk <- update(inperson_admb_ed_tnb_null, add_risk)

countsummary(inperson_admb_ed_tnb_risk)

compare_alphas(inperson_admb_ed_tnb_null, inperson_admb_ed_tnb_risk)

# compare to poisson

inperson_admb_ed_tp_risk <- update(inperson_admb_ed_tnb_risk, family = "truncpoiss")

lrtest(inperson_admb_ed_tp_risk, inperson_admb_ed_tnb_risk)

### Add lag and compare

inperson_admb_ed_tnb_risk_ext_comp <- update(inperson_admb_ed_tnb_risk, add_inperson_comp)

countsummary(inperson_admb_ed_tnb_risk_ext_comp)

compare_alphas(inperson_admb_ed_tnb_risk_lag, inperson_admb_ed_tnb_risk_ext_comp)
AICtab(inperson_admb_ed_tnb_risk_lag, inperson_admb_ed_tnb_risk_ext_comp)

### Compare adding lag to risk

lrtest(inperson_admb_ed_tnb_risk, inperson_admb_ed_tnb_risk_ext_comp)
compare_alphas(inperson_admb_ed_tnb_risk, inperson_admb_ed_tnb_risk_ext_comp)

## Compare adding risk to lag

lrtest(inperson_admb_ed_tnb_ext_comp, inperson_admb_ed_tnb_risk_ext_comp)
compare_alphas(inperson_admb_ed_tnb_ext_comp, inperson_admb_ed_tnb_risk_ext_comp)

## poisson risk lag

inperson_admb_ed_tp_risk_ext_comp <- update(inperson_admb_ed_tnb_risk_ext_comp,
                                family ="truncpoiss")

countsummary(inperson_admb_ed_tp_risk_ext_comp)
compare_nested(inperson_admb_ed_tp_risk_ext_comp, inperson_admb_ed_tnb_risk_ext_comp)

### Add multilevel

inperson_admb_ed_mtnb_risk <- update(inperson_admb_ed_tnb_risk, add_nom)

countsummary(inperson_admb_ed_mtnb_risk)

compare_nested(inperson_admb_ed_tnb_risk, inperson_admb_ed_mtnb_risk)

# multilevel poisson

inperson_admb_ed_mtp_risk <- update(inperson_admb_ed_tp_risk, add_nom)

countsummary(inperson_admb_ed_mtp_risk)

compare_nested(inperson_admb_ed_mtnb_risk, inperson_admb_ed_mtp_risk)

compare_nested(inperson_admb_ed_tp_risk, inperson_admb_ed_mtp_risk)

## add lag

inperson_admb_ed_mtnb_risk_ext_comp <- update(inperson_admb_ed_mtnb_risk, add_inperson_comp)

countsummary(inperson_admb_ed_mtnb_risk_ext_comp)

compare_nested(inperson_admb_ed_tnb_risk_ext_comp, inperson_admb_ed_mtnb_risk_ext_comp)

compare_alphas(inperson_admb_ed_mtnb_risk_lag, inperson_admb_ed_mtnb_risk_ext_comp)
AICtab(inperson_admb_ed_mtnb_risk_lag, inperson_admb_ed_mtnb_risk_ext_comp)

### Compare adding lag to risk

lrtest(inperson_admb_ed_mtnb_risk, inperson_admb_ed_mtnb_risk_ext_comp)
compare_alphas(inperson_admb_ed_mtnb_risk, inperson_admb_ed_mtnb_risk_ext_comp)

## Compare adding risk to lag

lrtest(inperson_admb_ed_mtnb_ext_comp, inperson_admb_ed_mtnb_risk_ext_comp)
compare_alphas(inperson_admb_ed_mtnb_ext_comp, inperson_admb_ed_mtnb_risk_ext_comp)

## m poisson risk lag

inperson_admb_ed_mtp_risk_ext_comp <- update(inperson_admb_ed_mtnb_risk_ext_comp,
                                family ="truncpoiss")

countsummary(inperson_admb_ed_mtp_risk_ext_comp)
compare_nested(inperson_admb_ed_mtp_risk_ext_comp, inperson_admb_ed_mtnb_risk_ext_comp)

####### Test event dependence term using binary lag #######

inperson_admb_ed_tnb_ext_binlag <- update(inperson_admb_ed_tnb_null, add_inperson_binlag)

countsummary(inperson_admb_ed_tnb_ext_binlag)

compare_alphas(inperson_admb_ed_tnb_null, inperson_admb_ed_tnb_ext_binlag)

compare_alphas(inperson_admb_ed_tnb_lag, inperson_admb_ed_tnb_ext_binlag)

## Compare to poisson

inperson_admb_ed_tp_ext_binlag <- update(inperson_admb_ed_tnb_ext_binlag,
                           family = "truncpoiss")

countsummary(inperson_admb_ed_tp_ext_binlag)

compare_nested(inperson_admb_ed_tp_ext_binlag, inperson_admb_ed_tnb_ext_binlag)

### Compare to multilevel

inperson_admb_ed_mtnb_ext_binlag <- update(inperson_admb_ed_tnb_ext_binlag, add_nom)

countsummary(inperson_admb_ed_mtnb_ext_binlag)

compare_nested(inperson_admb_ed_tnb_ext_binlag, inperson_admb_ed_mtnb_ext_binlag)

compare_alphas(inperson_admb_ed_mtnb_lag, inperson_admb_ed_mtnb_ext_binlag)
AICtab(inperson_admb_ed_mtnb_lag, inperson_admb_ed_mtnb_ext_binlag)

### compare to multilevel poisson

inperson_admb_ed_mtp_ext_binlag <- update(inperson_admb_ed_tp_ext_binlag, add_nom)

countsummary(inperson_admb_ed_mtp_ext_binlag)

compare_nested(inperson_admb_ed_mtp_ext_binlag, inperson_admb_ed_mtnb_ext_binlag)

compare_nested(inperson_admb_ed_tp_ext_binlag, inperson_admb_ed_mtp_ext_binlag)


### Add risk heterogeneity

inperson_admb_ed_tnb_risk <- update(inperson_admb_ed_tnb_null, add_risk)

countsummary(inperson_admb_ed_tnb_risk)

compare_alphas(inperson_admb_ed_tnb_null, inperson_admb_ed_tnb_risk)

# compare to poisson

inperson_admb_ed_tp_risk <- update(inperson_admb_ed_tnb_risk, family = "truncpoiss")

lrtest(inperson_admb_ed_tp_risk, inperson_admb_ed_tnb_risk)

### Add lag and compare

inperson_admb_ed_tnb_risk_ext_binlag <- update(inperson_admb_ed_tnb_risk, add_inperson_binlag)

countsummary(inperson_admb_ed_tnb_risk_ext_binlag)

compare_alphas(inperson_admb_ed_tnb_risk_lag, inperson_admb_ed_tnb_risk_ext_binlag)
AICtab(inperson_admb_ed_tnb_risk_lag, inperson_admb_ed_tnb_risk_ext_binlag)

### Compare adding lag to risk

lrtest(inperson_admb_ed_tnb_risk, inperson_admb_ed_tnb_risk_ext_binlag)
compare_alphas(inperson_admb_ed_tnb_risk, inperson_admb_ed_tnb_risk_ext_binlag)

## Compare adding risk to lag

lrtest(inperson_admb_ed_tnb_ext_binlag, inperson_admb_ed_tnb_risk_ext_binlag)
compare_alphas(inperson_admb_ed_tnb_ext_binlag, inperson_admb_ed_tnb_risk_ext_binlag)

## poisson risk lag

inperson_admb_ed_tp_risk_ext_binlag <- update(inperson_admb_ed_tnb_risk_ext_binlag,
                                family ="truncpoiss")

countsummary(inperson_admb_ed_tp_risk_ext_binlag)
compare_nested(inperson_admb_ed_tp_risk_ext_binlag, inperson_admb_ed_tnb_risk_ext_binlag)

### Add multilevel

inperson_admb_ed_mtnb_risk <- update(inperson_admb_ed_tnb_risk, add_nom)

countsummary(inperson_admb_ed_mtnb_risk)

compare_nested(inperson_admb_ed_tnb_risk, inperson_admb_ed_mtnb_risk)

# multilevel poisson

inperson_admb_ed_mtp_risk <- update(inperson_admb_ed_tp_risk, add_nom)

countsummary(inperson_admb_ed_mtp_risk)

compare_nested(inperson_admb_ed_mtnb_risk, inperson_admb_ed_mtp_risk)

compare_nested(inperson_admb_ed_tp_risk, inperson_admb_ed_mtp_risk)

## add lag

inperson_admb_ed_mtnb_risk_ext_binlag <- update(inperson_admb_ed_mtnb_risk, add_inperson_binlag)

countsummary(inperson_admb_ed_mtnb_risk_ext_binlag)

compare_nested(inperson_admb_ed_tnb_risk_ext_binlag, inperson_admb_ed_mtnb_risk_ext_binlag)

compare_alphas(inperson_admb_ed_mtnb_risk_lag, inperson_admb_ed_mtnb_risk_ext_binlag)
AICtab(inperson_admb_ed_mtnb_risk_lag, inperson_admb_ed_mtnb_risk_ext_binlag)

### Compare adding lag to risk

lrtest(inperson_admb_ed_mtnb_risk, inperson_admb_ed_mtnb_risk_ext_binlag)
compare_alphas(inperson_admb_ed_mtnb_risk, inperson_admb_ed_mtnb_risk_ext_binlag)

## Compare adding risk to lag

lrtest(inperson_admb_ed_mtnb_ext_binlag, inperson_admb_ed_mtnb_risk_ext_binlag)
compare_alphas(inperson_admb_ed_mtnb_ext_binlag, inperson_admb_ed_mtnb_risk_ext_binlag)

## m poisson risk lag

inperson_admb_ed_mtp_risk_ext_binlag <- update(inperson_admb_ed_mtnb_risk_ext_binlag,
                                family ="truncpoiss")

countsummary(inperson_admb_ed_mtp_risk_ext_binlag)
compare_nested(inperson_admb_ed_mtp_risk_ext_binlag, inperson_admb_ed_mtnb_risk_ext_binlag)



```





# Benchmark stats

```{r timing, cache=FALSE}
endtime <- proc.time()
time <- endtime - starttime
time

print(paste("the script took", round(time[3]/60,2),
              "minutes to run.", sep=" "))
```

# References
